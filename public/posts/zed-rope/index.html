<!doctype html>

































<html
  class="not-ready lg:text-base"
  style="--bg: #faf8f1"
  lang="en-us"
  dir="ltr"
>
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, shrink-to-fit=no"
  />

  
  <title>Zed 编辑器中的 SumTree 和 Rope 数据结构 - greathongtu 的 Blog</title>

  
  <meta name="theme-color" />

  
  
  
  
  <meta name="description" content="代码编辑器最重要的组成部分之一就是如何高效地表示和操作文本。最朴素的想法是直接使用 string 数据结构。但作为使用连续内存的数据结构,string 在面对中间位置的数据插入删除时代价过大。并且更复杂的功能,如跳转到某行,也很难高效实现。
一个合理的实现应该能将文本分成很多段,且段与段之间互不影响,这样对其中某些部分进行修改也不会有很大的影响。Zed 编辑器选择的是 Rope 这种数据结构。
Rope 和 SumTree 概述
在 Zed 的具体实现中,Rope 是对底层 SumTree 的一层包装。而 SumTree 可以理解为一种特殊的 B&#43; 树,其中数据都存储在叶子节点。这种结构使得对某些叶子节点的修改并不会影响其他大多数的节点。通过使用 SumTree,也可以很容易地实现并发访问等功能。
struct Rope {
    chunks: SumTree&lt;Chunk&gt;,
}

struct Chunk(ArrayString&lt;{ 2 * CHUNK_BASE }&gt;);
这里 SumTree 的范型参数为 Chunk，也就是叶子节点存放的数据是 Chunk 类型 (ArrayString 来自 arrayvec 库，是存放在栈里的固定大小的 string)。这里我们首先来看 SumTree 的结构。
SumTree 的结构
struct SumTree&lt;T: Item&gt;(pub Arc&lt;Node&lt;T&gt;&gt;);

enum Node&lt;T: Item&gt; {
    Internal {
        height: u8,
        summary: T::Summary,
        child_summaries: ArrayVec&lt;T::Summary, { 2 * TREE_BASE }&gt;,
        child_trees: ArrayVec&lt;SumTree&lt;T&gt;, { 2 * TREE_BASE }&gt;,
    },
    Leaf {
        summary: T::Summary,
        items: ArrayVec&lt;T, { 2 * TREE_BASE }&gt;,
        item_summaries: ArrayVec&lt;T::Summary, { 2 * TREE_BASE }&gt;,
    },
}
SumTree 是一棵 B&#43; 树,其中:" />
  <meta name="author" content="greathongtu 的 Blog" />
  

  
  
  
  
  
  
  <link rel="preload stylesheet" as="style" href="http://localhost:1313/main.min.css" />

  
  
  
  
  
  <link rel="preload" as="image" href="http://localhost:1313/theme.png" />

  
  
  
  
  

  
  
  <link rel="preload" as="image" href="http://localhost:1313/github.svg" />
  
  

  
  
  <script
    defer
    src="http://localhost:1313/highlight.min.js"
    onload="hljs.initHighlightingOnLoad();"
  ></script>
  

  
  
  

  
  <link
    rel="icon"
    href="http://localhost:1313/favicon.ico"
  />
  <link
    rel="apple-touch-icon"
    href="http://localhost:1313/apple-touch-icon.png"
  />

  
  <meta name="generator" content="Hugo 0.145.0">

  
  
  
</head>

  <body class="text-black duration-200 ease-out dark:text-white">
    <header class="mx-auto flex h-[4.5rem] max-w-[--w] px-8 lg:justify-center">
  <div class="relative z-50 ltr:mr-auto rtl:ml-auto flex items-center">
    <a class="-translate-y-[1px] text-2xl font-medium" href="http://localhost:1313/"
      >greathongtu 的 Blog</a
    >
    <div
      class="btn-dark text-[0] ltr:ml-4 rtl:mr-4 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.png)_left_center/_auto_theme('spacing.6')_no-repeat] [transition:_background-position_0.4s_steps(5)] dark:[background-position:right]"
      role="button"
      aria-label="Dark"
    ></div>
  </div>

  <div
    class="btn-menu relative z-50 ltr:-mr-8 rtl:-ml-8 flex h-[4.5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden"
    role="button"
    aria-label="Menu"
  ></div>

  

  <script>
    
    const htmlClass = document.documentElement.classList;
    setTimeout(() => {
      htmlClass.remove('not-ready');
    }, 10);

    
    const btnMenu = document.querySelector('.btn-menu');
    btnMenu.addEventListener('click', () => {
      htmlClass.toggle('open');
    });

    
    const metaTheme = document.querySelector('meta[name="theme-color"]');
    const lightBg = '#faf8f1'.replace(/"/g, '');
    const setDark = (isDark) => {
      metaTheme.setAttribute('content', isDark ? '#000' : lightBg);
      htmlClass[isDark ? 'add' : 'remove']('dark');
      localStorage.setItem('dark', isDark);
    };

    
    const darkScheme = window.matchMedia('(prefers-color-scheme: dark)');
    if (htmlClass.contains('dark')) {
      setDark(true);
    } else {
      const darkVal = localStorage.getItem('dark');
      setDark(darkVal ? darkVal === 'true' : darkScheme.matches);
    }

    
    darkScheme.addEventListener('change', (event) => {
      setDark(event.matches);
    });

    
    const btnDark = document.querySelector('.btn-dark');
    btnDark.addEventListener('click', () => {
      setDark(localStorage.getItem('dark') !== 'true');
    });
  </script>

  <div
    class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full select-none flex-col justify-center pb-16 duration-200 dark:bg-black lg:static lg:h-auto lg:flex-row lg:!bg-transparent lg:pb-0 lg:transition-none"
  >
    
    

    
    <nav
      class="mt-12 flex justify-center space-x-10 rtl:space-x-reverse dark:invert ltr:lg:ml-14 rtl:lg:mr-14 lg:mt-0 lg:items-center"
    >
      
      <a
        class="h-7 w-7 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./github.svg)"
        href="https://github.com/greathongtu"
        target="_blank"
        rel="me"
      >
        github
      </a>
      
    </nav>
    
  </div>
</header>


    <main
      class="prose prose-neutral relative mx-auto min-h-[calc(100%-9rem)] max-w-[--w] px-8 pb-16 pt-14 dark:prose-invert"
    >
      

<article>
  <header class="mb-14">
    <h1 class="!my-0 pb-2.5">Zed 编辑器中的 SumTree 和 Rope 数据结构</h1>

    
    <div class="text-xs antialiased opacity-60">
      
      <time>Sep 6, 2024</time>
      
      
      
      
    </div>
    
  </header>

  <section><p>代码编辑器最重要的组成部分之一就是如何高效地表示和操作文本。最朴素的想法是直接使用 string 数据结构。但作为使用连续内存的数据结构,string 在面对中间位置的数据插入删除时代价过大。并且更复杂的功能,如跳转到某行,也很难高效实现。</p>
<p>一个合理的实现应该能将文本分成很多段,且段与段之间互不影响,这样对其中某些部分进行修改也不会有很大的影响。Zed 编辑器选择的是 Rope 这种数据结构。</p>
<h2 id="rope-和-sumtree-概述">Rope 和 SumTree 概述</h2>
<p>在 Zed 的具体实现中,Rope 是对底层 SumTree 的一层包装。而 SumTree 可以理解为一种特殊的 B+ 树,其中数据都存储在叶子节点。这种结构使得对某些叶子节点的修改并不会影响其他大多数的节点。通过使用 SumTree,也可以很容易地实现并发访问等功能。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Rope</span> {
</span></span><span style="display:flex;"><span>    chunks: <span style="color:#a6e22e">SumTree</span><span style="color:#f92672">&lt;</span>Chunk<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Chunk</span>(ArrayString<span style="color:#f92672">&lt;</span>{ <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">CHUNK_BASE</span> }<span style="color:#f92672">&gt;</span>);
</span></span></code></pre></div><p>这里 SumTree 的范型参数为 Chunk，也就是叶子节点存放的数据是 Chunk 类型 (ArrayString 来自 arrayvec 库，是存放在栈里的固定大小的 string)。这里我们首先来看 SumTree 的结构。</p>
<h2 id="sumtree-的结构">SumTree 的结构</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">SumTree</span><span style="color:#f92672">&lt;</span>T: <span style="color:#a6e22e">Item</span><span style="color:#f92672">&gt;</span>(<span style="color:#66d9ef">pub</span> Arc<span style="color:#f92672">&lt;</span>Node<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;&gt;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">enum</span> <span style="color:#a6e22e">Node</span><span style="color:#f92672">&lt;</span>T: <span style="color:#a6e22e">Item</span><span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    Internal {
</span></span><span style="display:flex;"><span>        height: <span style="color:#66d9ef">u8</span>,
</span></span><span style="display:flex;"><span>        summary: <span style="color:#a6e22e">T</span>::Summary,
</span></span><span style="display:flex;"><span>        child_summaries: <span style="color:#a6e22e">ArrayVec</span><span style="color:#f92672">&lt;</span>T::Summary, { <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">TREE_BASE</span> }<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>        child_trees: <span style="color:#a6e22e">ArrayVec</span><span style="color:#f92672">&lt;</span>SumTree<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span>, { <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">TREE_BASE</span> }<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    Leaf {
</span></span><span style="display:flex;"><span>        summary: <span style="color:#a6e22e">T</span>::Summary,
</span></span><span style="display:flex;"><span>        items: <span style="color:#a6e22e">ArrayVec</span><span style="color:#f92672">&lt;</span>T, { <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">TREE_BASE</span> }<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>        item_summaries: <span style="color:#a6e22e">ArrayVec</span><span style="color:#f92672">&lt;</span>T::Summary, { <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">TREE_BASE</span> }<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>SumTree<!-- raw HTML omitted --> 是一棵 B+ 树,其中:</p>
<ul>
<li>每个叶节点包含多个 Item 类型的数据和对应每个 Item 的 Summary</li>
<li>Leaf 的 summary 字段存放着所有 Item 的总 Summary</li>
<li>Internal 节点包含多个子树和对应每个子树的 Summary</li>
<li>Internal 节点的 summary 字段存放着所有子树的总 Summary</li>
<li>height 表示该 Internal 节点的高度(叶子节点高度为0)</li>
</ul>
<h2 id="item-和-summary">Item 和 Summary</h2>
<p>Item 是什么呢？Item 是存放在叶子节点的数据的真正类型（比如整个文本的一小段子串 &amp;str）。它需要实现 summary 方法返回一个 Summary 类型。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">trait</span> Item: Clone {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Summary</span>: <span style="color:#a6e22e">Summary</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">summary</span>(<span style="color:#f92672">&amp;</span>self) -&gt; <span style="color:#a6e22e">Self</span>::Summary;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">trait</span> Summary: Default <span style="color:#f92672">+</span> Clone <span style="color:#f92672">+</span> fmt::Debug {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Context</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">add_summary</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, summary: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">Self</span>, cx: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">Self</span>::Context);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Summary 类型可以是一切可累加的(associative）东西。听起来很抽象，但只要知道 Summary 是用来统计整个文本或其中部分文本的一些统计信息的。</p>
<p>比如：如果我想知道整个文本的长度是多少，那我需要知道每个叶子节点的数据长度是多少，最后累加得到最终的结果。
我们可以将这个长度信息通过 Summary 一层一层地传上去不断累加，最终在根节点的 summary 字段即是我们需要的结果。
具体实现上，我们可以给 usize 实现 Summary trait，具体 add_summary 的方法便是直接对两个 usize 相加。</p>
<p>再比如我想知道一个 string 中最大的 char 是哪个？把 add_summary 的方法实现为返回更大的那个 char 即可。</p>
<p>实际中我们会有很多维度的信息需要统计，这时我们可以把这些维度放到一个 struct 中，在 add_summary 方法里对该 struct 的各个字段进行相应的修改即可。</p>
<h2 id="textsummary-示例">TextSummary 示例</h2>
<p>Zed 的 Rope 中的 Summary 是这样的：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">TextSummary</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Length in UTF-8
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    len: <span style="color:#66d9ef">usize</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Length in UTF-16 code units
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    len_utf16: <span style="color:#a6e22e">OffsetUtf16</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// A point representing the number of lines and the length of the last line
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    lines: <span style="color:#a6e22e">Point</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// How many `char`s are in the first line
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    first_line_chars: <span style="color:#66d9ef">u32</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// How many `char`s are in the last line
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    last_line_chars: <span style="color:#66d9ef">u32</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// How many UTF-16 code units are in the last line
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    last_line_len_utf16: <span style="color:#66d9ef">u32</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// The row idx of the longest row
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    longest_row: <span style="color:#66d9ef">u32</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// How many `char`s are in the longest row
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    longest_row_chars: <span style="color:#66d9ef">u32</span>,
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>它是如何实现 Summary trait 的呢：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">impl</span> sum_tree::Summary <span style="color:#66d9ef">for</span> TextSummary {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Context</span> <span style="color:#f92672">=</span> ();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">add_summary</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, summary: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">Self</span>, _: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">Self</span>::Context) {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">*</span>self <span style="color:#f92672">+=</span> summary;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span> std::ops::Add<span style="color:#f92672">&lt;</span>Self<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">for</span> TextSummary {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Output</span> <span style="color:#f92672">=</span> Self;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">add</span>(<span style="color:#66d9ef">mut</span> self, rhs: <span style="color:#a6e22e">Self</span>) -&gt; <span style="color:#a6e22e">Self</span>::Output {
</span></span><span style="display:flex;"><span>        AddAssign::add_assign(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, <span style="color:#f92672">&amp;</span>rhs);
</span></span><span style="display:flex;"><span>        self
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span><span style="color:#f92672">&gt;</span> std::ops::AddAssign<span style="color:#f92672">&lt;&amp;</span><span style="color:#a6e22e">&#39;a</span> Self<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">for</span> TextSummary {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">add_assign</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, other: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">&#39;a</span> <span style="color:#a6e22e">Self</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> joined_chars <span style="color:#f92672">=</span> self.last_line_chars <span style="color:#f92672">+</span> other.first_line_chars;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> joined_chars <span style="color:#f92672">&gt;</span> self.longest_row_chars {
</span></span><span style="display:flex;"><span>            self.longest_row <span style="color:#f92672">=</span> self.lines.row;
</span></span><span style="display:flex;"><span>            self.longest_row_chars <span style="color:#f92672">=</span> joined_chars;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> other.longest_row_chars <span style="color:#f92672">&gt;</span> self.longest_row_chars {
</span></span><span style="display:flex;"><span>            self.longest_row <span style="color:#f92672">=</span> self.lines.row <span style="color:#f92672">+</span> other.longest_row;
</span></span><span style="display:flex;"><span>            self.longest_row_chars <span style="color:#f92672">=</span> other.longest_row_chars;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self.lines.row <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>            self.first_line_chars <span style="color:#f92672">+=</span> other.first_line_chars;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> other.lines.row <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>            self.last_line_chars <span style="color:#f92672">+=</span> other.first_line_chars;
</span></span><span style="display:flex;"><span>            self.last_line_len_utf16 <span style="color:#f92672">+=</span> other.last_line_len_utf16;
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            self.last_line_chars <span style="color:#f92672">=</span> other.last_line_chars;
</span></span><span style="display:flex;"><span>            self.last_line_len_utf16 <span style="color:#f92672">=</span> other.last_line_len_utf16;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self.len <span style="color:#f92672">+=</span> other.len;
</span></span><span style="display:flex;"><span>        self.len_utf16 <span style="color:#f92672">+=</span> other.len_utf16;
</span></span><span style="display:flex;"><span>        self.lines <span style="color:#f92672">+=</span> other.lines;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>其中之所以需要 first_line_chars 和 last_line_chars 这两个字段，是为了统计 longest_row_chars，而同一行的内容有可能被存放在前后两个不同的节点中。</p>
<p>这里举例说明 SumTree 的结构，以下是一段文本：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Hello World!
</span></span><span style="display:flex;"><span>This is
</span></span><span style="display:flex;"><span>your captain speaking.
</span></span><span style="display:flex;"><span>Are you
</span></span><span style="display:flex;"><span>ready for take-off?
</span></span></code></pre></div><p>根据刚才的文本构建的 SumTree 如下：
<img src="/images/sumtree_diagram.png" alt="SumTree"></p>
<h2 id="dimension-和-seektarget">Dimension 和 SeekTarget</h2>
<p>有了对 SumTree 大概的理解，我们就可以深入代码研究了。在代码中我们可以发现另两个关键的 trait：Demension 和 SeekTarget。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#e6db74">/// Each [`Summary`] type can have more than one [`Dimension`] type that it measures.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/// You can use dimensions to seek to a specific location in the [`SumTree`]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/// # Example:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/// Zed&#39;s rope has a `TextSummary` type that summarizes lines, characters, and bytes.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/// Each of these are different dimensions we may want to seek to
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">trait</span> Dimension<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, S: <span style="color:#a6e22e">Summary</span><span style="color:#f92672">&gt;</span>: Clone <span style="color:#f92672">+</span> fmt::Debug <span style="color:#f92672">+</span> Default {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">add_summary</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, _summary: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">&#39;a</span> <span style="color:#a6e22e">S</span>, _: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">S</span>::Context);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">from_summary</span>(summary: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">&#39;a</span> <span style="color:#a6e22e">S</span>, cx: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">S</span>::Context) -&gt; <span style="color:#a6e22e">Self</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> dimension <span style="color:#f92672">=</span> Self::default();
</span></span><span style="display:flex;"><span>        dimension.add_summary(summary, cx);
</span></span><span style="display:flex;"><span>        dimension
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">trait</span> SeekTarget<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, S: <span style="color:#a6e22e">Summary</span>, D: <span style="color:#a6e22e">Dimension</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, S<span style="color:#f92672">&gt;&gt;</span>: <span style="color:#a6e22e">fmt</span>::Debug {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">cmp</span>(<span style="color:#f92672">&amp;</span>self, cursor_location: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">D</span>, cx: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">S</span>::Context) -&gt; <span style="color:#a6e22e">Ordering</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Dimension 是 Summary 的一个维度， SeekTarget 定义了 SumTree 的查找目标。
你可能会问为什么有了 Summary 还需要 Dimension, 这是因为 Summary 存放的是全量的统计信息，而有时候我们只想关注其中的某个维度。
比如在 TextSummary 中，我们可能只关心最长行的字符数而不关心总长度；或者相反。在这种情况下如果我们直接使用 Summary 的 Cursor 遍历会导致性能浪费，
因为在遍历的过程中做了多余的计算，并且过程中累加的 Summary（或者某 Dimension）会被存在 Cursor 的 stack 字段（记录了从根节点到当前叶节点的路径）中，而我们只需要关心其中的一部分信息。</p>
<p>我们可以使用针对某个 Dimension 的 Cursor 来遍历 SumTree，这样就可以得到一个 Dimension 的统计信息而不会有多余的计算。
那么如果我想通过一个 Dimension 的遍历找到某个位置，同时又想得到另一个 Dimension 的信息怎么办呢？</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">// Summary is a Dimension
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">impl</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T: <span style="color:#a6e22e">Summary</span><span style="color:#f92672">&gt;</span> Dimension<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">for</span> T {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">add_summary</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, summary: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">&#39;a</span> <span style="color:#a6e22e">T</span>, cx: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">T</span>::Context) {
</span></span><span style="display:flex;"><span>        Summary::add_summary(self, summary, cx);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Demension is a Target
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">impl</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, S: <span style="color:#a6e22e">Summary</span>, D: <span style="color:#a6e22e">Dimension</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, S<span style="color:#f92672">&gt;</span> <span style="color:#f92672">+</span> Ord<span style="color:#f92672">&gt;</span> SeekTarget<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, S, D<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">for</span> D {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">cmp</span>(<span style="color:#f92672">&amp;</span>self, cursor_location: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">Self</span>, _: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">S</span>::Context) -&gt; <span style="color:#a6e22e">Ordering</span> {
</span></span><span style="display:flex;"><span>        Ord::cmp(self, cursor_location)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T: <span style="color:#a6e22e">Summary</span>, D1: <span style="color:#a6e22e">Dimension</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T<span style="color:#f92672">&gt;</span>, D2: <span style="color:#a6e22e">Dimension</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T<span style="color:#f92672">&gt;&gt;</span> Dimension<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">for</span> (D1, D2) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">add_summary</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, summary: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">&#39;a</span> <span style="color:#a6e22e">T</span>, cx: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">T</span>::Context) {
</span></span><span style="display:flex;"><span>        self.<span style="color:#ae81ff">0.</span>add_summary(summary, cx);
</span></span><span style="display:flex;"><span>        self.<span style="color:#ae81ff">1.</span>add_summary(summary, cx);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>可以看到我们为 (D1, D2) 的 tuple 实现了 Dimension trait，在这个泛型参数为 (D1, D2) 的 Cursor 的遍历过程中我们同时统计了 D1 和 D2 的信息。</p>
<p>简单总结一下，对于一颗 SumTree，他有一种 Item 类型，这个 Item 类型对应一个 Summary 类型。
在使用 Cursor 遍历 SumTree 时，可以通过指定一个 Summary 的子集类型来遍历去聚集，这个子集就是 Dimension。
Cursor 可以通过 SeekTarget 来定位到某个位置，SeekTarget 也可以是一个 Dimension（至少是可以和 Dimension 进行比较）。</p>
<h2 id="cursor-sumtree-的遍历器">Cursor: SumTree 的遍历器</h2>
<p>上面我们提到了 Cursor，这里我们深入研究以下 Cursor 的结构。Cursor 用于遍历 SumTree，它的结构如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">#[derive(Clone)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Cursor</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T: <span style="color:#a6e22e">Item</span>, D<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// root of SumTree
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    tree: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">&#39;a</span> <span style="color:#a6e22e">SumTree</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// stack of nodes from root to current node
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    stack: <span style="color:#a6e22e">ArrayVec</span><span style="color:#f92672">&lt;</span>StackEntry<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T, D<span style="color:#f92672">&gt;</span>, <span style="color:#ae81ff">16</span><span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// D is what dimension this Cursor is currently seeking
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// position stores the total value of D from the beginning
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    position: <span style="color:#a6e22e">D</span>,
</span></span><span style="display:flex;"><span>    did_seek: <span style="color:#66d9ef">bool</span>,
</span></span><span style="display:flex;"><span>    at_end: <span style="color:#66d9ef">bool</span>,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#[derive(Clone)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">StackEntry</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T: <span style="color:#a6e22e">Item</span>, D<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// curr node
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    tree: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">&#39;a</span> <span style="color:#a6e22e">SumTree</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// index of next child to visit
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    index: <span style="color:#66d9ef">usize</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// D value of this node
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    position: <span style="color:#a6e22e">D</span>,
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Cursor 允许我们高效地在 SumTree 中导航和查找,同时只计算我们关心的维度的统计信息。
以下是代码解读：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">// cursor.rs
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">use</span> <span style="color:#66d9ef">super</span>::<span style="color:#f92672">*</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> arrayvec::ArrayVec;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> std::{cmp::Ordering, mem, sync::Arc};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#[derive(Clone)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">StackEntry</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T: <span style="color:#a6e22e">Item</span>, D<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    tree: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">&#39;a</span> <span style="color:#a6e22e">SumTree</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    index: <span style="color:#66d9ef">usize</span>,
</span></span><span style="display:flex;"><span>    position: <span style="color:#a6e22e">D</span>,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#[derive(Clone)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Cursor</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T: <span style="color:#a6e22e">Item</span>, D<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    tree: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">&#39;a</span> <span style="color:#a6e22e">SumTree</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    stack: <span style="color:#a6e22e">ArrayVec</span><span style="color:#f92672">&lt;</span>StackEntry<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T, D<span style="color:#f92672">&gt;</span>, <span style="color:#ae81ff">16</span><span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    position: <span style="color:#a6e22e">D</span>,
</span></span><span style="display:flex;"><span>    did_seek: <span style="color:#66d9ef">bool</span>,
</span></span><span style="display:flex;"><span>    at_end: <span style="color:#66d9ef">bool</span>,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Iter</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T: <span style="color:#a6e22e">Item</span><span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    tree: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">&#39;a</span> <span style="color:#a6e22e">SumTree</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    stack: <span style="color:#a6e22e">ArrayVec</span><span style="color:#f92672">&lt;</span>StackEntry<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T, ()<span style="color:#f92672">&gt;</span>, <span style="color:#ae81ff">16</span><span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T, D<span style="color:#f92672">&gt;</span> Cursor<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T, D<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span>
</span></span><span style="display:flex;"><span>    T: <span style="color:#a6e22e">Item</span>,
</span></span><span style="display:flex;"><span>    D: <span style="color:#a6e22e">Dimension</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T::Summary<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">new</span>(tree: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">&#39;a</span> <span style="color:#a6e22e">SumTree</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span>) -&gt; <span style="color:#a6e22e">Self</span> {
</span></span><span style="display:flex;"><span>        Self {
</span></span><span style="display:flex;"><span>            tree,
</span></span><span style="display:flex;"><span>            stack: <span style="color:#a6e22e">ArrayVec</span>::new(),
</span></span><span style="display:flex;"><span>            position: <span style="color:#a6e22e">D</span>::default(),
</span></span><span style="display:flex;"><span>            did_seek: <span style="color:#a6e22e">false</span>,
</span></span><span style="display:flex;"><span>            at_end: <span style="color:#a6e22e">tree</span>.is_empty(),
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">reset</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self) {
</span></span><span style="display:flex;"><span>        self.did_seek <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>        self.at_end <span style="color:#f92672">=</span> self.tree.is_empty();
</span></span><span style="display:flex;"><span>        self.stack.truncate(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>        self.position <span style="color:#f92672">=</span> D::default();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// position excluding the current item
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">start</span>(<span style="color:#f92672">&amp;</span>self) -&gt; <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">D</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&amp;</span>self.position
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// get total summary until leaf item
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">#[track_caller]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">end</span>(<span style="color:#f92672">&amp;</span>self, cx: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&lt;</span>T::Summary <span style="color:#66d9ef">as</span> Summary<span style="color:#f92672">&gt;</span>::Context) -&gt; <span style="color:#a6e22e">D</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Some(item_summary) <span style="color:#f92672">=</span> self.item_summary() {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> end <span style="color:#f92672">=</span> self.start().clone();
</span></span><span style="display:flex;"><span>            end.add_summary(item_summary, cx);
</span></span><span style="display:flex;"><span>            end
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            self.start().clone()
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// item pointed to by curr leaf
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">#[track_caller]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">item</span>(<span style="color:#f92672">&amp;</span>self) -&gt; Option<span style="color:#f92672">&lt;&amp;</span><span style="color:#a6e22e">&#39;a</span> T<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>        self.assert_did_seek();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Some(entry) <span style="color:#f92672">=</span> self.stack.last() {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">match</span> <span style="color:#f92672">*</span>entry.tree.<span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>                Node::Leaf { <span style="color:#66d9ef">ref</span> items, <span style="color:#f92672">..</span> } <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> entry.index <span style="color:#f92672">==</span> items.len() {
</span></span><span style="display:flex;"><span>                        None
</span></span><span style="display:flex;"><span>                    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                        Some(<span style="color:#f92672">&amp;</span>items[entry.index])
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                _ <span style="color:#f92672">=&gt;</span> unreachable!(),
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            None
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// get the summary of the current item pointed to by curr leaf
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">#[track_caller]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">item_summary</span>(<span style="color:#f92672">&amp;</span>self) -&gt; Option<span style="color:#f92672">&lt;&amp;</span><span style="color:#a6e22e">&#39;a</span> T::Summary<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>        self.assert_did_seek();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Some(entry) <span style="color:#f92672">=</span> self.stack.last() {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">match</span> <span style="color:#f92672">*</span>entry.tree.<span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>                Node::Leaf {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">ref</span> item_summaries, <span style="color:#f92672">..</span>
</span></span><span style="display:flex;"><span>                } <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> entry.index <span style="color:#f92672">==</span> item_summaries.len() {
</span></span><span style="display:flex;"><span>                        None
</span></span><span style="display:flex;"><span>                    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                        Some(<span style="color:#f92672">&amp;</span>item_summaries[entry.index])
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                _ <span style="color:#f92672">=&gt;</span> unreachable!(),
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            None
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// get next item in the tree
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">#[track_caller]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">next_item</span>(<span style="color:#f92672">&amp;</span>self) -&gt; Option<span style="color:#f92672">&lt;&amp;</span><span style="color:#a6e22e">&#39;a</span> T<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>        self.assert_did_seek();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Some(entry) <span style="color:#f92672">=</span> self.stack.last() {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> entry.index <span style="color:#f92672">==</span> entry.tree.<span style="color:#ae81ff">0.</span>items().len() <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Some(next_leaf) <span style="color:#f92672">=</span> self.next_leaf() {
</span></span><span style="display:flex;"><span>                    Some(next_leaf.<span style="color:#ae81ff">0.</span>items().first().unwrap())
</span></span><span style="display:flex;"><span>                } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                    None
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">match</span> <span style="color:#f92672">*</span>entry.tree.<span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>                    Node::Leaf { <span style="color:#66d9ef">ref</span> items, <span style="color:#f92672">..</span> } <span style="color:#f92672">=&gt;</span> Some(<span style="color:#f92672">&amp;</span>items[entry.index <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>]),
</span></span><span style="display:flex;"><span>                    _ <span style="color:#f92672">=&gt;</span> unreachable!(),
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> self.at_end {
</span></span><span style="display:flex;"><span>            None
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            self.tree.first()
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// get next leaf in the tree
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">#[track_caller]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">next_leaf</span>(<span style="color:#f92672">&amp;</span>self) -&gt; Option<span style="color:#f92672">&lt;&amp;</span><span style="color:#a6e22e">&#39;a</span> SumTree<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;&gt;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> entry <span style="color:#66d9ef">in</span> self.stack.iter().rev().skip(<span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> entry.index <span style="color:#f92672">&lt;</span> entry.tree.<span style="color:#ae81ff">0.</span>child_trees().len() <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">match</span> <span style="color:#f92672">*</span>entry.tree.<span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>                    Node::Internal {
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">ref</span> child_trees, <span style="color:#f92672">..</span>
</span></span><span style="display:flex;"><span>                    } <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">return</span> Some(child_trees[entry.index <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>].leftmost_leaf()),
</span></span><span style="display:flex;"><span>                    Node::Leaf { <span style="color:#f92672">..</span> } <span style="color:#f92672">=&gt;</span> unreachable!(),
</span></span><span style="display:flex;"><span>                };
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        None
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// get prev item in the tree
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">#[track_caller]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">prev_item</span>(<span style="color:#f92672">&amp;</span>self) -&gt; Option<span style="color:#f92672">&lt;&amp;</span><span style="color:#a6e22e">&#39;a</span> T<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>        self.assert_did_seek();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Some(entry) <span style="color:#f92672">=</span> self.stack.last() {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> entry.index <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Some(prev_leaf) <span style="color:#f92672">=</span> self.prev_leaf() {
</span></span><span style="display:flex;"><span>                    Some(prev_leaf.<span style="color:#ae81ff">0.</span>items().last().unwrap())
</span></span><span style="display:flex;"><span>                } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                    None
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">match</span> <span style="color:#f92672">*</span>entry.tree.<span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>                    Node::Leaf { <span style="color:#66d9ef">ref</span> items, <span style="color:#f92672">..</span> } <span style="color:#f92672">=&gt;</span> Some(<span style="color:#f92672">&amp;</span>items[entry.index <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>]),
</span></span><span style="display:flex;"><span>                    _ <span style="color:#f92672">=&gt;</span> unreachable!(),
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// when seek_internal finds nothing, we are at the end
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> self.at_end {
</span></span><span style="display:flex;"><span>            self.tree.last()
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            None
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#[track_caller]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">prev_leaf</span>(<span style="color:#f92672">&amp;</span>self) -&gt; Option<span style="color:#f92672">&lt;&amp;</span><span style="color:#a6e22e">&#39;a</span> SumTree<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;&gt;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> entry <span style="color:#66d9ef">in</span> self.stack.iter().rev().skip(<span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> entry.index <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">match</span> <span style="color:#f92672">*</span>entry.tree.<span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>                    Node::Internal {
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">ref</span> child_trees, <span style="color:#f92672">..</span>
</span></span><span style="display:flex;"><span>                    } <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">return</span> Some(child_trees[entry.index <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>].rightmost_leaf()),
</span></span><span style="display:flex;"><span>                    Node::Leaf { <span style="color:#f92672">..</span> } <span style="color:#f92672">=&gt;</span> unreachable!(),
</span></span><span style="display:flex;"><span>                };
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        None
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// move Cursor to prev item
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">#[track_caller]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">prev</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, cx: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&lt;</span>T::Summary <span style="color:#66d9ef">as</span> Summary<span style="color:#f92672">&gt;</span>::Context) {
</span></span><span style="display:flex;"><span>        self.search_backward(<span style="color:#f92672">|</span>_<span style="color:#f92672">|</span> <span style="color:#66d9ef">true</span>, cx)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// search backward for first item that satisfies the filter
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">#[track_caller]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">search_backward</span><span style="color:#f92672">&lt;</span>F<span style="color:#f92672">&gt;</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, <span style="color:#66d9ef">mut</span> filter_node: <span style="color:#a6e22e">F</span>, cx: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&lt;</span>T::Summary <span style="color:#66d9ef">as</span> Summary<span style="color:#f92672">&gt;</span>::Context)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">where</span>
</span></span><span style="display:flex;"><span>        F: FnMut(<span style="color:#f92672">&amp;</span>T::Summary) -&gt; <span style="color:#66d9ef">bool</span>,
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span>self.did_seek {
</span></span><span style="display:flex;"><span>            self.did_seek <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>            self.at_end <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self.at_end {
</span></span><span style="display:flex;"><span>            self.position <span style="color:#f92672">=</span> D::default();
</span></span><span style="display:flex;"><span>            self.at_end <span style="color:#f92672">=</span> self.tree.is_empty();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span>self.tree.is_empty() {
</span></span><span style="display:flex;"><span>                self.stack.push(StackEntry {
</span></span><span style="display:flex;"><span>                    tree: <span style="color:#a6e22e">self</span>.tree,
</span></span><span style="display:flex;"><span>                    index: <span style="color:#a6e22e">self</span>.tree.<span style="color:#ae81ff">0.</span>child_summaries().len(),
</span></span><span style="display:flex;"><span>                    position: <span style="color:#a6e22e">D</span>::from_summary(self.tree.summary(), cx),
</span></span><span style="display:flex;"><span>                });
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> descending <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> <span style="color:#f92672">!</span>self.stack.is_empty() {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Some(StackEntry { position, <span style="color:#f92672">..</span> }) <span style="color:#f92672">=</span> self.stack.iter().rev().nth(<span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>                self.position <span style="color:#f92672">=</span> position.clone();
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                self.position <span style="color:#f92672">=</span> D::default();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> entry <span style="color:#f92672">=</span> self.stack.last_mut().unwrap();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span>descending {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> entry.index <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>                    self.stack.pop();
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>                } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                    entry.index <span style="color:#f92672">-=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> summary <span style="color:#66d9ef">in</span> <span style="color:#f92672">&amp;</span>entry.tree.<span style="color:#ae81ff">0.</span>child_summaries()[<span style="color:#f92672">..</span>entry.index] {
</span></span><span style="display:flex;"><span>                self.position.add_summary(summary, cx);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            entry.position <span style="color:#f92672">=</span> self.position.clone();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            descending <span style="color:#f92672">=</span> filter_node(<span style="color:#f92672">&amp;</span>entry.tree.<span style="color:#ae81ff">0.</span>child_summaries()[entry.index]);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">match</span> entry.tree.<span style="color:#ae81ff">0.</span>as_ref() {
</span></span><span style="display:flex;"><span>                Node::Internal { child_trees, <span style="color:#f92672">..</span> } <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> descending {
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">let</span> tree <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>child_trees[entry.index];
</span></span><span style="display:flex;"><span>                        self.stack.push(StackEntry {
</span></span><span style="display:flex;"><span>                            position: <span style="color:#a6e22e">D</span>::default(),
</span></span><span style="display:flex;"><span>                            tree,
</span></span><span style="display:flex;"><span>                            index: <span style="color:#a6e22e">tree</span>.<span style="color:#ae81ff">0.</span>child_summaries().len() <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>                        })
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                Node::Leaf { <span style="color:#f92672">..</span> } <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> descending {
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// move Cursor to next item
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">#[track_caller]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">next</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, cx: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&lt;</span>T::Summary <span style="color:#66d9ef">as</span> Summary<span style="color:#f92672">&gt;</span>::Context) {
</span></span><span style="display:flex;"><span>        self.search_forward(<span style="color:#f92672">|</span>_<span style="color:#f92672">|</span> <span style="color:#66d9ef">true</span>, cx)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// search forward for first item that satisfies the filter
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">#[track_caller]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">search_forward</span><span style="color:#f92672">&lt;</span>F<span style="color:#f92672">&gt;</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, <span style="color:#66d9ef">mut</span> filter_node: <span style="color:#a6e22e">F</span>, cx: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&lt;</span>T::Summary <span style="color:#66d9ef">as</span> Summary<span style="color:#f92672">&gt;</span>::Context)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">where</span>
</span></span><span style="display:flex;"><span>        F: FnMut(<span style="color:#f92672">&amp;</span>T::Summary) -&gt; <span style="color:#66d9ef">bool</span>,
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> descend <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self.stack.is_empty() {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span>self.at_end {
</span></span><span style="display:flex;"><span>                self.stack.push(StackEntry {
</span></span><span style="display:flex;"><span>                    tree: <span style="color:#a6e22e">self</span>.tree,
</span></span><span style="display:flex;"><span>                    index: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>                    position: <span style="color:#a6e22e">D</span>::default(),
</span></span><span style="display:flex;"><span>                });
</span></span><span style="display:flex;"><span>                descend <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            self.did_seek <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> <span style="color:#f92672">!</span>self.stack.is_empty() {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> new_subtree <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let</span> entry <span style="color:#f92672">=</span> self.stack.last_mut().unwrap();
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">match</span> entry.tree.<span style="color:#ae81ff">0.</span>as_ref() {
</span></span><span style="display:flex;"><span>                    Node::Internal {
</span></span><span style="display:flex;"><span>                        child_trees,
</span></span><span style="display:flex;"><span>                        child_summaries,
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">..</span>
</span></span><span style="display:flex;"><span>                    } <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span>descend {
</span></span><span style="display:flex;"><span>                            entry.index <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                            entry.position <span style="color:#f92672">=</span> self.position.clone();
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">while</span> entry.index <span style="color:#f92672">&lt;</span> child_summaries.len() {
</span></span><span style="display:flex;"><span>                            <span style="color:#66d9ef">let</span> next_summary <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>child_summaries[entry.index];
</span></span><span style="display:flex;"><span>                            <span style="color:#66d9ef">if</span> filter_node(next_summary) {
</span></span><span style="display:flex;"><span>                                <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>                            } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                                entry.index <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                                entry.position.add_summary(next_summary, cx);
</span></span><span style="display:flex;"><span>                                self.position.add_summary(next_summary, cx);
</span></span><span style="display:flex;"><span>                            }
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                        child_trees.get(entry.index)
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    Node::Leaf { item_summaries, <span style="color:#f92672">..</span> } <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span>descend {
</span></span><span style="display:flex;"><span>                            <span style="color:#66d9ef">let</span> item_summary <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>item_summaries[entry.index];
</span></span><span style="display:flex;"><span>                            entry.index <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                            entry.position.add_summary(item_summary, cx);
</span></span><span style="display:flex;"><span>                            self.position.add_summary(item_summary, cx);
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">loop</span> {
</span></span><span style="display:flex;"><span>                            <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Some(next_item_summary) <span style="color:#f92672">=</span> item_summaries.get(entry.index) {
</span></span><span style="display:flex;"><span>                                <span style="color:#66d9ef">if</span> filter_node(next_item_summary) {
</span></span><span style="display:flex;"><span>                                    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>                                } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                                    entry.index <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                                    entry.position.add_summary(next_item_summary, cx);
</span></span><span style="display:flex;"><span>                                    self.position.add_summary(next_item_summary, cx);
</span></span><span style="display:flex;"><span>                                }
</span></span><span style="display:flex;"><span>                            } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                                <span style="color:#66d9ef">break</span> None;
</span></span><span style="display:flex;"><span>                            }
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Some(subtree) <span style="color:#f92672">=</span> new_subtree {
</span></span><span style="display:flex;"><span>                descend <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>                self.stack.push(StackEntry {
</span></span><span style="display:flex;"><span>                    tree: <span style="color:#a6e22e">subtree</span>,
</span></span><span style="display:flex;"><span>                    index: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>                    position: <span style="color:#a6e22e">self</span>.position.clone(),
</span></span><span style="display:flex;"><span>                });
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                descend <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>                self.stack.pop();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self.at_end <span style="color:#f92672">=</span> self.stack.is_empty();
</span></span><span style="display:flex;"><span>        debug_assert!(self.stack.is_empty() <span style="color:#f92672">||</span> self.stack.last().unwrap().tree.<span style="color:#ae81ff">0.</span>is_leaf());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#[track_caller]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">assert_did_seek</span>(<span style="color:#f92672">&amp;</span>self) {
</span></span><span style="display:flex;"><span>        assert!(
</span></span><span style="display:flex;"><span>            self.did_seek,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Must call `seek`, `next` or `prev` before calling this method&#34;</span>
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T, D<span style="color:#f92672">&gt;</span> Cursor<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T, D<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span>
</span></span><span style="display:flex;"><span>    T: <span style="color:#a6e22e">Item</span>,
</span></span><span style="display:flex;"><span>    D: <span style="color:#a6e22e">Dimension</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T::Summary<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#[track_caller]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">seek</span><span style="color:#f92672">&lt;</span>Target<span style="color:#f92672">&gt;</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self,
</span></span><span style="display:flex;"><span>        pos: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">Target</span>,
</span></span><span style="display:flex;"><span>        bias: <span style="color:#a6e22e">Bias</span>,
</span></span><span style="display:flex;"><span>        cx: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&lt;</span>T::Summary <span style="color:#66d9ef">as</span> Summary<span style="color:#f92672">&gt;</span>::Context,
</span></span><span style="display:flex;"><span>    ) -&gt; <span style="color:#66d9ef">bool</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">where</span>
</span></span><span style="display:flex;"><span>        Target: <span style="color:#a6e22e">SeekTarget</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T::Summary, D<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        self.reset();
</span></span><span style="display:flex;"><span>        self.seek_internal(pos, bias, <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> (), cx)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#[track_caller]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">seek_forward</span><span style="color:#f92672">&lt;</span>Target<span style="color:#f92672">&gt;</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self,
</span></span><span style="display:flex;"><span>        pos: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">Target</span>,
</span></span><span style="display:flex;"><span>        bias: <span style="color:#a6e22e">Bias</span>,
</span></span><span style="display:flex;"><span>        cx: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&lt;</span>T::Summary <span style="color:#66d9ef">as</span> Summary<span style="color:#f92672">&gt;</span>::Context,
</span></span><span style="display:flex;"><span>    ) -&gt; <span style="color:#66d9ef">bool</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">where</span>
</span></span><span style="display:flex;"><span>        Target: <span style="color:#a6e22e">SeekTarget</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T::Summary, D<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        self.seek_internal(pos, bias, <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> (), cx)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// seek to the target position, return a new SumTree that contains the items passed
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">#[track_caller]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">slice</span><span style="color:#f92672">&lt;</span>Target<span style="color:#f92672">&gt;</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self,
</span></span><span style="display:flex;"><span>        end: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">Target</span>,
</span></span><span style="display:flex;"><span>        bias: <span style="color:#a6e22e">Bias</span>,
</span></span><span style="display:flex;"><span>        cx: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&lt;</span>T::Summary <span style="color:#66d9ef">as</span> Summary<span style="color:#f92672">&gt;</span>::Context,
</span></span><span style="display:flex;"><span>    ) -&gt; <span style="color:#a6e22e">SumTree</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">where</span>
</span></span><span style="display:flex;"><span>        Target: <span style="color:#a6e22e">SeekTarget</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T::Summary, D<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> slice <span style="color:#f92672">=</span> SliceSeekAggregate {
</span></span><span style="display:flex;"><span>            tree: <span style="color:#a6e22e">SumTree</span>::new(),
</span></span><span style="display:flex;"><span>            leaf_items: <span style="color:#a6e22e">ArrayVec</span>::new(),
</span></span><span style="display:flex;"><span>            leaf_item_summaries: <span style="color:#a6e22e">ArrayVec</span>::new(),
</span></span><span style="display:flex;"><span>            leaf_summary: <span style="color:#a6e22e">T</span>::Summary::default(),
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>        self.seek_internal(end, bias, <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> slice, cx);
</span></span><span style="display:flex;"><span>        slice.tree
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// return a new SumTree that contains the items till the end
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">#[track_caller]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">suffix</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, cx: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&lt;</span>T::Summary <span style="color:#66d9ef">as</span> Summary<span style="color:#f92672">&gt;</span>::Context) -&gt; <span style="color:#a6e22e">SumTree</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>        self.slice(<span style="color:#f92672">&amp;</span>End::new(), Bias::Right, cx)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// return Summary from curr to target
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">#[track_caller]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">summary</span><span style="color:#f92672">&lt;</span>Target, Output<span style="color:#f92672">&gt;</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self,
</span></span><span style="display:flex;"><span>        end: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">Target</span>,
</span></span><span style="display:flex;"><span>        bias: <span style="color:#a6e22e">Bias</span>,
</span></span><span style="display:flex;"><span>        cx: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&lt;</span>T::Summary <span style="color:#66d9ef">as</span> Summary<span style="color:#f92672">&gt;</span>::Context,
</span></span><span style="display:flex;"><span>    ) -&gt; <span style="color:#a6e22e">Output</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">where</span>
</span></span><span style="display:flex;"><span>        Target: <span style="color:#a6e22e">SeekTarget</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T::Summary, D<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>        Output: <span style="color:#a6e22e">Dimension</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T::Summary<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> summary <span style="color:#f92672">=</span> SummarySeekAggregate(Output::default());
</span></span><span style="display:flex;"><span>        self.seek_internal(end, bias, <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> summary, cx);
</span></span><span style="display:flex;"><span>        summary.<span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Returns whether we found the item you where seeking for
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#75715e">// move Cursor to the last item whose position is less than or equal to the target
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">#[track_caller]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">seek_internal</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self,
</span></span><span style="display:flex;"><span>        target: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">dyn</span> SeekTarget<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T::Summary, D<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>        bias: <span style="color:#a6e22e">Bias</span>,
</span></span><span style="display:flex;"><span>        aggregate: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">mut</span> <span style="color:#66d9ef">dyn</span> SeekAggregate<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>        cx: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&lt;</span>T::Summary <span style="color:#66d9ef">as</span> Summary<span style="color:#f92672">&gt;</span>::Context,
</span></span><span style="display:flex;"><span>    ) -&gt; <span style="color:#66d9ef">bool</span> {
</span></span><span style="display:flex;"><span>        debug_assert!(
</span></span><span style="display:flex;"><span>            target.cmp(<span style="color:#f92672">&amp;</span>self.position, cx) <span style="color:#f92672">&gt;=</span> Ordering::Equal,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;cannot seek backward from {:?} to {:?}&#34;</span>,
</span></span><span style="display:flex;"><span>            self.position,
</span></span><span style="display:flex;"><span>            target
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span>self.did_seek {
</span></span><span style="display:flex;"><span>            self.did_seek <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>            self.stack.push(StackEntry {
</span></span><span style="display:flex;"><span>                tree: <span style="color:#a6e22e">self</span>.tree,
</span></span><span style="display:flex;"><span>                index: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>                position: Default::default(),
</span></span><span style="display:flex;"><span>            });
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> ascending <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">&#39;outer</span>: <span style="color:#a6e22e">while</span> <span style="color:#66d9ef">let</span> Some(entry) <span style="color:#f92672">=</span> self.stack.last_mut() {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">match</span> <span style="color:#f92672">*</span>entry.tree.<span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>                Node::Internal {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">ref</span> child_summaries,
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">ref</span> child_trees,
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">..</span>
</span></span><span style="display:flex;"><span>                } <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> ascending {
</span></span><span style="display:flex;"><span>                        entry.index <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                        entry.position <span style="color:#f92672">=</span> self.position.clone();
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">for</span> (child_tree, child_summary) <span style="color:#66d9ef">in</span> child_trees[entry.index<span style="color:#f92672">..</span>]
</span></span><span style="display:flex;"><span>                        .iter()
</span></span><span style="display:flex;"><span>                        .zip(<span style="color:#f92672">&amp;</span>child_summaries[entry.index<span style="color:#f92672">..</span>])
</span></span><span style="display:flex;"><span>                    {
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> child_end <span style="color:#f92672">=</span> self.position.clone();
</span></span><span style="display:flex;"><span>                        child_end.add_summary(child_summary, cx);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">let</span> comparison <span style="color:#f92672">=</span> target.cmp(<span style="color:#f92672">&amp;</span>child_end, cx);
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">if</span> comparison <span style="color:#f92672">==</span> Ordering::Greater
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">||</span> (comparison <span style="color:#f92672">==</span> Ordering::Equal <span style="color:#f92672">&amp;&amp;</span> bias <span style="color:#f92672">==</span> Bias::Right)
</span></span><span style="display:flex;"><span>                        {
</span></span><span style="display:flex;"><span>                            self.position <span style="color:#f92672">=</span> child_end;
</span></span><span style="display:flex;"><span>                            aggregate.push_tree(child_tree, child_summary, cx);
</span></span><span style="display:flex;"><span>                            entry.index <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                            entry.position <span style="color:#f92672">=</span> self.position.clone();
</span></span><span style="display:flex;"><span>                        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                            self.stack.push(StackEntry {
</span></span><span style="display:flex;"><span>                                tree: <span style="color:#a6e22e">child_tree</span>,
</span></span><span style="display:flex;"><span>                                index: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>                                position: <span style="color:#a6e22e">self</span>.position.clone(),
</span></span><span style="display:flex;"><span>                            });
</span></span><span style="display:flex;"><span>                            ascending <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>                            <span style="color:#66d9ef">continue</span> &#39;outer;
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                Node::Leaf {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">ref</span> items,
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">ref</span> item_summaries,
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">..</span>
</span></span><span style="display:flex;"><span>                } <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>                    aggregate.begin_leaf();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">for</span> (item, item_summary) <span style="color:#66d9ef">in</span> items[entry.index<span style="color:#f92672">..</span>]
</span></span><span style="display:flex;"><span>                        .iter()
</span></span><span style="display:flex;"><span>                        .zip(<span style="color:#f92672">&amp;</span>item_summaries[entry.index<span style="color:#f92672">..</span>])
</span></span><span style="display:flex;"><span>                    {
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> child_end <span style="color:#f92672">=</span> self.position.clone();
</span></span><span style="display:flex;"><span>                        child_end.add_summary(item_summary, cx);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">let</span> comparison <span style="color:#f92672">=</span> target.cmp(<span style="color:#f92672">&amp;</span>child_end, cx);
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">if</span> comparison <span style="color:#f92672">==</span> Ordering::Greater
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">||</span> (comparison <span style="color:#f92672">==</span> Ordering::Equal <span style="color:#f92672">&amp;&amp;</span> bias <span style="color:#f92672">==</span> Bias::Right)
</span></span><span style="display:flex;"><span>                        {
</span></span><span style="display:flex;"><span>                            self.position <span style="color:#f92672">=</span> child_end;
</span></span><span style="display:flex;"><span>                            aggregate.push_item(item, item_summary, cx);
</span></span><span style="display:flex;"><span>                            entry.index <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                            aggregate.end_leaf(cx);
</span></span><span style="display:flex;"><span>                            <span style="color:#66d9ef">break</span> &#39;outer;
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    aggregate.end_leaf(cx);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            self.stack.pop();
</span></span><span style="display:flex;"><span>            ascending <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self.at_end <span style="color:#f92672">=</span> self.stack.is_empty();
</span></span><span style="display:flex;"><span>        debug_assert!(self.stack.is_empty() <span style="color:#f92672">||</span> self.stack.last().unwrap().tree.<span style="color:#ae81ff">0.</span>is_leaf());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> end <span style="color:#f92672">=</span> self.position.clone();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> bias <span style="color:#f92672">==</span> Bias::Left {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Some(summary) <span style="color:#f92672">=</span> self.item_summary() {
</span></span><span style="display:flex;"><span>                end.add_summary(summary, cx);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        target.cmp(<span style="color:#f92672">&amp;</span>end, cx) <span style="color:#f92672">==</span> Ordering::Equal
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T: <span style="color:#a6e22e">Item</span><span style="color:#f92672">&gt;</span> Iter<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span>(<span style="color:#66d9ef">crate</span>) <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">new</span>(tree: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">&#39;a</span> <span style="color:#a6e22e">SumTree</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span>) -&gt; <span style="color:#a6e22e">Self</span> {
</span></span><span style="display:flex;"><span>        Self {
</span></span><span style="display:flex;"><span>            tree,
</span></span><span style="display:flex;"><span>            stack: Default::default(),
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T: <span style="color:#a6e22e">Item</span><span style="color:#f92672">&gt;</span> Iterator <span style="color:#66d9ef">for</span> Iter<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Item</span> <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">&#39;a</span> T;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">next</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self) -&gt; Option<span style="color:#f92672">&lt;</span>Self::Item<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> descend <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self.stack.is_empty() {
</span></span><span style="display:flex;"><span>            self.stack.push(StackEntry {
</span></span><span style="display:flex;"><span>                tree: <span style="color:#a6e22e">self</span>.tree,
</span></span><span style="display:flex;"><span>                index: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>                position: (),
</span></span><span style="display:flex;"><span>            });
</span></span><span style="display:flex;"><span>            descend <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> <span style="color:#f92672">!</span>self.stack.is_empty() {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> new_subtree <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let</span> entry <span style="color:#f92672">=</span> self.stack.last_mut().unwrap();
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">match</span> entry.tree.<span style="color:#ae81ff">0.</span>as_ref() {
</span></span><span style="display:flex;"><span>                    Node::Internal { child_trees, <span style="color:#f92672">..</span> } <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span>descend {
</span></span><span style="display:flex;"><span>                            entry.index <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                        child_trees.get(entry.index)
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    Node::Leaf { items, <span style="color:#f92672">..</span> } <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span>descend {
</span></span><span style="display:flex;"><span>                            entry.index <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Some(next_item) <span style="color:#f92672">=</span> items.get(entry.index) {
</span></span><span style="display:flex;"><span>                            <span style="color:#66d9ef">return</span> Some(next_item);
</span></span><span style="display:flex;"><span>                        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                            None
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Some(subtree) <span style="color:#f92672">=</span> new_subtree {
</span></span><span style="display:flex;"><span>                descend <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>                self.stack.push(StackEntry {
</span></span><span style="display:flex;"><span>                    tree: <span style="color:#a6e22e">subtree</span>,
</span></span><span style="display:flex;"><span>                    index: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>                    position: (),
</span></span><span style="display:flex;"><span>                });
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                descend <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>                self.stack.pop();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        None
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T, S, D<span style="color:#f92672">&gt;</span> Iterator <span style="color:#66d9ef">for</span> Cursor<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T, D<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span>
</span></span><span style="display:flex;"><span>    T: <span style="color:#a6e22e">Item</span><span style="color:#f92672">&lt;</span>Summary <span style="color:#f92672">=</span> S<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    S: <span style="color:#a6e22e">Summary</span><span style="color:#f92672">&lt;</span>Context <span style="color:#f92672">=</span> ()<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    D: <span style="color:#a6e22e">Dimension</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T::Summary<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Item</span> <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">&#39;a</span> T;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">next</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self) -&gt; Option<span style="color:#f92672">&lt;</span>Self::Item<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// If we haven&#39;t already sought to the start of the cursor, do so
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span>self.did_seek {
</span></span><span style="display:flex;"><span>            self.next(<span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Some(item) <span style="color:#f92672">=</span> self.item() {
</span></span><span style="display:flex;"><span>            self.next(<span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>            Some(item)
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            None
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">FilterCursor</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, F, T: <span style="color:#a6e22e">Item</span>, D<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    cursor: <span style="color:#a6e22e">Cursor</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T, D<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    filter_node: <span style="color:#a6e22e">F</span>,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, F, T, D<span style="color:#f92672">&gt;</span> FilterCursor<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, F, T, D<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span>
</span></span><span style="display:flex;"><span>    F: FnMut(<span style="color:#f92672">&amp;</span>T::Summary) -&gt; <span style="color:#66d9ef">bool</span>,
</span></span><span style="display:flex;"><span>    T: <span style="color:#a6e22e">Item</span>,
</span></span><span style="display:flex;"><span>    D: <span style="color:#a6e22e">Dimension</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T::Summary<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">new</span>(tree: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">&#39;a</span> <span style="color:#a6e22e">SumTree</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span>, filter_node: <span style="color:#a6e22e">F</span>) -&gt; <span style="color:#a6e22e">Self</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> cursor <span style="color:#f92672">=</span> tree.cursor::<span style="color:#f92672">&lt;</span>D<span style="color:#f92672">&gt;</span>();
</span></span><span style="display:flex;"><span>        Self {
</span></span><span style="display:flex;"><span>            cursor,
</span></span><span style="display:flex;"><span>            filter_node,
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">start</span>(<span style="color:#f92672">&amp;</span>self) -&gt; <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">D</span> {
</span></span><span style="display:flex;"><span>        self.cursor.start()
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">end</span>(<span style="color:#f92672">&amp;</span>self, cx: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&lt;</span>T::Summary <span style="color:#66d9ef">as</span> Summary<span style="color:#f92672">&gt;</span>::Context) -&gt; <span style="color:#a6e22e">D</span> {
</span></span><span style="display:flex;"><span>        self.cursor.end(cx)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">item</span>(<span style="color:#f92672">&amp;</span>self) -&gt; Option<span style="color:#f92672">&lt;&amp;</span><span style="color:#a6e22e">&#39;a</span> T<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>        self.cursor.item()
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">item_summary</span>(<span style="color:#f92672">&amp;</span>self) -&gt; Option<span style="color:#f92672">&lt;&amp;</span><span style="color:#a6e22e">&#39;a</span> T::Summary<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>        self.cursor.item_summary()
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">next</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, cx: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&lt;</span>T::Summary <span style="color:#66d9ef">as</span> Summary<span style="color:#f92672">&gt;</span>::Context) {
</span></span><span style="display:flex;"><span>        self.cursor.search_forward(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self.filter_node, cx);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">prev</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, cx: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&lt;</span>T::Summary <span style="color:#66d9ef">as</span> Summary<span style="color:#f92672">&gt;</span>::Context) {
</span></span><span style="display:flex;"><span>        self.cursor.search_backward(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self.filter_node, cx);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, F, T, S, U<span style="color:#f92672">&gt;</span> Iterator <span style="color:#66d9ef">for</span> FilterCursor<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, F, T, U<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span>
</span></span><span style="display:flex;"><span>    F: FnMut(<span style="color:#f92672">&amp;</span>T::Summary) -&gt; <span style="color:#66d9ef">bool</span>,
</span></span><span style="display:flex;"><span>    T: <span style="color:#a6e22e">Item</span><span style="color:#f92672">&lt;</span>Summary <span style="color:#f92672">=</span> S<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    S: <span style="color:#a6e22e">Summary</span><span style="color:#f92672">&lt;</span>Context <span style="color:#f92672">=</span> ()<span style="color:#f92672">&gt;</span>, <span style="color:#75715e">//Context for the summary must be unit type, as .next() doesn&#39;t take arguments
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    U: <span style="color:#a6e22e">Dimension</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T::Summary<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Item</span> <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">&#39;a</span> T;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">next</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self) -&gt; Option<span style="color:#f92672">&lt;</span>Self::Item<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span>self.cursor.did_seek {
</span></span><span style="display:flex;"><span>            self.next(<span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Some(item) <span style="color:#f92672">=</span> self.item() {
</span></span><span style="display:flex;"><span>            self.cursor.search_forward(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self.filter_node, <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>            Some(item)
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            None
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">trait</span> SeekAggregate<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T: <span style="color:#a6e22e">Item</span><span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">begin_leaf</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">end_leaf</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, cx: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&lt;</span>T::Summary <span style="color:#66d9ef">as</span> Summary<span style="color:#f92672">&gt;</span>::Context);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">push_item</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self,
</span></span><span style="display:flex;"><span>        item: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">&#39;a</span> <span style="color:#a6e22e">T</span>,
</span></span><span style="display:flex;"><span>        summary: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">&#39;a</span> <span style="color:#a6e22e">T</span>::Summary,
</span></span><span style="display:flex;"><span>        cx: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&lt;</span>T::Summary <span style="color:#66d9ef">as</span> Summary<span style="color:#f92672">&gt;</span>::Context,
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">push_tree</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self,
</span></span><span style="display:flex;"><span>        tree: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">&#39;a</span> <span style="color:#a6e22e">SumTree</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>        summary: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">&#39;a</span> <span style="color:#a6e22e">T</span>::Summary,
</span></span><span style="display:flex;"><span>        cx: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&lt;</span>T::Summary <span style="color:#66d9ef">as</span> Summary<span style="color:#f92672">&gt;</span>::Context,
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// for creating a new tree
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">SliceSeekAggregate</span><span style="color:#f92672">&lt;</span>T: <span style="color:#a6e22e">Item</span><span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    tree: <span style="color:#a6e22e">SumTree</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    leaf_items: <span style="color:#a6e22e">ArrayVec</span><span style="color:#f92672">&lt;</span>T, { <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">TREE_BASE</span> }<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    leaf_item_summaries: <span style="color:#a6e22e">ArrayVec</span><span style="color:#f92672">&lt;</span>T::Summary, { <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">TREE_BASE</span> }<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    leaf_summary: <span style="color:#a6e22e">T</span>::Summary,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// for calculating the summary of a tree
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">SummarySeekAggregate</span><span style="color:#f92672">&lt;</span>D<span style="color:#f92672">&gt;</span>(D);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T: <span style="color:#a6e22e">Item</span><span style="color:#f92672">&gt;</span> SeekAggregate<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">for</span> () {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">begin_leaf</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self) {}
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">end_leaf</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, _: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&lt;</span>T::Summary <span style="color:#66d9ef">as</span> Summary<span style="color:#f92672">&gt;</span>::Context) {}
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">push_item</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, _: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">T</span>, _: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">T</span>::Summary, _: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&lt;</span>T::Summary <span style="color:#66d9ef">as</span> Summary<span style="color:#f92672">&gt;</span>::Context) {}
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">push_tree</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, _: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">SumTree</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span>, _: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">T</span>::Summary, _: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&lt;</span>T::Summary <span style="color:#66d9ef">as</span> Summary<span style="color:#f92672">&gt;</span>::Context) {}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T: <span style="color:#a6e22e">Item</span><span style="color:#f92672">&gt;</span> SeekAggregate<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">for</span> SliceSeekAggregate<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">begin_leaf</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self) {}
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">end_leaf</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, cx: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&lt;</span>T::Summary <span style="color:#66d9ef">as</span> Summary<span style="color:#f92672">&gt;</span>::Context) {
</span></span><span style="display:flex;"><span>        self.tree.append(
</span></span><span style="display:flex;"><span>            SumTree(Arc::new(Node::Leaf {
</span></span><span style="display:flex;"><span>                summary: <span style="color:#a6e22e">mem</span>::take(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self.leaf_summary),
</span></span><span style="display:flex;"><span>                items: <span style="color:#a6e22e">mem</span>::take(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self.leaf_items),
</span></span><span style="display:flex;"><span>                item_summaries: <span style="color:#a6e22e">mem</span>::take(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self.leaf_item_summaries),
</span></span><span style="display:flex;"><span>            })),
</span></span><span style="display:flex;"><span>            cx,
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">push_item</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, item: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">T</span>, summary: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">T</span>::Summary, cx: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&lt;</span>T::Summary <span style="color:#66d9ef">as</span> Summary<span style="color:#f92672">&gt;</span>::Context) {
</span></span><span style="display:flex;"><span>        self.leaf_items.push(item.clone());
</span></span><span style="display:flex;"><span>        self.leaf_item_summaries.push(summary.clone());
</span></span><span style="display:flex;"><span>        Summary::add_summary(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self.leaf_summary, summary, cx);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">push_tree</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self,
</span></span><span style="display:flex;"><span>        tree: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">SumTree</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>        _: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">T</span>::Summary,
</span></span><span style="display:flex;"><span>        cx: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&lt;</span>T::Summary <span style="color:#66d9ef">as</span> Summary<span style="color:#f92672">&gt;</span>::Context,
</span></span><span style="display:flex;"><span>    ) {
</span></span><span style="display:flex;"><span>        self.tree.append(tree.clone(), cx);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T: <span style="color:#a6e22e">Item</span>, D<span style="color:#f92672">&gt;</span> SeekAggregate<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">for</span> SummarySeekAggregate<span style="color:#f92672">&lt;</span>D<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span>
</span></span><span style="display:flex;"><span>    D: <span style="color:#a6e22e">Dimension</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T::Summary<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">begin_leaf</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self) {}
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">end_leaf</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, _: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&lt;</span>T::Summary <span style="color:#66d9ef">as</span> Summary<span style="color:#f92672">&gt;</span>::Context) {}
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">push_item</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, _: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">T</span>, summary: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">&#39;a</span> <span style="color:#a6e22e">T</span>::Summary, cx: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&lt;</span>T::Summary <span style="color:#66d9ef">as</span> Summary<span style="color:#f92672">&gt;</span>::Context) {
</span></span><span style="display:flex;"><span>        self.<span style="color:#ae81ff">0.</span>add_summary(summary, cx);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">push_tree</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self,
</span></span><span style="display:flex;"><span>        _: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">SumTree</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>        summary: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">&#39;a</span> <span style="color:#a6e22e">T</span>::Summary,
</span></span><span style="display:flex;"><span>        cx: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&lt;</span>T::Summary <span style="color:#66d9ef">as</span> Summary<span style="color:#f92672">&gt;</span>::Context,
</span></span><span style="display:flex;"><span>    ) {
</span></span><span style="display:flex;"><span>        self.<span style="color:#ae81ff">0.</span>add_summary(summary, cx);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>以下是 SumTree 的代码解读：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">// sum_tree.rs
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">mod</span> cursor;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">mod</span> tree_map;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> arrayvec::ArrayVec;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">use</span> cursor::{Cursor, FilterCursor, Iter};
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> rayon::prelude::<span style="color:#f92672">*</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> std::marker::PhantomData;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> std::mem;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> std::{cmp::Ordering, fmt, iter::FromIterator, sync::Arc};
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">use</span> tree_map::{MapSeekTarget, TreeMap, TreeSet};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#[cfg(test)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">TREE_BASE</span>: <span style="color:#66d9ef">usize</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#[cfg(not(test))]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">TREE_BASE</span>: <span style="color:#66d9ef">usize</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">6</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">/// An item that can be stored in a [`SumTree`]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">///
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/// Must be summarized by a type that implements [`Summary`]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">trait</span> Item: Clone {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Summary</span>: <span style="color:#a6e22e">Summary</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">summary</span>(<span style="color:#f92672">&amp;</span>self) -&gt; <span style="color:#a6e22e">Self</span>::Summary;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">/// An [`Item`] whose summary has a specific key that can be used to identify it
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">trait</span> KeyedItem: <span style="color:#a6e22e">Item</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Key</span>: <span style="color:#a6e22e">for</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span><span style="color:#f92672">&gt;</span> Dimension<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, Self::Summary<span style="color:#f92672">&gt;</span> <span style="color:#f92672">+</span> Ord;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">key</span>(<span style="color:#f92672">&amp;</span>self) -&gt; <span style="color:#a6e22e">Self</span>::Key;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">/// A type that describes the Sum of all [`Item`]s in a subtree of the [`SumTree`]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">///
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/// Each Summary type can have multiple [`Dimensions`] that it measures,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/// which can be used to navigate the tree
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">trait</span> Summary: Default <span style="color:#f92672">+</span> Clone <span style="color:#f92672">+</span> fmt::Debug {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Context</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">add_summary</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, summary: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">Self</span>, cx: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">Self</span>::Context);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">/// Each [`Summary`] type can have more than one [`Dimension`] type that it measures.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">///
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/// You can use dimensions to seek to a specific location in the [`SumTree`]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">///
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/// # Example:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/// Zed&#39;s rope has a `TextSummary` type that summarizes lines, characters, and bytes.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/// Each of these are different dimensions we may want to seek to
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">trait</span> Dimension<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, S: <span style="color:#a6e22e">Summary</span><span style="color:#f92672">&gt;</span>: Clone <span style="color:#f92672">+</span> fmt::Debug <span style="color:#f92672">+</span> Default {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">add_summary</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, _summary: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">&#39;a</span> <span style="color:#a6e22e">S</span>, _: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">S</span>::Context);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">from_summary</span>(summary: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">&#39;a</span> <span style="color:#a6e22e">S</span>, cx: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">S</span>::Context) -&gt; <span style="color:#a6e22e">Self</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> dimension <span style="color:#f92672">=</span> Self::default();
</span></span><span style="display:flex;"><span>        dimension.add_summary(summary, cx);
</span></span><span style="display:flex;"><span>        dimension
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T: <span style="color:#a6e22e">Summary</span><span style="color:#f92672">&gt;</span> Dimension<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">for</span> T {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">add_summary</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, summary: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">&#39;a</span> <span style="color:#a6e22e">T</span>, cx: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">T</span>::Context) {
</span></span><span style="display:flex;"><span>        Summary::add_summary(self, summary, cx);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">trait</span> SeekTarget<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, S: <span style="color:#a6e22e">Summary</span>, D: <span style="color:#a6e22e">Dimension</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, S<span style="color:#f92672">&gt;&gt;</span>: <span style="color:#a6e22e">fmt</span>::Debug {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">cmp</span>(<span style="color:#f92672">&amp;</span>self, cursor_location: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">D</span>, cx: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">S</span>::Context) -&gt; <span style="color:#a6e22e">Ordering</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, S: <span style="color:#a6e22e">Summary</span>, D: <span style="color:#a6e22e">Dimension</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, S<span style="color:#f92672">&gt;</span> <span style="color:#f92672">+</span> Ord<span style="color:#f92672">&gt;</span> SeekTarget<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, S, D<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">for</span> D {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">cmp</span>(<span style="color:#f92672">&amp;</span>self, cursor_location: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">Self</span>, _: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">S</span>::Context) -&gt; <span style="color:#a6e22e">Ordering</span> {
</span></span><span style="display:flex;"><span>        Ord::cmp(self, cursor_location)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T: <span style="color:#a6e22e">Summary</span><span style="color:#f92672">&gt;</span> Dimension<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">for</span> () {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">add_summary</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, _: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">&#39;a</span> <span style="color:#a6e22e">T</span>, _: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">T</span>::Context) {}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T: <span style="color:#a6e22e">Summary</span>, D1: <span style="color:#a6e22e">Dimension</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T<span style="color:#f92672">&gt;</span>, D2: <span style="color:#a6e22e">Dimension</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T<span style="color:#f92672">&gt;&gt;</span> Dimension<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">for</span> (D1, D2) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">add_summary</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, summary: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">&#39;a</span> <span style="color:#a6e22e">T</span>, cx: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">T</span>::Context) {
</span></span><span style="display:flex;"><span>        self.<span style="color:#ae81ff">0.</span>add_summary(summary, cx);
</span></span><span style="display:flex;"><span>        self.<span style="color:#ae81ff">1.</span>add_summary(summary, cx);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, S: <span style="color:#a6e22e">Summary</span>, D1: <span style="color:#a6e22e">SeekTarget</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, S, D1<span style="color:#f92672">&gt;</span> <span style="color:#f92672">+</span> Dimension<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, S<span style="color:#f92672">&gt;</span>, D2: <span style="color:#a6e22e">Dimension</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, S<span style="color:#f92672">&gt;&gt;</span>
</span></span><span style="display:flex;"><span>    SeekTarget<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, S, (D1, D2)<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">for</span> D1
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">cmp</span>(<span style="color:#f92672">&amp;</span>self, cursor_location: <span style="color:#66d9ef">&amp;</span>(D1, D2), cx: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">S</span>::Context) -&gt; <span style="color:#a6e22e">Ordering</span> {
</span></span><span style="display:flex;"><span>        self.cmp(<span style="color:#f92672">&amp;</span>cursor_location.<span style="color:#ae81ff">0</span>, cx)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">End</span><span style="color:#f92672">&lt;</span>D<span style="color:#f92672">&gt;</span>(PhantomData<span style="color:#f92672">&lt;</span>D<span style="color:#f92672">&gt;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span><span style="color:#f92672">&lt;</span>D<span style="color:#f92672">&gt;</span> End<span style="color:#f92672">&lt;</span>D<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">new</span>() -&gt; <span style="color:#a6e22e">Self</span> {
</span></span><span style="display:flex;"><span>        Self(PhantomData)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, S: <span style="color:#a6e22e">Summary</span>, D: <span style="color:#a6e22e">Dimension</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, S<span style="color:#f92672">&gt;&gt;</span> SeekTarget<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, S, D<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">for</span> End<span style="color:#f92672">&lt;</span>D<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">cmp</span>(<span style="color:#f92672">&amp;</span>self, _: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">D</span>, _: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">S</span>::Context) -&gt; <span style="color:#a6e22e">Ordering</span> {
</span></span><span style="display:flex;"><span>        Ordering::Greater
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span><span style="color:#f92672">&lt;</span>D<span style="color:#f92672">&gt;</span> fmt::Debug <span style="color:#66d9ef">for</span> End<span style="color:#f92672">&lt;</span>D<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">fmt</span>(<span style="color:#f92672">&amp;</span>self, f: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">mut</span> fmt::Formatter<span style="color:#f92672">&lt;</span>&#39;_<span style="color:#f92672">&gt;</span>) -&gt; <span style="color:#a6e22e">fmt</span>::Result {
</span></span><span style="display:flex;"><span>        f.debug_tuple(<span style="color:#e6db74">&#34;End&#34;</span>).finish()
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">/// Bias is used to settle ambiguities when determining positions in an ordered sequence.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">///
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/// The primary use case is for text, where Bias influences
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/// which character an offset or anchor is associated with.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">///
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/// # Examples
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/// Given the buffer `AˇBCD`:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/// - The offset of the cursor is 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/// - [Bias::Left] would attach the cursor to the character `A`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/// - [Bias::Right] would attach the cursor to the character `B`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">///
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/// Given the buffer `A«BCˇ»D`:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/// - The offset of the cursor is 3, and the selection is from 1 to 3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/// - The left anchor of the selection has [Bias::Right], attaching it to the character `B`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/// - The right anchor of the selection has [Bias::Left], attaching it to the character `C`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">///
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/// Given the buffer `{ˇ&lt;...&gt;`, where `&lt;...&gt;` is a folded region:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/// - The display offset of the cursor is 1, but the offset in the buffer is determined by the bias
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/// - [Bias::Left] would attach the cursor to the character `{`, with a buffer offset of 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/// - [Bias::Right] would attach the cursor to the first character of the folded region,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">///   and the buffer offset would be the offset of the first character of the folded region
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span><span style="color:#75715e">#[derive(Copy, Clone, Eq, PartialEq, PartialOrd, Ord, Debug, Hash, Default)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">enum</span> <span style="color:#a6e22e">Bias</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Attach to the character on the left
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#75715e">#[default]</span>
</span></span><span style="display:flex;"><span>    Left,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Attach to the character on the right
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    Right,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span> Bias {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">invert</span>(self) -&gt; <span style="color:#a6e22e">Self</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">match</span> self {
</span></span><span style="display:flex;"><span>            Self::Left <span style="color:#f92672">=&gt;</span> Self::Right,
</span></span><span style="display:flex;"><span>            Self::Right <span style="color:#f92672">=&gt;</span> Self::Left,
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">/// A B+ tree in which each leaf node contains `Item`s of type `T` and a `Summary`s for each `Item`.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/// Each internal node contains a `Summary` of the items in its subtree.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">///
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/// The maximum number of items per node is `TREE_BASE * 2`.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">///
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/// Any [`Dimension`] supported by the [`Summary`] type can be used to seek to a specific location in the tree.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span><span style="color:#75715e">#[derive(Debug, Clone)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">SumTree</span><span style="color:#f92672">&lt;</span>T: <span style="color:#a6e22e">Item</span><span style="color:#f92672">&gt;</span>(Arc<span style="color:#f92672">&lt;</span>Node<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;&gt;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span><span style="color:#f92672">&lt;</span>T: <span style="color:#a6e22e">Item</span><span style="color:#f92672">&gt;</span> SumTree<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">new</span>() -&gt; <span style="color:#a6e22e">Self</span> {
</span></span><span style="display:flex;"><span>        SumTree(Arc::new(Node::Leaf {
</span></span><span style="display:flex;"><span>            summary: <span style="color:#a6e22e">T</span>::Summary::default(),
</span></span><span style="display:flex;"><span>            items: <span style="color:#a6e22e">ArrayVec</span>::new(),
</span></span><span style="display:flex;"><span>            item_summaries: <span style="color:#a6e22e">ArrayVec</span>::new(),
</span></span><span style="display:flex;"><span>        }))
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">from_item</span>(item: <span style="color:#a6e22e">T</span>, cx: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&lt;</span>T::Summary <span style="color:#66d9ef">as</span> Summary<span style="color:#f92672">&gt;</span>::Context) -&gt; <span style="color:#a6e22e">Self</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> tree <span style="color:#f92672">=</span> Self::new();
</span></span><span style="display:flex;"><span>        tree.push(item, cx);
</span></span><span style="display:flex;"><span>        tree
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// return SumTree from iterator of items. Every 2*TREE_BASE items collect into a leaf, every 2*TREE_BASE nodes collect into a parent node
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">from_iter</span><span style="color:#f92672">&lt;</span>I: IntoIterator<span style="color:#f92672">&lt;</span>Item <span style="color:#f92672">=</span> T<span style="color:#f92672">&gt;&gt;</span>(
</span></span><span style="display:flex;"><span>        iter: <span style="color:#a6e22e">I</span>,
</span></span><span style="display:flex;"><span>        cx: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&lt;</span>T::Summary <span style="color:#66d9ef">as</span> Summary<span style="color:#f92672">&gt;</span>::Context,
</span></span><span style="display:flex;"><span>    ) -&gt; <span style="color:#a6e22e">Self</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> nodes <span style="color:#f92672">=</span> Vec::new();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> iter <span style="color:#f92672">=</span> iter.into_iter().fuse().peekable();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> iter.peek().is_some() {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> items: <span style="color:#a6e22e">ArrayVec</span><span style="color:#f92672">&lt;</span>T, { <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">TREE_BASE</span> }<span style="color:#f92672">&gt;</span> <span style="color:#f92672">=</span> iter.by_ref().take(<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">TREE_BASE</span>).collect();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> item_summaries: <span style="color:#a6e22e">ArrayVec</span><span style="color:#f92672">&lt;</span>T::Summary, { <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">TREE_BASE</span> }<span style="color:#f92672">&gt;</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>                items.iter().map(<span style="color:#f92672">|</span>item<span style="color:#f92672">|</span> item.summary()).collect();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> summary <span style="color:#f92672">=</span> item_summaries[<span style="color:#ae81ff">0</span>].clone();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> item_summary <span style="color:#66d9ef">in</span> <span style="color:#f92672">&amp;</span>item_summaries[<span style="color:#ae81ff">1</span><span style="color:#f92672">..</span>] {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;</span>T::Summary <span style="color:#66d9ef">as</span> Summary<span style="color:#f92672">&gt;</span>::add_summary(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> summary, item_summary, cx);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            nodes.push(Node::Leaf {
</span></span><span style="display:flex;"><span>                summary,
</span></span><span style="display:flex;"><span>                items,
</span></span><span style="display:flex;"><span>                item_summaries,
</span></span><span style="display:flex;"><span>            });
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> parent_nodes <span style="color:#f92672">=</span> Vec::new();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> height <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> nodes.len() <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span> {
</span></span><span style="display:flex;"><span>            height <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> current_parent_node <span style="color:#f92672">=</span> None;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> child_node <span style="color:#66d9ef">in</span> nodes.drain(<span style="color:#f92672">..</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let</span> parent_node <span style="color:#f92672">=</span> current_parent_node.get_or_insert_with(<span style="color:#f92672">||</span> Node::Internal {
</span></span><span style="display:flex;"><span>                    summary: <span style="color:#a6e22e">T</span>::Summary::default(),
</span></span><span style="display:flex;"><span>                    height,
</span></span><span style="display:flex;"><span>                    child_summaries: <span style="color:#a6e22e">ArrayVec</span>::new(),
</span></span><span style="display:flex;"><span>                    child_trees: <span style="color:#a6e22e">ArrayVec</span>::new(),
</span></span><span style="display:flex;"><span>                });
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let</span> Node::Internal {
</span></span><span style="display:flex;"><span>                    summary,
</span></span><span style="display:flex;"><span>                    child_summaries,
</span></span><span style="display:flex;"><span>                    child_trees,
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">..</span>
</span></span><span style="display:flex;"><span>                } <span style="color:#f92672">=</span> parent_node
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                    unreachable!()
</span></span><span style="display:flex;"><span>                };
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let</span> child_summary <span style="color:#f92672">=</span> child_node.summary();
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;</span>T::Summary <span style="color:#66d9ef">as</span> Summary<span style="color:#f92672">&gt;</span>::add_summary(summary, child_summary, cx);
</span></span><span style="display:flex;"><span>                child_summaries.push(child_summary.clone());
</span></span><span style="display:flex;"><span>                child_trees.push(Self(Arc::new(child_node)));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> child_trees.len() <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">TREE_BASE</span> {
</span></span><span style="display:flex;"><span>                    parent_nodes.extend(current_parent_node.take());
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            parent_nodes.extend(current_parent_node.take());
</span></span><span style="display:flex;"><span>            mem::swap(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> nodes, <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> parent_nodes);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> nodes.is_empty() {
</span></span><span style="display:flex;"><span>            Self::new()
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            debug_assert_eq!(nodes.len(), <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>            Self(Arc::new(nodes.pop().unwrap()))
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// use rayon to create SumTree parallelly
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">from_par_iter</span><span style="color:#f92672">&lt;</span>I, Iter<span style="color:#f92672">&gt;</span>(iter: <span style="color:#a6e22e">I</span>, cx: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&lt;</span>T::Summary <span style="color:#66d9ef">as</span> Summary<span style="color:#f92672">&gt;</span>::Context) -&gt; <span style="color:#a6e22e">Self</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">where</span>
</span></span><span style="display:flex;"><span>        I: <span style="color:#a6e22e">IntoParallelIterator</span><span style="color:#f92672">&lt;</span>Iter <span style="color:#f92672">=</span> Iter<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>        Iter: <span style="color:#a6e22e">IndexedParallelIterator</span><span style="color:#f92672">&lt;</span>Item <span style="color:#f92672">=</span> T<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>        T: Send <span style="color:#f92672">+</span> Sync,
</span></span><span style="display:flex;"><span>        T::Summary: Send <span style="color:#f92672">+</span> Sync,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;</span>T::Summary <span style="color:#66d9ef">as</span> Summary<span style="color:#f92672">&gt;</span>::Context: Sync,
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> nodes <span style="color:#f92672">=</span> iter
</span></span><span style="display:flex;"><span>            .into_par_iter()
</span></span><span style="display:flex;"><span>            .chunks(<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">TREE_BASE</span>)
</span></span><span style="display:flex;"><span>            .map(<span style="color:#f92672">|</span>items<span style="color:#f92672">|</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let</span> items: <span style="color:#a6e22e">ArrayVec</span><span style="color:#f92672">&lt;</span>T, { <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">TREE_BASE</span> }<span style="color:#f92672">&gt;</span> <span style="color:#f92672">=</span> items.into_iter().collect();
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let</span> item_summaries: <span style="color:#a6e22e">ArrayVec</span><span style="color:#f92672">&lt;</span>T::Summary, { <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">TREE_BASE</span> }<span style="color:#f92672">&gt;</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>                    items.iter().map(<span style="color:#f92672">|</span>item<span style="color:#f92672">|</span> item.summary()).collect();
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> summary <span style="color:#f92672">=</span> item_summaries[<span style="color:#ae81ff">0</span>].clone();
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">for</span> item_summary <span style="color:#66d9ef">in</span> <span style="color:#f92672">&amp;</span>item_summaries[<span style="color:#ae81ff">1</span><span style="color:#f92672">..</span>] {
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;</span>T::Summary <span style="color:#66d9ef">as</span> Summary<span style="color:#f92672">&gt;</span>::add_summary(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> summary, item_summary, cx);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                SumTree(Arc::new(Node::Leaf {
</span></span><span style="display:flex;"><span>                    summary,
</span></span><span style="display:flex;"><span>                    items,
</span></span><span style="display:flex;"><span>                    item_summaries,
</span></span><span style="display:flex;"><span>                }))
</span></span><span style="display:flex;"><span>            })
</span></span><span style="display:flex;"><span>            .collect::<span style="color:#f92672">&lt;</span>Vec<span style="color:#f92672">&lt;</span>_<span style="color:#f92672">&gt;&gt;</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> height <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> nodes.len() <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span> {
</span></span><span style="display:flex;"><span>            height <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>            nodes <span style="color:#f92672">=</span> nodes
</span></span><span style="display:flex;"><span>                .into_par_iter()
</span></span><span style="display:flex;"><span>                .chunks(<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">TREE_BASE</span>)
</span></span><span style="display:flex;"><span>                .map(<span style="color:#f92672">|</span>child_nodes<span style="color:#f92672">|</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">let</span> child_trees: <span style="color:#a6e22e">ArrayVec</span><span style="color:#f92672">&lt;</span>SumTree<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span>, { <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">TREE_BASE</span> }<span style="color:#f92672">&gt;</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>                        child_nodes.into_iter().collect();
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">let</span> child_summaries: <span style="color:#a6e22e">ArrayVec</span><span style="color:#f92672">&lt;</span>T::Summary, { <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">TREE_BASE</span> }<span style="color:#f92672">&gt;</span> <span style="color:#f92672">=</span> child_trees
</span></span><span style="display:flex;"><span>                        .iter()
</span></span><span style="display:flex;"><span>                        .map(<span style="color:#f92672">|</span>child_tree<span style="color:#f92672">|</span> child_tree.summary().clone())
</span></span><span style="display:flex;"><span>                        .collect();
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> summary <span style="color:#f92672">=</span> child_summaries[<span style="color:#ae81ff">0</span>].clone();
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">for</span> child_summary <span style="color:#66d9ef">in</span> <span style="color:#f92672">&amp;</span>child_summaries[<span style="color:#ae81ff">1</span><span style="color:#f92672">..</span>] {
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&lt;</span>T::Summary <span style="color:#66d9ef">as</span> Summary<span style="color:#f92672">&gt;</span>::add_summary(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> summary, child_summary, cx);
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    SumTree(Arc::new(Node::Internal {
</span></span><span style="display:flex;"><span>                        height,
</span></span><span style="display:flex;"><span>                        summary,
</span></span><span style="display:flex;"><span>                        child_summaries,
</span></span><span style="display:flex;"><span>                        child_trees,
</span></span><span style="display:flex;"><span>                    }))
</span></span><span style="display:flex;"><span>                })
</span></span><span style="display:flex;"><span>                .collect::<span style="color:#f92672">&lt;</span>Vec<span style="color:#f92672">&lt;</span>_<span style="color:#f92672">&gt;&gt;</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> nodes.is_empty() {
</span></span><span style="display:flex;"><span>            Self::new()
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            debug_assert_eq!(nodes.len(), <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>            nodes.pop().unwrap()
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// get all items of the whole tree
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">#[allow(unused)]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">items</span>(<span style="color:#f92672">&amp;</span>self, cx: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&lt;</span>T::Summary <span style="color:#66d9ef">as</span> Summary<span style="color:#f92672">&gt;</span>::Context) -&gt; Vec<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> items <span style="color:#f92672">=</span> Vec::new();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> cursor <span style="color:#f92672">=</span> self.cursor::<span style="color:#f92672">&lt;</span>()<span style="color:#f92672">&gt;</span>();
</span></span><span style="display:flex;"><span>        cursor.next(cx);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">let</span> Some(item) <span style="color:#f92672">=</span> cursor.item() {
</span></span><span style="display:flex;"><span>            items.push(item.clone());
</span></span><span style="display:flex;"><span>            cursor.next(cx);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        items
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">iter</span>(<span style="color:#f92672">&amp;</span>self) -&gt; <span style="color:#a6e22e">Iter</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>        Iter::new(self)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">cursor</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, S<span style="color:#f92672">&gt;</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">&#39;a</span> self) -&gt; <span style="color:#a6e22e">Cursor</span><span style="color:#f92672">&lt;</span>T, S<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">where</span>
</span></span><span style="display:flex;"><span>        S: <span style="color:#a6e22e">Dimension</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T::Summary<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        Cursor::new(self)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Note: If the summary type requires a non `()` context, then the filter cursor
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#e6db74">/// that is returned cannot be used with Rust&#39;s iterators.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">filter</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, F, U<span style="color:#f92672">&gt;</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">&#39;a</span> self, filter_node: <span style="color:#a6e22e">F</span>) -&gt; <span style="color:#a6e22e">FilterCursor</span><span style="color:#f92672">&lt;</span>F, T, U<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">where</span>
</span></span><span style="display:flex;"><span>        F: FnMut(<span style="color:#f92672">&amp;</span>T::Summary) -&gt; <span style="color:#66d9ef">bool</span>,
</span></span><span style="display:flex;"><span>        U: <span style="color:#a6e22e">Dimension</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T::Summary<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        FilterCursor::new(self, filter_node)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// return first item
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">#[allow(dead_code)]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">first</span>(<span style="color:#f92672">&amp;</span>self) -&gt; Option<span style="color:#f92672">&lt;&amp;</span>T<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>        self.leftmost_leaf().<span style="color:#ae81ff">0.</span>items().first()
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// return last item
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">last</span>(<span style="color:#f92672">&amp;</span>self) -&gt; Option<span style="color:#f92672">&lt;&amp;</span>T<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>        self.rightmost_leaf().<span style="color:#ae81ff">0.</span>items().last()
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// update last item
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">update_last</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, f: <span style="color:#a6e22e">impl</span> FnOnce(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> T), cx: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&lt;</span>T::Summary <span style="color:#66d9ef">as</span> Summary<span style="color:#f92672">&gt;</span>::Context) {
</span></span><span style="display:flex;"><span>        self.update_last_recursive(f, cx);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// update last item and return whole whole Summary
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">update_last_recursive</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self,
</span></span><span style="display:flex;"><span>        f: <span style="color:#a6e22e">impl</span> FnOnce(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> T),
</span></span><span style="display:flex;"><span>        cx: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&lt;</span>T::Summary <span style="color:#66d9ef">as</span> Summary<span style="color:#f92672">&gt;</span>::Context,
</span></span><span style="display:flex;"><span>    ) -&gt; Option<span style="color:#f92672">&lt;</span>T::Summary<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">match</span> Arc::make_mut(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self.<span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>            Node::Internal {
</span></span><span style="display:flex;"><span>                summary,
</span></span><span style="display:flex;"><span>                child_summaries,
</span></span><span style="display:flex;"><span>                child_trees,
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">..</span>
</span></span><span style="display:flex;"><span>            } <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let</span> last_summary <span style="color:#f92672">=</span> child_summaries.last_mut().unwrap();
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let</span> last_child <span style="color:#f92672">=</span> child_trees.last_mut().unwrap();
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">*</span>last_summary <span style="color:#f92672">=</span> last_child.update_last_recursive(f, cx).unwrap();
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">*</span>summary <span style="color:#f92672">=</span> sum(child_summaries.iter(), cx);
</span></span><span style="display:flex;"><span>                Some(summary.clone())
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            Node::Leaf {
</span></span><span style="display:flex;"><span>                summary,
</span></span><span style="display:flex;"><span>                items,
</span></span><span style="display:flex;"><span>                item_summaries,
</span></span><span style="display:flex;"><span>            } <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Some((item, item_summary)) <span style="color:#f92672">=</span> items.last_mut().zip(item_summaries.last_mut())
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    (f)(item);
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">*</span>item_summary <span style="color:#f92672">=</span> item.summary();
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">*</span>summary <span style="color:#f92672">=</span> sum(item_summaries.iter(), cx);
</span></span><span style="display:flex;"><span>                    Some(summary.clone())
</span></span><span style="display:flex;"><span>                } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                    None
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// return whole Dimension of the tree
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">extent</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, D: <span style="color:#a6e22e">Dimension</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T::Summary<span style="color:#f92672">&gt;&gt;</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">&#39;a</span> self,
</span></span><span style="display:flex;"><span>        cx: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&lt;</span>T::Summary <span style="color:#66d9ef">as</span> Summary<span style="color:#f92672">&gt;</span>::Context,
</span></span><span style="display:flex;"><span>    ) -&gt; <span style="color:#a6e22e">D</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> extent <span style="color:#f92672">=</span> D::default();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">match</span> self.<span style="color:#ae81ff">0.</span>as_ref() {
</span></span><span style="display:flex;"><span>            Node::Internal { summary, <span style="color:#f92672">..</span> } <span style="color:#f92672">|</span> Node::Leaf { summary, <span style="color:#f92672">..</span> } <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>                extent.add_summary(summary, cx);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        extent
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// return whole Summary of the tree
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">summary</span>(<span style="color:#f92672">&amp;</span>self) -&gt; <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">T</span>::Summary {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">match</span> self.<span style="color:#ae81ff">0.</span>as_ref() {
</span></span><span style="display:flex;"><span>            Node::Internal { summary, <span style="color:#f92672">..</span> } <span style="color:#f92672">=&gt;</span> summary,
</span></span><span style="display:flex;"><span>            Node::Leaf { summary, <span style="color:#f92672">..</span> } <span style="color:#f92672">=&gt;</span> summary,
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// whether the SumTree is empty
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">is_empty</span>(<span style="color:#f92672">&amp;</span>self) -&gt; <span style="color:#66d9ef">bool</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">match</span> self.<span style="color:#ae81ff">0.</span>as_ref() {
</span></span><span style="display:flex;"><span>            Node::Internal { <span style="color:#f92672">..</span> } <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>            Node::Leaf { items, <span style="color:#f92672">..</span> } <span style="color:#f92672">=&gt;</span> items.is_empty(),
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// change iterator of Item to a new SumTree, then merge two Trees
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">extend</span><span style="color:#f92672">&lt;</span>I<span style="color:#f92672">&gt;</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, iter: <span style="color:#a6e22e">I</span>, cx: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&lt;</span>T::Summary <span style="color:#66d9ef">as</span> Summary<span style="color:#f92672">&gt;</span>::Context)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">where</span>
</span></span><span style="display:flex;"><span>        I: IntoIterator<span style="color:#f92672">&lt;</span>Item <span style="color:#f92672">=</span> T<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        self.append(Self::from_iter(iter, cx), cx);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// change parallel iterator of Item to a new SumTree, then merge two Trees
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">par_extend</span><span style="color:#f92672">&lt;</span>I, Iter<span style="color:#f92672">&gt;</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, iter: <span style="color:#a6e22e">I</span>, cx: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&lt;</span>T::Summary <span style="color:#66d9ef">as</span> Summary<span style="color:#f92672">&gt;</span>::Context)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">where</span>
</span></span><span style="display:flex;"><span>        I: <span style="color:#a6e22e">IntoParallelIterator</span><span style="color:#f92672">&lt;</span>Iter <span style="color:#f92672">=</span> Iter<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>        Iter: <span style="color:#a6e22e">IndexedParallelIterator</span><span style="color:#f92672">&lt;</span>Item <span style="color:#f92672">=</span> T<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>        T: Send <span style="color:#f92672">+</span> Sync,
</span></span><span style="display:flex;"><span>        T::Summary: Send <span style="color:#f92672">+</span> Sync,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;</span>T::Summary <span style="color:#66d9ef">as</span> Summary<span style="color:#f92672">&gt;</span>::Context: Sync,
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        self.append(Self::from_par_iter(iter, cx), cx);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// push one item into SumTree
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">push</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, item: <span style="color:#a6e22e">T</span>, cx: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&lt;</span>T::Summary <span style="color:#66d9ef">as</span> Summary<span style="color:#f92672">&gt;</span>::Context) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> summary <span style="color:#f92672">=</span> item.summary();
</span></span><span style="display:flex;"><span>        self.append(
</span></span><span style="display:flex;"><span>            SumTree(Arc::new(Node::Leaf {
</span></span><span style="display:flex;"><span>                summary: <span style="color:#a6e22e">summary</span>.clone(),
</span></span><span style="display:flex;"><span>                items: <span style="color:#a6e22e">ArrayVec</span>::from_iter(Some(item)),
</span></span><span style="display:flex;"><span>                item_summaries: <span style="color:#a6e22e">ArrayVec</span>::from_iter(Some(summary)),
</span></span><span style="display:flex;"><span>            })),
</span></span><span style="display:flex;"><span>            cx,
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// append other tree into self tree
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">append</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, other: <span style="color:#a6e22e">Self</span>, cx: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&lt;</span>T::Summary <span style="color:#66d9ef">as</span> Summary<span style="color:#f92672">&gt;</span>::Context) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self.is_empty() {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">*</span>self <span style="color:#f92672">=</span> other;
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span>other.<span style="color:#ae81ff">0.</span>is_leaf() <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>other.<span style="color:#ae81ff">0.</span>items().is_empty() {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> self.<span style="color:#ae81ff">0.</span>height() <span style="color:#f92672">&lt;</span> other.<span style="color:#ae81ff">0.</span>height() {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">for</span> tree <span style="color:#66d9ef">in</span> other.<span style="color:#ae81ff">0.</span>child_trees() {
</span></span><span style="display:flex;"><span>                    self.append(tree.clone(), cx);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Some(split_tree) <span style="color:#f92672">=</span> self.push_tree_recursive(other, cx) {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">*</span>self <span style="color:#f92672">=</span> Self::from_child_trees(self.clone(), split_tree, cx);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// self height must &gt;= other height
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// merge two SumTree, return potentially splited new tree for next step from_child_trees function call
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">push_tree_recursive</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self,
</span></span><span style="display:flex;"><span>        other: <span style="color:#a6e22e">SumTree</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>        cx: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&lt;</span>T::Summary <span style="color:#66d9ef">as</span> Summary<span style="color:#f92672">&gt;</span>::Context,
</span></span><span style="display:flex;"><span>    ) -&gt; Option<span style="color:#f92672">&lt;</span>SumTree<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;&gt;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">match</span> Arc::make_mut(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self.<span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>            Node::Internal {
</span></span><span style="display:flex;"><span>                height,
</span></span><span style="display:flex;"><span>                summary,
</span></span><span style="display:flex;"><span>                child_summaries,
</span></span><span style="display:flex;"><span>                child_trees,
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">..</span>
</span></span><span style="display:flex;"><span>            } <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let</span> other_node <span style="color:#f92672">=</span> other.<span style="color:#ae81ff">0.</span>clone();
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;</span>T::Summary <span style="color:#66d9ef">as</span> Summary<span style="color:#f92672">&gt;</span>::add_summary(summary, other_node.summary(), cx);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let</span> height_delta <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>height <span style="color:#f92672">-</span> other_node.height();
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> summaries_to_append <span style="color:#f92672">=</span> ArrayVec::<span style="color:#f92672">&lt;</span>T::Summary, { <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">TREE_BASE</span> }<span style="color:#f92672">&gt;</span>::new();
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> trees_to_append <span style="color:#f92672">=</span> ArrayVec::<span style="color:#f92672">&lt;</span>SumTree<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span>, { <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">TREE_BASE</span> }<span style="color:#f92672">&gt;</span>::new();
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// Based on the height difference, it decides how to append the other tree:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#75715e">//  If heights are equal, it appends all child summaries and trees from the other node.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#75715e">//  If the height difference is 1 and the other node isn&#39;t underflowing, it appends the other tree as a whole.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#75715e">//  Otherwise, it recursively calls push_tree_recursive on the last child of the current node.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#75715e">// If the number of children exceeds the maximum allowed (2 TREE_BASE), it splits the node:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#75715e">//  It divides the children into two groups.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#75715e">//  It updates the current node with the left group.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#75715e">//  It returns a new splited SumTree with the right group as Some(SumTree).
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> height_delta <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>                    summaries_to_append.extend(other_node.child_summaries().iter().cloned());
</span></span><span style="display:flex;"><span>                    trees_to_append.extend(other_node.child_trees().iter().cloned());
</span></span><span style="display:flex;"><span>                } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> height_delta <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>other_node.is_underflowing() {
</span></span><span style="display:flex;"><span>                    summaries_to_append.push(other_node.summary().clone());
</span></span><span style="display:flex;"><span>                    trees_to_append.push(other)
</span></span><span style="display:flex;"><span>                } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">let</span> tree_to_append <span style="color:#f92672">=</span> child_trees
</span></span><span style="display:flex;"><span>                        .last_mut()
</span></span><span style="display:flex;"><span>                        .unwrap()
</span></span><span style="display:flex;"><span>                        .push_tree_recursive(other, cx);
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">*</span>child_summaries.last_mut().unwrap() <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>                        child_trees.last().unwrap().<span style="color:#ae81ff">0.</span>summary().clone();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Some(split_tree) <span style="color:#f92672">=</span> tree_to_append {
</span></span><span style="display:flex;"><span>                        summaries_to_append.push(split_tree.<span style="color:#ae81ff">0.</span>summary().clone());
</span></span><span style="display:flex;"><span>                        trees_to_append.push(split_tree);
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let</span> child_count <span style="color:#f92672">=</span> child_trees.len() <span style="color:#f92672">+</span> trees_to_append.len();
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> child_count <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">TREE_BASE</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">let</span> left_summaries: <span style="color:#a6e22e">ArrayVec</span><span style="color:#f92672">&lt;</span>_, { <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">TREE_BASE</span> }<span style="color:#f92672">&gt;</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">let</span> right_summaries: <span style="color:#a6e22e">ArrayVec</span><span style="color:#f92672">&lt;</span>_, { <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">TREE_BASE</span> }<span style="color:#f92672">&gt;</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">let</span> left_trees;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">let</span> right_trees;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">let</span> midpoint <span style="color:#f92672">=</span> (child_count <span style="color:#f92672">+</span> child_count <span style="color:#f92672">%</span> <span style="color:#ae81ff">2</span>) <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>                    {
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> all_summaries <span style="color:#f92672">=</span> child_summaries
</span></span><span style="display:flex;"><span>                            .iter()
</span></span><span style="display:flex;"><span>                            .chain(summaries_to_append.iter())
</span></span><span style="display:flex;"><span>                            .cloned();
</span></span><span style="display:flex;"><span>                        left_summaries <span style="color:#f92672">=</span> all_summaries.by_ref().take(midpoint).collect();
</span></span><span style="display:flex;"><span>                        right_summaries <span style="color:#f92672">=</span> all_summaries.collect();
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> all_trees <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>                            child_trees.iter().chain(trees_to_append.iter()).cloned();
</span></span><span style="display:flex;"><span>                        left_trees <span style="color:#f92672">=</span> all_trees.by_ref().take(midpoint).collect();
</span></span><span style="display:flex;"><span>                        right_trees <span style="color:#f92672">=</span> all_trees.collect();
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">*</span>summary <span style="color:#f92672">=</span> sum(left_summaries.iter(), cx);
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">*</span>child_summaries <span style="color:#f92672">=</span> left_summaries;
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">*</span>child_trees <span style="color:#f92672">=</span> left_trees;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    Some(SumTree(Arc::new(Node::Internal {
</span></span><span style="display:flex;"><span>                        height: <span style="color:#f92672">*</span>height,
</span></span><span style="display:flex;"><span>                        summary: <span style="color:#a6e22e">sum</span>(right_summaries.iter(), cx),
</span></span><span style="display:flex;"><span>                        child_summaries: <span style="color:#a6e22e">right_summaries</span>,
</span></span><span style="display:flex;"><span>                        child_trees: <span style="color:#a6e22e">right_trees</span>,
</span></span><span style="display:flex;"><span>                    })))
</span></span><span style="display:flex;"><span>                } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                    child_summaries.extend(summaries_to_append);
</span></span><span style="display:flex;"><span>                    child_trees.extend(trees_to_append);
</span></span><span style="display:flex;"><span>                    None
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            Node::Leaf {
</span></span><span style="display:flex;"><span>                summary,
</span></span><span style="display:flex;"><span>                items,
</span></span><span style="display:flex;"><span>                item_summaries,
</span></span><span style="display:flex;"><span>            } <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let</span> other_node <span style="color:#f92672">=</span> other.<span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// If the combined number of items exceeds the maximum allowed, it splits the leaf:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#75715e">// It divides the items into two groups. current leaf is left group. returns a new SumTree with the right group as Some(SumTree).
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#66d9ef">let</span> child_count <span style="color:#f92672">=</span> items.len() <span style="color:#f92672">+</span> other_node.items().len();
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> child_count <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">TREE_BASE</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">let</span> left_items;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">let</span> right_items;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">let</span> left_summaries;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">let</span> right_summaries: <span style="color:#a6e22e">ArrayVec</span><span style="color:#f92672">&lt;</span>T::Summary, { <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">TREE_BASE</span> }<span style="color:#f92672">&gt;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">let</span> midpoint <span style="color:#f92672">=</span> (child_count <span style="color:#f92672">+</span> child_count <span style="color:#f92672">%</span> <span style="color:#ae81ff">2</span>) <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>                    {
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> all_items <span style="color:#f92672">=</span> items.iter().chain(other_node.items().iter()).cloned();
</span></span><span style="display:flex;"><span>                        left_items <span style="color:#f92672">=</span> all_items.by_ref().take(midpoint).collect();
</span></span><span style="display:flex;"><span>                        right_items <span style="color:#f92672">=</span> all_items.collect();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> all_summaries <span style="color:#f92672">=</span> item_summaries
</span></span><span style="display:flex;"><span>                            .iter()
</span></span><span style="display:flex;"><span>                            .chain(other_node.child_summaries())
</span></span><span style="display:flex;"><span>                            .cloned();
</span></span><span style="display:flex;"><span>                        left_summaries <span style="color:#f92672">=</span> all_summaries.by_ref().take(midpoint).collect();
</span></span><span style="display:flex;"><span>                        right_summaries <span style="color:#f92672">=</span> all_summaries.collect();
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">*</span>items <span style="color:#f92672">=</span> left_items;
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">*</span>item_summaries <span style="color:#f92672">=</span> left_summaries;
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">*</span>summary <span style="color:#f92672">=</span> sum(item_summaries.iter(), cx);
</span></span><span style="display:flex;"><span>                    Some(SumTree(Arc::new(Node::Leaf {
</span></span><span style="display:flex;"><span>                        items: <span style="color:#a6e22e">right_items</span>,
</span></span><span style="display:flex;"><span>                        summary: <span style="color:#a6e22e">sum</span>(right_summaries.iter(), cx),
</span></span><span style="display:flex;"><span>                        item_summaries: <span style="color:#a6e22e">right_summaries</span>,
</span></span><span style="display:flex;"><span>                    })))
</span></span><span style="display:flex;"><span>                } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;</span>T::Summary <span style="color:#66d9ef">as</span> Summary<span style="color:#f92672">&gt;</span>::add_summary(summary, other_node.summary(), cx);
</span></span><span style="display:flex;"><span>                    items.extend(other_node.items().iter().cloned());
</span></span><span style="display:flex;"><span>                    item_summaries.extend(other_node.child_summaries().iter().cloned());
</span></span><span style="display:flex;"><span>                    None
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// merge two child trees into a parent tree
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">from_child_trees</span>(
</span></span><span style="display:flex;"><span>        left: <span style="color:#a6e22e">SumTree</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>        right: <span style="color:#a6e22e">SumTree</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>        cx: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&lt;</span>T::Summary <span style="color:#66d9ef">as</span> Summary<span style="color:#f92672">&gt;</span>::Context,
</span></span><span style="display:flex;"><span>    ) -&gt; <span style="color:#a6e22e">Self</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> height <span style="color:#f92672">=</span> left.<span style="color:#ae81ff">0.</span>height() <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> child_summaries <span style="color:#f92672">=</span> ArrayVec::new();
</span></span><span style="display:flex;"><span>        child_summaries.push(left.<span style="color:#ae81ff">0.</span>summary().clone());
</span></span><span style="display:flex;"><span>        child_summaries.push(right.<span style="color:#ae81ff">0.</span>summary().clone());
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> child_trees <span style="color:#f92672">=</span> ArrayVec::new();
</span></span><span style="display:flex;"><span>        child_trees.push(left);
</span></span><span style="display:flex;"><span>        child_trees.push(right);
</span></span><span style="display:flex;"><span>        SumTree(Arc::new(Node::Internal {
</span></span><span style="display:flex;"><span>            height,
</span></span><span style="display:flex;"><span>            summary: <span style="color:#a6e22e">sum</span>(child_summaries.iter(), cx),
</span></span><span style="display:flex;"><span>            child_summaries,
</span></span><span style="display:flex;"><span>            child_trees,
</span></span><span style="display:flex;"><span>        }))
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// return leftmost leaf SumTree
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">leftmost_leaf</span>(<span style="color:#f92672">&amp;</span>self) -&gt; <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">Self</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">match</span> <span style="color:#f92672">*</span>self.<span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>            Node::Leaf { <span style="color:#f92672">..</span> } <span style="color:#f92672">=&gt;</span> self,
</span></span><span style="display:flex;"><span>            Node::Internal {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">ref</span> child_trees, <span style="color:#f92672">..</span>
</span></span><span style="display:flex;"><span>            } <span style="color:#f92672">=&gt;</span> child_trees.first().unwrap().leftmost_leaf(),
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// return rightmost leaf SumTree
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">rightmost_leaf</span>(<span style="color:#f92672">&amp;</span>self) -&gt; <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">Self</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">match</span> <span style="color:#f92672">*</span>self.<span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>            Node::Leaf { <span style="color:#f92672">..</span> } <span style="color:#f92672">=&gt;</span> self,
</span></span><span style="display:flex;"><span>            Node::Internal {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">ref</span> child_trees, <span style="color:#f92672">..</span>
</span></span><span style="display:flex;"><span>            } <span style="color:#f92672">=&gt;</span> child_trees.last().unwrap().rightmost_leaf(),
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#[cfg(debug_assertions)]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">_debug_entries</span>(<span style="color:#f92672">&amp;</span>self) -&gt; Vec<span style="color:#f92672">&lt;&amp;</span>T<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>        self.iter().collect::<span style="color:#f92672">&lt;</span>Vec<span style="color:#f92672">&lt;</span>_<span style="color:#f92672">&gt;&gt;</span>()
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span><span style="color:#f92672">&lt;</span>T: <span style="color:#a6e22e">Item</span> <span style="color:#f92672">+</span> PartialEq<span style="color:#f92672">&gt;</span> PartialEq <span style="color:#66d9ef">for</span> SumTree<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">eq</span>(<span style="color:#f92672">&amp;</span>self, other: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">Self</span>) -&gt; <span style="color:#66d9ef">bool</span> {
</span></span><span style="display:flex;"><span>        self.iter().eq(other.iter())
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span><span style="color:#f92672">&lt;</span>T: <span style="color:#a6e22e">Item</span> <span style="color:#f92672">+</span> Eq<span style="color:#f92672">&gt;</span> Eq <span style="color:#66d9ef">for</span> SumTree<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span><span style="color:#f92672">&lt;</span>T: <span style="color:#a6e22e">KeyedItem</span><span style="color:#f92672">&gt;</span> SumTree<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// insert or replace item
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">insert_or_replace</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self,
</span></span><span style="display:flex;"><span>        item: <span style="color:#a6e22e">T</span>,
</span></span><span style="display:flex;"><span>        cx: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&lt;</span>T::Summary <span style="color:#66d9ef">as</span> Summary<span style="color:#f92672">&gt;</span>::Context,
</span></span><span style="display:flex;"><span>    ) -&gt; Option<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> replaced <span style="color:#f92672">=</span> None;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">*</span>self <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> cursor <span style="color:#f92672">=</span> self.cursor::<span style="color:#f92672">&lt;</span>T::Key<span style="color:#f92672">&gt;</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> new_tree <span style="color:#f92672">=</span> cursor.slice(<span style="color:#f92672">&amp;</span>item.key(), Bias::Left, cx);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Some(cursor_item) <span style="color:#f92672">=</span> cursor.item() {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> cursor_item.key() <span style="color:#f92672">==</span> item.key() {
</span></span><span style="display:flex;"><span>                    replaced <span style="color:#f92672">=</span> Some(cursor_item.clone());
</span></span><span style="display:flex;"><span>                    cursor.next(cx);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            new_tree.push(item, cx);
</span></span><span style="display:flex;"><span>            new_tree.append(cursor.suffix(cx), cx);
</span></span><span style="display:flex;"><span>            new_tree
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>        replaced
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// remove item
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">remove</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, key: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">T</span>::Key, cx: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&lt;</span>T::Summary <span style="color:#66d9ef">as</span> Summary<span style="color:#f92672">&gt;</span>::Context) -&gt; Option<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> removed <span style="color:#f92672">=</span> None;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">*</span>self <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> cursor <span style="color:#f92672">=</span> self.cursor::<span style="color:#f92672">&lt;</span>T::Key<span style="color:#f92672">&gt;</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> new_tree <span style="color:#f92672">=</span> cursor.slice(key, Bias::Left, cx);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Some(item) <span style="color:#f92672">=</span> cursor.item() {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> item.key() <span style="color:#f92672">==</span> <span style="color:#f92672">*</span>key {
</span></span><span style="display:flex;"><span>                    removed <span style="color:#f92672">=</span> Some(item.clone());
</span></span><span style="display:flex;"><span>                    cursor.next(cx);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            new_tree.append(cursor.suffix(cx), cx);
</span></span><span style="display:flex;"><span>            new_tree
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>        removed
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// edit SumTree with order for efficiency. return removed items
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">edit</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">mut</span> edits: Vec<span style="color:#f92672">&lt;</span>Edit<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;&gt;</span>,
</span></span><span style="display:flex;"><span>        cx: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&lt;</span>T::Summary <span style="color:#66d9ef">as</span> Summary<span style="color:#f92672">&gt;</span>::Context,
</span></span><span style="display:flex;"><span>    ) -&gt; Vec<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> edits.is_empty() {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> Vec::new();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> removed <span style="color:#f92672">=</span> Vec::new();
</span></span><span style="display:flex;"><span>        edits.sort_unstable_by_key(<span style="color:#f92672">|</span>item<span style="color:#f92672">|</span> item.key());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">*</span>self <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> cursor <span style="color:#f92672">=</span> self.cursor::<span style="color:#f92672">&lt;</span>T::Key<span style="color:#f92672">&gt;</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> new_tree <span style="color:#f92672">=</span> SumTree::new();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> buffered_items <span style="color:#f92672">=</span> Vec::new();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            cursor.seek(<span style="color:#f92672">&amp;</span>T::Key::default(), Bias::Left, cx);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> edit <span style="color:#66d9ef">in</span> edits {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let</span> new_key <span style="color:#f92672">=</span> edit.key();
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> old_item <span style="color:#f92672">=</span> cursor.item();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> old_item
</span></span><span style="display:flex;"><span>                    .as_ref()
</span></span><span style="display:flex;"><span>                    .map_or(<span style="color:#66d9ef">false</span>, <span style="color:#f92672">|</span>old_item<span style="color:#f92672">|</span> old_item.key() <span style="color:#f92672">&lt;</span> new_key)
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    new_tree.extend(buffered_items.drain(<span style="color:#f92672">..</span>), cx);
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">let</span> slice <span style="color:#f92672">=</span> cursor.slice(<span style="color:#f92672">&amp;</span>new_key, Bias::Left, cx);
</span></span><span style="display:flex;"><span>                    new_tree.append(slice, cx);
</span></span><span style="display:flex;"><span>                    old_item <span style="color:#f92672">=</span> cursor.item();
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Some(old_item) <span style="color:#f92672">=</span> old_item {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> old_item.key() <span style="color:#f92672">==</span> new_key {
</span></span><span style="display:flex;"><span>                        removed.push(old_item.clone());
</span></span><span style="display:flex;"><span>                        cursor.next(cx);
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">match</span> edit {
</span></span><span style="display:flex;"><span>                    Edit::Insert(item) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>                        buffered_items.push(item);
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    Edit::Remove(_) <span style="color:#f92672">=&gt;</span> {}
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            new_tree.extend(buffered_items, cx);
</span></span><span style="display:flex;"><span>            new_tree.append(cursor.suffix(cx), cx);
</span></span><span style="display:flex;"><span>            new_tree
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        removed
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// get item of key
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">get</span>(<span style="color:#f92672">&amp;</span>self, key: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">T</span>::Key, cx: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&lt;</span>T::Summary <span style="color:#66d9ef">as</span> Summary<span style="color:#f92672">&gt;</span>::Context) -&gt; Option<span style="color:#f92672">&lt;&amp;</span>T<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> cursor <span style="color:#f92672">=</span> self.cursor::<span style="color:#f92672">&lt;</span>T::Key<span style="color:#f92672">&gt;</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> cursor.seek(key, Bias::Left, cx) {
</span></span><span style="display:flex;"><span>            cursor.item()
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            None
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span><span style="color:#f92672">&lt;</span>T: <span style="color:#a6e22e">Item</span><span style="color:#f92672">&gt;</span> Default <span style="color:#66d9ef">for</span> SumTree<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">default</span>() -&gt; <span style="color:#a6e22e">Self</span> {
</span></span><span style="display:flex;"><span>        Self::new()
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#[derive(Clone, Debug)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">enum</span> <span style="color:#a6e22e">Node</span><span style="color:#f92672">&lt;</span>T: <span style="color:#a6e22e">Item</span><span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    Internal {
</span></span><span style="display:flex;"><span>        height: <span style="color:#66d9ef">u8</span>,
</span></span><span style="display:flex;"><span>        summary: <span style="color:#a6e22e">T</span>::Summary,
</span></span><span style="display:flex;"><span>        child_summaries: <span style="color:#a6e22e">ArrayVec</span><span style="color:#f92672">&lt;</span>T::Summary, { <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">TREE_BASE</span> }<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>        child_trees: <span style="color:#a6e22e">ArrayVec</span><span style="color:#f92672">&lt;</span>SumTree<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span>, { <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">TREE_BASE</span> }<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    Leaf {
</span></span><span style="display:flex;"><span>        summary: <span style="color:#a6e22e">T</span>::Summary,
</span></span><span style="display:flex;"><span>        items: <span style="color:#a6e22e">ArrayVec</span><span style="color:#f92672">&lt;</span>T, { <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">TREE_BASE</span> }<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>        item_summaries: <span style="color:#a6e22e">ArrayVec</span><span style="color:#f92672">&lt;</span>T::Summary, { <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">TREE_BASE</span> }<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span><span style="color:#f92672">&lt;</span>T: <span style="color:#a6e22e">Item</span><span style="color:#f92672">&gt;</span> Node<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">is_leaf</span>(<span style="color:#f92672">&amp;</span>self) -&gt; <span style="color:#66d9ef">bool</span> {
</span></span><span style="display:flex;"><span>        matches!(self, Node::Leaf { <span style="color:#f92672">..</span> })
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">height</span>(<span style="color:#f92672">&amp;</span>self) -&gt; <span style="color:#66d9ef">u8</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">match</span> self {
</span></span><span style="display:flex;"><span>            Node::Internal { height, <span style="color:#f92672">..</span> } <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">*</span>height,
</span></span><span style="display:flex;"><span>            Node::Leaf { <span style="color:#f92672">..</span> } <span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">summary</span>(<span style="color:#f92672">&amp;</span>self) -&gt; <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">T</span>::Summary {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">match</span> self {
</span></span><span style="display:flex;"><span>            Node::Internal { summary, <span style="color:#f92672">..</span> } <span style="color:#f92672">=&gt;</span> summary,
</span></span><span style="display:flex;"><span>            Node::Leaf { summary, <span style="color:#f92672">..</span> } <span style="color:#f92672">=&gt;</span> summary,
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">child_summaries</span>(<span style="color:#f92672">&amp;</span>self) -&gt; <span style="color:#66d9ef">&amp;</span>[T::Summary] {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">match</span> self {
</span></span><span style="display:flex;"><span>            Node::Internal {
</span></span><span style="display:flex;"><span>                child_summaries, <span style="color:#f92672">..</span>
</span></span><span style="display:flex;"><span>            } <span style="color:#f92672">=&gt;</span> child_summaries.as_slice(),
</span></span><span style="display:flex;"><span>            Node::Leaf { item_summaries, <span style="color:#f92672">..</span> } <span style="color:#f92672">=&gt;</span> item_summaries.as_slice(),
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// return child trees of curr node
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">child_trees</span>(<span style="color:#f92672">&amp;</span>self) -&gt; <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">ArrayVec</span><span style="color:#f92672">&lt;</span>SumTree<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span>, { <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">TREE_BASE</span> }<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">match</span> self {
</span></span><span style="display:flex;"><span>            Node::Internal { child_trees, <span style="color:#f92672">..</span> } <span style="color:#f92672">=&gt;</span> child_trees,
</span></span><span style="display:flex;"><span>            Node::Leaf { <span style="color:#f92672">..</span> } <span style="color:#f92672">=&gt;</span> panic!(<span style="color:#e6db74">&#34;Leaf nodes have no child trees&#34;</span>),
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// return items of curr leaf node
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">items</span>(<span style="color:#f92672">&amp;</span>self) -&gt; <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">ArrayVec</span><span style="color:#f92672">&lt;</span>T, { <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">TREE_BASE</span> }<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">match</span> self {
</span></span><span style="display:flex;"><span>            Node::Leaf { items, <span style="color:#f92672">..</span> } <span style="color:#f92672">=&gt;</span> items,
</span></span><span style="display:flex;"><span>            Node::Internal { <span style="color:#f92672">..</span> } <span style="color:#f92672">=&gt;</span> panic!(<span style="color:#e6db74">&#34;Internal nodes have no items&#34;</span>),
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// whether child num is less than TREE_BASE
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">is_underflowing</span>(<span style="color:#f92672">&amp;</span>self) -&gt; <span style="color:#66d9ef">bool</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">match</span> self {
</span></span><span style="display:flex;"><span>            Node::Internal { child_trees, <span style="color:#f92672">..</span> } <span style="color:#f92672">=&gt;</span> child_trees.len() <span style="color:#f92672">&lt;</span> <span style="color:#66d9ef">TREE_BASE</span>,
</span></span><span style="display:flex;"><span>            Node::Leaf { items, <span style="color:#f92672">..</span> } <span style="color:#f92672">=&gt;</span> items.len() <span style="color:#f92672">&lt;</span> <span style="color:#66d9ef">TREE_BASE</span>,
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#[derive(Debug)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">enum</span> <span style="color:#a6e22e">Edit</span><span style="color:#f92672">&lt;</span>T: <span style="color:#a6e22e">KeyedItem</span><span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    Insert(T),
</span></span><span style="display:flex;"><span>    Remove(T::Key),
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span><span style="color:#f92672">&lt;</span>T: <span style="color:#a6e22e">KeyedItem</span><span style="color:#f92672">&gt;</span> Edit<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">key</span>(<span style="color:#f92672">&amp;</span>self) -&gt; <span style="color:#a6e22e">T</span>::Key {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">match</span> self {
</span></span><span style="display:flex;"><span>            Edit::Insert(item) <span style="color:#f92672">=&gt;</span> item.key(),
</span></span><span style="display:flex;"><span>            Edit::Remove(key) <span style="color:#f92672">=&gt;</span> key.clone(),
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// return whole Summary of the item iterator
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">sum</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, T, I<span style="color:#f92672">&gt;</span>(iter: <span style="color:#a6e22e">I</span>, cx: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">T</span>::Context) -&gt; <span style="color:#a6e22e">T</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span>
</span></span><span style="display:flex;"><span>    T: <span style="color:#a6e22e">&#39;a</span> <span style="color:#f92672">+</span> Summary,
</span></span><span style="display:flex;"><span>    I: Iterator<span style="color:#f92672">&lt;</span>Item <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">&#39;a</span> T<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> sum <span style="color:#f92672">=</span> T::default();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> value <span style="color:#66d9ef">in</span> iter {
</span></span><span style="display:flex;"><span>        sum.add_summary(value, cx);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    sum
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#[cfg(test)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">mod</span> tests {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">use</span> <span style="color:#66d9ef">super</span>::<span style="color:#f92672">*</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">use</span> rand::{distributions, prelude::<span style="color:#f92672">*</span>};
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">use</span> std::cmp;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#[ctor::ctor]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">init_logger</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> std::env::var(<span style="color:#e6db74">&#34;RUST_LOG&#34;</span>).is_ok() {
</span></span><span style="display:flex;"><span>            env_logger::init();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#[test]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">test_extend_and_push_tree</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> tree1 <span style="color:#f92672">=</span> SumTree::new();
</span></span><span style="display:flex;"><span>        tree1.extend(<span style="color:#ae81ff">0</span><span style="color:#f92672">..</span><span style="color:#ae81ff">20</span>, <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> tree2 <span style="color:#f92672">=</span> SumTree::new();
</span></span><span style="display:flex;"><span>        tree2.extend(<span style="color:#ae81ff">50</span><span style="color:#f92672">..</span><span style="color:#ae81ff">100</span>, <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        tree1.append(tree2, <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        assert_eq!(
</span></span><span style="display:flex;"><span>            tree1.items(<span style="color:#f92672">&amp;</span>()),
</span></span><span style="display:flex;"><span>            (<span style="color:#ae81ff">0</span><span style="color:#f92672">..</span><span style="color:#ae81ff">20</span>).chain(<span style="color:#ae81ff">50</span><span style="color:#f92672">..</span><span style="color:#ae81ff">100</span>).collect::<span style="color:#f92672">&lt;</span>Vec<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">u8</span><span style="color:#f92672">&gt;&gt;</span>()
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#[test]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">test_random</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> starting_seed <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Ok(value) <span style="color:#f92672">=</span> std::env::var(<span style="color:#e6db74">&#34;SEED&#34;</span>) {
</span></span><span style="display:flex;"><span>            starting_seed <span style="color:#f92672">=</span> value.parse().expect(<span style="color:#e6db74">&#34;invalid SEED variable&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> num_iterations <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Ok(value) <span style="color:#f92672">=</span> std::env::var(<span style="color:#e6db74">&#34;ITERATIONS&#34;</span>) {
</span></span><span style="display:flex;"><span>            num_iterations <span style="color:#f92672">=</span> value.parse().expect(<span style="color:#e6db74">&#34;invalid ITERATIONS variable&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> num_operations <span style="color:#f92672">=</span> std::env::var(<span style="color:#e6db74">&#34;OPERATIONS&#34;</span>)
</span></span><span style="display:flex;"><span>            .map_or(<span style="color:#ae81ff">5</span>, <span style="color:#f92672">|</span>o<span style="color:#f92672">|</span> o.parse().expect(<span style="color:#e6db74">&#34;invalid OPERATIONS variable&#34;</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> seed <span style="color:#66d9ef">in</span> starting_seed<span style="color:#f92672">..</span>(starting_seed <span style="color:#f92672">+</span> num_iterations) {
</span></span><span style="display:flex;"><span>            eprintln!(<span style="color:#e6db74">&#34;seed = </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span>, seed);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> rng <span style="color:#f92672">=</span> StdRng::seed_from_u64(seed);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> rng <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> rng;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> tree <span style="color:#f92672">=</span> SumTree::<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">u8</span><span style="color:#f92672">&gt;</span>::new();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> count <span style="color:#f92672">=</span> rng.gen_range(<span style="color:#ae81ff">0</span><span style="color:#f92672">..</span><span style="color:#ae81ff">10</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> rng.gen() {
</span></span><span style="display:flex;"><span>                tree.extend(rng.sample_iter(distributions::Standard).take(count), <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let</span> items <span style="color:#f92672">=</span> rng
</span></span><span style="display:flex;"><span>                    .sample_iter(distributions::Standard)
</span></span><span style="display:flex;"><span>                    .take(count)
</span></span><span style="display:flex;"><span>                    .collect::<span style="color:#f92672">&lt;</span>Vec<span style="color:#f92672">&lt;</span>_<span style="color:#f92672">&gt;&gt;</span>();
</span></span><span style="display:flex;"><span>                tree.par_extend(items, <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> _ <span style="color:#66d9ef">in</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">..</span>num_operations {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let</span> splice_end <span style="color:#f92672">=</span> rng.gen_range(<span style="color:#ae81ff">0</span><span style="color:#f92672">..</span>tree.extent::<span style="color:#f92672">&lt;</span>Count<span style="color:#f92672">&gt;</span>(<span style="color:#f92672">&amp;</span>()).<span style="color:#ae81ff">0</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let</span> splice_start <span style="color:#f92672">=</span> rng.gen_range(<span style="color:#ae81ff">0</span><span style="color:#f92672">..</span>splice_end <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let</span> count <span style="color:#f92672">=</span> rng.gen_range(<span style="color:#ae81ff">0</span><span style="color:#f92672">..</span><span style="color:#ae81ff">10</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let</span> tree_end <span style="color:#f92672">=</span> tree.extent::<span style="color:#f92672">&lt;</span>Count<span style="color:#f92672">&gt;</span>(<span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let</span> new_items <span style="color:#f92672">=</span> rng
</span></span><span style="display:flex;"><span>                    .sample_iter(distributions::Standard)
</span></span><span style="display:flex;"><span>                    .take(count)
</span></span><span style="display:flex;"><span>                    .collect::<span style="color:#f92672">&lt;</span>Vec<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">u8</span><span style="color:#f92672">&gt;&gt;</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> reference_items <span style="color:#f92672">=</span> tree.items(<span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>                reference_items.splice(splice_start<span style="color:#f92672">..</span>splice_end, new_items.clone());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                tree <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> cursor <span style="color:#f92672">=</span> tree.cursor::<span style="color:#f92672">&lt;</span>Count<span style="color:#f92672">&gt;</span>();
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> new_tree <span style="color:#f92672">=</span> cursor.slice(<span style="color:#f92672">&amp;</span>Count(splice_start), Bias::Right, <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> rng.gen() {
</span></span><span style="display:flex;"><span>                        new_tree.extend(new_items, <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>                    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                        new_tree.par_extend(new_items, <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    cursor.seek(<span style="color:#f92672">&amp;</span>Count(splice_end), Bias::Right, <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>                    new_tree.append(cursor.slice(<span style="color:#f92672">&amp;</span>tree_end, Bias::Right, <span style="color:#f92672">&amp;</span>()), <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>                    new_tree
</span></span><span style="display:flex;"><span>                };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                assert_eq!(tree.items(<span style="color:#f92672">&amp;</span>()), reference_items);
</span></span><span style="display:flex;"><span>                assert_eq!(
</span></span><span style="display:flex;"><span>                    tree.iter().collect::<span style="color:#f92672">&lt;</span>Vec<span style="color:#f92672">&lt;</span>_<span style="color:#f92672">&gt;&gt;</span>(),
</span></span><span style="display:flex;"><span>                    tree.cursor::<span style="color:#f92672">&lt;</span>()<span style="color:#f92672">&gt;</span>().collect::<span style="color:#f92672">&lt;</span>Vec<span style="color:#f92672">&lt;</span>_<span style="color:#f92672">&gt;&gt;</span>()
</span></span><span style="display:flex;"><span>                );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                log::info!(<span style="color:#e6db74">&#34;tree items: {:?}&#34;</span>, tree.items(<span style="color:#f92672">&amp;</span>()));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> filter_cursor <span style="color:#f92672">=</span> tree.filter::<span style="color:#f92672">&lt;</span>_, Count<span style="color:#f92672">&gt;</span>(<span style="color:#f92672">|</span>summary<span style="color:#f92672">|</span> summary.contains_even);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let</span> expected_filtered_items <span style="color:#f92672">=</span> tree
</span></span><span style="display:flex;"><span>                    .items(<span style="color:#f92672">&amp;</span>())
</span></span><span style="display:flex;"><span>                    .into_iter()
</span></span><span style="display:flex;"><span>                    .enumerate()
</span></span><span style="display:flex;"><span>                    .filter(<span style="color:#f92672">|</span>(_, item)<span style="color:#f92672">|</span> (item <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>                    .collect::<span style="color:#f92672">&lt;</span>Vec<span style="color:#f92672">&lt;</span>_<span style="color:#f92672">&gt;&gt;</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> item_ix <span style="color:#f92672">=</span> <span style="color:#66d9ef">if</span> rng.gen() {
</span></span><span style="display:flex;"><span>                    filter_cursor.next(<span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>                    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>                } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                    filter_cursor.prev(<span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>                    expected_filtered_items.len().saturating_sub(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>                };
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">while</span> item_ix <span style="color:#f92672">&lt;</span> expected_filtered_items.len() {
</span></span><span style="display:flex;"><span>                    log::info!(<span style="color:#e6db74">&#34;filter_cursor, item_ix: {}&#34;</span>, item_ix);
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">let</span> actual_item <span style="color:#f92672">=</span> filter_cursor.item().unwrap();
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">let</span> (reference_index, reference_item) <span style="color:#f92672">=</span> expected_filtered_items[item_ix];
</span></span><span style="display:flex;"><span>                    assert_eq!(actual_item, <span style="color:#f92672">&amp;</span>reference_item);
</span></span><span style="display:flex;"><span>                    assert_eq!(filter_cursor.start().<span style="color:#ae81ff">0</span>, reference_index);
</span></span><span style="display:flex;"><span>                    log::info!(<span style="color:#e6db74">&#34;next&#34;</span>);
</span></span><span style="display:flex;"><span>                    filter_cursor.next(<span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>                    item_ix <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">while</span> item_ix <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> rng.gen_bool(<span style="color:#ae81ff">0.2</span>) {
</span></span><span style="display:flex;"><span>                        log::info!(<span style="color:#e6db74">&#34;prev&#34;</span>);
</span></span><span style="display:flex;"><span>                        filter_cursor.prev(<span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>                        item_ix <span style="color:#f92672">-=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">if</span> item_ix <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> rng.gen_bool(<span style="color:#ae81ff">0.2</span>) {
</span></span><span style="display:flex;"><span>                            filter_cursor.prev(<span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>                            assert_eq!(filter_cursor.item(), None);
</span></span><span style="display:flex;"><span>                            assert_eq!(filter_cursor.start().<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>                            filter_cursor.next(<span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                assert_eq!(filter_cursor.item(), None);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> before_start <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> cursor <span style="color:#f92672">=</span> tree.cursor::<span style="color:#f92672">&lt;</span>Count<span style="color:#f92672">&gt;</span>();
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let</span> start_pos <span style="color:#f92672">=</span> rng.gen_range(<span style="color:#ae81ff">0</span><span style="color:#f92672">..=</span>reference_items.len());
</span></span><span style="display:flex;"><span>                cursor.seek(<span style="color:#f92672">&amp;</span>Count(start_pos), Bias::Right, <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> pos <span style="color:#f92672">=</span> rng.gen_range(start_pos<span style="color:#f92672">..=</span>reference_items.len());
</span></span><span style="display:flex;"><span>                cursor.seek_forward(<span style="color:#f92672">&amp;</span>Count(pos), Bias::Right, <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">for</span> i <span style="color:#66d9ef">in</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">..</span><span style="color:#ae81ff">10</span> {
</span></span><span style="display:flex;"><span>                    assert_eq!(cursor.start().<span style="color:#ae81ff">0</span>, pos);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> pos <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>                        assert_eq!(cursor.prev_item().unwrap(), <span style="color:#f92672">&amp;</span>reference_items[pos <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span>                    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                        assert_eq!(cursor.prev_item(), None);
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> pos <span style="color:#f92672">&lt;</span> reference_items.len() <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>before_start {
</span></span><span style="display:flex;"><span>                        assert_eq!(cursor.item().unwrap(), <span style="color:#f92672">&amp;</span>reference_items[pos]);
</span></span><span style="display:flex;"><span>                    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                        assert_eq!(cursor.item(), None);
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> before_start {
</span></span><span style="display:flex;"><span>                        assert_eq!(cursor.next_item(), reference_items.get(<span style="color:#ae81ff">0</span>));
</span></span><span style="display:flex;"><span>                    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> pos <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;</span> reference_items.len() {
</span></span><span style="display:flex;"><span>                        assert_eq!(cursor.next_item().unwrap(), <span style="color:#f92672">&amp;</span>reference_items[pos <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span>                    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                        assert_eq!(cursor.next_item(), None);
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">5</span> {
</span></span><span style="display:flex;"><span>                        cursor.next(<span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">if</span> pos <span style="color:#f92672">&lt;</span> reference_items.len() {
</span></span><span style="display:flex;"><span>                            pos <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                            before_start <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                        cursor.prev(<span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">if</span> pos <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>                            before_start <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                        pos <span style="color:#f92672">=</span> pos.saturating_sub(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> _ <span style="color:#66d9ef">in</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">..</span><span style="color:#ae81ff">10</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let</span> end <span style="color:#f92672">=</span> rng.gen_range(<span style="color:#ae81ff">0</span><span style="color:#f92672">..</span>tree.extent::<span style="color:#f92672">&lt;</span>Count<span style="color:#f92672">&gt;</span>(<span style="color:#f92672">&amp;</span>()).<span style="color:#ae81ff">0</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let</span> start <span style="color:#f92672">=</span> rng.gen_range(<span style="color:#ae81ff">0</span><span style="color:#f92672">..</span>end <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let</span> start_bias <span style="color:#f92672">=</span> <span style="color:#66d9ef">if</span> rng.gen() { Bias::Left } <span style="color:#66d9ef">else</span> { Bias::Right };
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let</span> end_bias <span style="color:#f92672">=</span> <span style="color:#66d9ef">if</span> rng.gen() { Bias::Left } <span style="color:#66d9ef">else</span> { Bias::Right };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> cursor <span style="color:#f92672">=</span> tree.cursor::<span style="color:#f92672">&lt;</span>Count<span style="color:#f92672">&gt;</span>();
</span></span><span style="display:flex;"><span>                cursor.seek(<span style="color:#f92672">&amp;</span>Count(start), start_bias, <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let</span> slice <span style="color:#f92672">=</span> cursor.slice(<span style="color:#f92672">&amp;</span>Count(end), end_bias, <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                cursor.seek(<span style="color:#f92672">&amp;</span>Count(start), start_bias, <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let</span> summary <span style="color:#f92672">=</span> cursor.summary::<span style="color:#f92672">&lt;</span>_, Sum<span style="color:#f92672">&gt;</span>(<span style="color:#f92672">&amp;</span>Count(end), end_bias, <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                assert_eq!(summary.<span style="color:#ae81ff">0</span>, slice.summary().sum);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#[test]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">test_cursor</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Empty tree
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">let</span> tree <span style="color:#f92672">=</span> SumTree::<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">u8</span><span style="color:#f92672">&gt;</span>::new();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> cursor <span style="color:#f92672">=</span> tree.cursor::<span style="color:#f92672">&lt;</span>IntegersSummary<span style="color:#f92672">&gt;</span>();
</span></span><span style="display:flex;"><span>        assert_eq!(
</span></span><span style="display:flex;"><span>            cursor.slice(<span style="color:#f92672">&amp;</span>Count(<span style="color:#ae81ff">0</span>), Bias::Right, <span style="color:#f92672">&amp;</span>()).items(<span style="color:#f92672">&amp;</span>()),
</span></span><span style="display:flex;"><span>            Vec::<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">u8</span><span style="color:#f92672">&gt;</span>::new()
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.item(), None);
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.prev_item(), None);
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.next_item(), None);
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.start().sum, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>        cursor.prev(<span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.item(), None);
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.prev_item(), None);
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.next_item(), None);
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.start().sum, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>        cursor.next(<span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.item(), None);
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.prev_item(), None);
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.next_item(), None);
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.start().sum, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Single-element tree
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> tree <span style="color:#f92672">=</span> SumTree::<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">u8</span><span style="color:#f92672">&gt;</span>::new();
</span></span><span style="display:flex;"><span>        tree.extend(vec![<span style="color:#ae81ff">1</span>], <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> cursor <span style="color:#f92672">=</span> tree.cursor::<span style="color:#f92672">&lt;</span>IntegersSummary<span style="color:#f92672">&gt;</span>();
</span></span><span style="display:flex;"><span>        assert_eq!(
</span></span><span style="display:flex;"><span>            cursor.slice(<span style="color:#f92672">&amp;</span>Count(<span style="color:#ae81ff">0</span>), Bias::Right, <span style="color:#f92672">&amp;</span>()).items(<span style="color:#f92672">&amp;</span>()),
</span></span><span style="display:flex;"><span>            Vec::<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">u8</span><span style="color:#f92672">&gt;</span>::new()
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.item(), Some(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">1</span>));
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.prev_item(), None);
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.next_item(), None);
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.start().sum, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        cursor.next(<span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.item(), None);
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.prev_item(), Some(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">1</span>));
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.next_item(), None);
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.start().sum, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        cursor.prev(<span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.item(), Some(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">1</span>));
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.prev_item(), None);
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.next_item(), None);
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.start().sum, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> cursor <span style="color:#f92672">=</span> tree.cursor::<span style="color:#f92672">&lt;</span>IntegersSummary<span style="color:#f92672">&gt;</span>();
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.slice(<span style="color:#f92672">&amp;</span>Count(<span style="color:#ae81ff">1</span>), Bias::Right, <span style="color:#f92672">&amp;</span>()).items(<span style="color:#f92672">&amp;</span>()), [<span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.item(), None);
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.prev_item(), Some(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">1</span>));
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.next_item(), None);
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.start().sum, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        cursor.seek(<span style="color:#f92672">&amp;</span>Count(<span style="color:#ae81ff">0</span>), Bias::Right, <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        assert_eq!(
</span></span><span style="display:flex;"><span>            cursor
</span></span><span style="display:flex;"><span>                .slice(<span style="color:#f92672">&amp;</span>tree.extent::<span style="color:#f92672">&lt;</span>Count<span style="color:#f92672">&gt;</span>(<span style="color:#f92672">&amp;</span>()), Bias::Right, <span style="color:#f92672">&amp;</span>())
</span></span><span style="display:flex;"><span>                .items(<span style="color:#f92672">&amp;</span>()),
</span></span><span style="display:flex;"><span>            [<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.item(), None);
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.prev_item(), Some(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">1</span>));
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.next_item(), None);
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.start().sum, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Multiple-element tree
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> tree <span style="color:#f92672">=</span> SumTree::new();
</span></span><span style="display:flex;"><span>        tree.extend(vec![<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">6</span>], <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> cursor <span style="color:#f92672">=</span> tree.cursor::<span style="color:#f92672">&lt;</span>IntegersSummary<span style="color:#f92672">&gt;</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.slice(<span style="color:#f92672">&amp;</span>Count(<span style="color:#ae81ff">2</span>), Bias::Right, <span style="color:#f92672">&amp;</span>()).items(<span style="color:#f92672">&amp;</span>()), [<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>]);
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.item(), Some(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">3</span>));
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.prev_item(), Some(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">2</span>));
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.next_item(), Some(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">4</span>));
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.start().sum, <span style="color:#ae81ff">3</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        cursor.next(<span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.item(), Some(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">4</span>));
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.prev_item(), Some(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">3</span>));
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.next_item(), Some(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">5</span>));
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.start().sum, <span style="color:#ae81ff">6</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        cursor.next(<span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.item(), Some(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">5</span>));
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.prev_item(), Some(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">4</span>));
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.next_item(), Some(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">6</span>));
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.start().sum, <span style="color:#ae81ff">10</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        cursor.next(<span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.item(), Some(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">6</span>));
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.prev_item(), Some(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">5</span>));
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.next_item(), None);
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.start().sum, <span style="color:#ae81ff">15</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        cursor.next(<span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        cursor.next(<span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.item(), None);
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.prev_item(), Some(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">6</span>));
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.next_item(), None);
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.start().sum, <span style="color:#ae81ff">21</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        cursor.prev(<span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.item(), Some(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">6</span>));
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.prev_item(), Some(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">5</span>));
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.next_item(), None);
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.start().sum, <span style="color:#ae81ff">15</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        cursor.prev(<span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.item(), Some(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">5</span>));
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.prev_item(), Some(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">4</span>));
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.next_item(), Some(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">6</span>));
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.start().sum, <span style="color:#ae81ff">10</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        cursor.prev(<span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.item(), Some(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">4</span>));
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.prev_item(), Some(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">3</span>));
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.next_item(), Some(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">5</span>));
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.start().sum, <span style="color:#ae81ff">6</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        cursor.prev(<span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.item(), Some(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">3</span>));
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.prev_item(), Some(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">2</span>));
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.next_item(), Some(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">4</span>));
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.start().sum, <span style="color:#ae81ff">3</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        cursor.prev(<span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.item(), Some(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">2</span>));
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.prev_item(), Some(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">1</span>));
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.next_item(), Some(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">3</span>));
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.start().sum, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        cursor.prev(<span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.item(), Some(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">1</span>));
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.prev_item(), None);
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.next_item(), Some(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">2</span>));
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.start().sum, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        cursor.prev(<span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.item(), None);
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.prev_item(), None);
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.next_item(), Some(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">1</span>));
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.start().sum, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        cursor.next(<span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.item(), Some(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">1</span>));
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.prev_item(), None);
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.next_item(), Some(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">2</span>));
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.start().sum, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> cursor <span style="color:#f92672">=</span> tree.cursor::<span style="color:#f92672">&lt;</span>IntegersSummary<span style="color:#f92672">&gt;</span>();
</span></span><span style="display:flex;"><span>        assert_eq!(
</span></span><span style="display:flex;"><span>            cursor
</span></span><span style="display:flex;"><span>                .slice(<span style="color:#f92672">&amp;</span>tree.extent::<span style="color:#f92672">&lt;</span>Count<span style="color:#f92672">&gt;</span>(<span style="color:#f92672">&amp;</span>()), Bias::Right, <span style="color:#f92672">&amp;</span>())
</span></span><span style="display:flex;"><span>                .items(<span style="color:#f92672">&amp;</span>()),
</span></span><span style="display:flex;"><span>            tree.items(<span style="color:#f92672">&amp;</span>())
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.item(), None);
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.prev_item(), Some(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">6</span>));
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.next_item(), None);
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.start().sum, <span style="color:#ae81ff">21</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        cursor.seek(<span style="color:#f92672">&amp;</span>Count(<span style="color:#ae81ff">3</span>), Bias::Right, <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        assert_eq!(
</span></span><span style="display:flex;"><span>            cursor
</span></span><span style="display:flex;"><span>                .slice(<span style="color:#f92672">&amp;</span>tree.extent::<span style="color:#f92672">&lt;</span>Count<span style="color:#f92672">&gt;</span>(<span style="color:#f92672">&amp;</span>()), Bias::Right, <span style="color:#f92672">&amp;</span>())
</span></span><span style="display:flex;"><span>                .items(<span style="color:#f92672">&amp;</span>()),
</span></span><span style="display:flex;"><span>            [<span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">6</span>]
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.item(), None);
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.prev_item(), Some(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">6</span>));
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.next_item(), None);
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.start().sum, <span style="color:#ae81ff">21</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Seeking can bias left or right
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        cursor.seek(<span style="color:#f92672">&amp;</span>Count(<span style="color:#ae81ff">1</span>), Bias::Left, <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.item(), Some(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">1</span>));
</span></span><span style="display:flex;"><span>        cursor.seek(<span style="color:#f92672">&amp;</span>Count(<span style="color:#ae81ff">1</span>), Bias::Right, <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        assert_eq!(cursor.item(), Some(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">2</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Slicing without resetting starts from where the cursor is parked at.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        cursor.seek(<span style="color:#f92672">&amp;</span>Count(<span style="color:#ae81ff">1</span>), Bias::Right, <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 这里可以画图理解，slice 到的 item 是 exclusive 的
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        assert_eq!(
</span></span><span style="display:flex;"><span>            cursor.slice(<span style="color:#f92672">&amp;</span>Count(<span style="color:#ae81ff">3</span>), Bias::Right, <span style="color:#f92672">&amp;</span>()).items(<span style="color:#f92672">&amp;</span>()),
</span></span><span style="display:flex;"><span>            vec![<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>]
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>        assert_eq!(
</span></span><span style="display:flex;"><span>            cursor.slice(<span style="color:#f92672">&amp;</span>Count(<span style="color:#ae81ff">6</span>), Bias::Left, <span style="color:#f92672">&amp;</span>()).items(<span style="color:#f92672">&amp;</span>()),
</span></span><span style="display:flex;"><span>            vec![<span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">5</span>]
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>        assert_eq!(
</span></span><span style="display:flex;"><span>            cursor.slice(<span style="color:#f92672">&amp;</span>Count(<span style="color:#ae81ff">6</span>), Bias::Right, <span style="color:#f92672">&amp;</span>()).items(<span style="color:#f92672">&amp;</span>()),
</span></span><span style="display:flex;"><span>            vec![<span style="color:#ae81ff">6</span>]
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#[test]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">test_edit</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> tree <span style="color:#f92672">=</span> SumTree::<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">u8</span><span style="color:#f92672">&gt;</span>::new();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> removed <span style="color:#f92672">=</span> tree.edit(vec![Edit::Insert(<span style="color:#ae81ff">1</span>), Edit::Insert(<span style="color:#ae81ff">2</span>), Edit::Insert(<span style="color:#ae81ff">0</span>)], <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        assert_eq!(tree.items(<span style="color:#f92672">&amp;</span>()), vec![<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>]);
</span></span><span style="display:flex;"><span>        assert_eq!(removed, Vec::<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">u8</span><span style="color:#f92672">&gt;</span>::new());
</span></span><span style="display:flex;"><span>        assert_eq!(tree.get(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0</span>, <span style="color:#f92672">&amp;</span>()), Some(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0</span>));
</span></span><span style="display:flex;"><span>        assert_eq!(tree.get(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">1</span>, <span style="color:#f92672">&amp;</span>()), Some(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">1</span>));
</span></span><span style="display:flex;"><span>        assert_eq!(tree.get(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">2</span>, <span style="color:#f92672">&amp;</span>()), Some(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">2</span>));
</span></span><span style="display:flex;"><span>        assert_eq!(tree.get(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">4</span>, <span style="color:#f92672">&amp;</span>()), None);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> removed <span style="color:#f92672">=</span> tree.edit(vec![Edit::Insert(<span style="color:#ae81ff">2</span>), Edit::Insert(<span style="color:#ae81ff">4</span>), Edit::Remove(<span style="color:#ae81ff">0</span>)], <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        assert_eq!(tree.items(<span style="color:#f92672">&amp;</span>()), vec![<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">4</span>]);
</span></span><span style="display:flex;"><span>        assert_eq!(removed, vec![<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">2</span>]);
</span></span><span style="display:flex;"><span>        assert_eq!(tree.get(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0</span>, <span style="color:#f92672">&amp;</span>()), None);
</span></span><span style="display:flex;"><span>        assert_eq!(tree.get(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">1</span>, <span style="color:#f92672">&amp;</span>()), Some(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">1</span>));
</span></span><span style="display:flex;"><span>        assert_eq!(tree.get(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">2</span>, <span style="color:#f92672">&amp;</span>()), Some(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">2</span>));
</span></span><span style="display:flex;"><span>        assert_eq!(tree.get(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">4</span>, <span style="color:#f92672">&amp;</span>()), Some(<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">4</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#[test]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">test_from_iter</span>() {
</span></span><span style="display:flex;"><span>        assert_eq!(
</span></span><span style="display:flex;"><span>            SumTree::from_iter(<span style="color:#ae81ff">0</span><span style="color:#f92672">..</span><span style="color:#ae81ff">100</span>, <span style="color:#f92672">&amp;</span>()).items(<span style="color:#f92672">&amp;</span>()),
</span></span><span style="display:flex;"><span>            (<span style="color:#ae81ff">0</span><span style="color:#f92672">..</span><span style="color:#ae81ff">100</span>).collect::<span style="color:#f92672">&lt;</span>Vec<span style="color:#f92672">&lt;</span>_<span style="color:#f92672">&gt;&gt;</span>()
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Ensure `from_iter` works correctly when the given iterator restarts
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// after calling `next` if `None` was already returned.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> ix <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> iterator <span style="color:#f92672">=</span> std::iter::from_fn(<span style="color:#f92672">||</span> {
</span></span><span style="display:flex;"><span>            ix <span style="color:#f92672">=</span> (ix <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">%</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ix <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> {
</span></span><span style="display:flex;"><span>                Some(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                None
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>        assert_eq!(SumTree::from_iter(iterator, <span style="color:#f92672">&amp;</span>()).items(<span style="color:#f92672">&amp;</span>()), vec![<span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#[derive(Clone, Default, Debug)]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">IntegersSummary</span> {
</span></span><span style="display:flex;"><span>        count: <span style="color:#66d9ef">usize</span>,
</span></span><span style="display:flex;"><span>        sum: <span style="color:#66d9ef">usize</span>,
</span></span><span style="display:flex;"><span>        contains_even: <span style="color:#66d9ef">bool</span>,
</span></span><span style="display:flex;"><span>        max: <span style="color:#66d9ef">u8</span>,
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#[derive(Ord, PartialOrd, Default, Eq, PartialEq, Clone, Debug)]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Count</span>(<span style="color:#66d9ef">usize</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#[derive(Ord, PartialOrd, Default, Eq, PartialEq, Clone, Debug)]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Sum</span>(<span style="color:#66d9ef">usize</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">impl</span> Item <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">u8</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Summary</span> <span style="color:#f92672">=</span> IntegersSummary;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">summary</span>(<span style="color:#f92672">&amp;</span>self) -&gt; <span style="color:#a6e22e">Self</span>::Summary {
</span></span><span style="display:flex;"><span>            IntegersSummary {
</span></span><span style="display:flex;"><span>                count: <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>                sum: <span style="color:#f92672">*</span>self <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">usize</span>,
</span></span><span style="display:flex;"><span>                contains_even: (<span style="color:#f92672">*</span>self <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>                max: <span style="color:#f92672">*</span>self,
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">impl</span> KeyedItem <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">u8</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Key</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">u8</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">key</span>(<span style="color:#f92672">&amp;</span>self) -&gt; <span style="color:#a6e22e">Self</span>::Key {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">*</span>self
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">impl</span> Summary <span style="color:#66d9ef">for</span> IntegersSummary {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Context</span> <span style="color:#f92672">=</span> ();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">add_summary</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, other: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">Self</span>, _: <span style="color:#66d9ef">&amp;</span>()) {
</span></span><span style="display:flex;"><span>            self.count <span style="color:#f92672">+=</span> other.count;
</span></span><span style="display:flex;"><span>            self.sum <span style="color:#f92672">+=</span> other.sum;
</span></span><span style="display:flex;"><span>            self.contains_even <span style="color:#f92672">|=</span> other.contains_even;
</span></span><span style="display:flex;"><span>            self.max <span style="color:#f92672">=</span> cmp::max(self.max, other.max);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">impl</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span><span style="color:#f92672">&gt;</span> Dimension<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, IntegersSummary<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">u8</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">add_summary</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, summary: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">IntegersSummary</span>, _: <span style="color:#66d9ef">&amp;</span>()) {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">*</span>self <span style="color:#f92672">=</span> summary.max;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">impl</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span><span style="color:#f92672">&gt;</span> Dimension<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, IntegersSummary<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">for</span> Count {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">add_summary</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, summary: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">IntegersSummary</span>, _: <span style="color:#66d9ef">&amp;</span>()) {
</span></span><span style="display:flex;"><span>            self.<span style="color:#ae81ff">0</span> <span style="color:#f92672">+=</span> summary.count;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">impl</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span><span style="color:#f92672">&gt;</span> SeekTarget<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, IntegersSummary, IntegersSummary<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">for</span> Count {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">cmp</span>(<span style="color:#f92672">&amp;</span>self, cursor_location: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">IntegersSummary</span>, _: <span style="color:#66d9ef">&amp;</span>()) -&gt; <span style="color:#a6e22e">Ordering</span> {
</span></span><span style="display:flex;"><span>            self.<span style="color:#ae81ff">0.</span>cmp(<span style="color:#f92672">&amp;</span>cursor_location.count)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">impl</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span><span style="color:#f92672">&gt;</span> Dimension<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, IntegersSummary<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">for</span> Sum {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">add_summary</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, summary: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">IntegersSummary</span>, _: <span style="color:#66d9ef">&amp;</span>()) {
</span></span><span style="display:flex;"><span>            self.<span style="color:#ae81ff">0</span> <span style="color:#f92672">+=</span> summary.sum;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>以下是 rope.rs 的部分代码分析：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">// rope.rs
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">mod</span> offset_utf16;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">mod</span> point;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">mod</span> point_utf16;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">mod</span> unclipped;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> arrayvec::ArrayString;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> smallvec::SmallVec;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> std::{
</span></span><span style="display:flex;"><span>    cmp, fmt, io, mem,
</span></span><span style="display:flex;"><span>    ops::{AddAssign, Range},
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">str</span>,
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> sum_tree::{Bias, Dimension, SumTree};
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> unicode_segmentation::GraphemeCursor;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> util::debug_panic;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">use</span> offset_utf16::OffsetUtf16;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">use</span> point::Point;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">use</span> point_utf16::PointUtf16;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">use</span> unclipped::Unclipped;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#[cfg(test)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">CHUNK_BASE</span>: <span style="color:#66d9ef">usize</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">6</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#[cfg(not(test))]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">CHUNK_BASE</span>: <span style="color:#66d9ef">usize</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">64</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#[derive(Clone, Default)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Rope</span> {
</span></span><span style="display:flex;"><span>    chunks: <span style="color:#a6e22e">SumTree</span><span style="color:#f92672">&lt;</span>Chunk<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span> Rope {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">new</span>() -&gt; <span style="color:#a6e22e">Self</span> {
</span></span><span style="display:flex;"><span>        Self::default()
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">append</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, rope: <span style="color:#a6e22e">Rope</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> chunks <span style="color:#f92672">=</span> rope.chunks.cursor::<span style="color:#f92672">&lt;</span>()<span style="color:#f92672">&gt;</span>();
</span></span><span style="display:flex;"><span>        chunks.next(<span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Some(chunk) <span style="color:#f92672">=</span> chunks.item() {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> self.chunks.last().map_or(<span style="color:#66d9ef">false</span>, <span style="color:#f92672">|</span>c<span style="color:#f92672">|</span> c.<span style="color:#ae81ff">0.</span>len() <span style="color:#f92672">&lt;</span> <span style="color:#66d9ef">CHUNK_BASE</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">||</span> chunk.<span style="color:#ae81ff">0.</span>len() <span style="color:#f92672">&lt;</span> <span style="color:#66d9ef">CHUNK_BASE</span>
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                self.push(<span style="color:#f92672">&amp;</span>chunk.<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>                chunks.next(<span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self.chunks.append(chunks.suffix(<span style="color:#f92672">&amp;</span>()), <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        self.check_invariants();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">replace</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, range: <span style="color:#a6e22e">Range</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">usize</span><span style="color:#f92672">&gt;</span>, text: <span style="color:#66d9ef">&amp;</span><span style="color:#66d9ef">str</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> new_rope <span style="color:#f92672">=</span> Rope::new();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> cursor <span style="color:#f92672">=</span> self.cursor(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>        new_rope.append(cursor.slice(range.start));
</span></span><span style="display:flex;"><span>        cursor.seek_forward(range.end);
</span></span><span style="display:flex;"><span>        new_rope.push(text);
</span></span><span style="display:flex;"><span>        new_rope.append(cursor.suffix());
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">*</span>self <span style="color:#f92672">=</span> new_rope;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">slice</span>(<span style="color:#f92672">&amp;</span>self, range: <span style="color:#a6e22e">Range</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">usize</span><span style="color:#f92672">&gt;</span>) -&gt; <span style="color:#a6e22e">Rope</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> cursor <span style="color:#f92672">=</span> self.cursor(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>        cursor.seek_forward(range.start);
</span></span><span style="display:flex;"><span>        cursor.slice(range.end)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">slice_rows</span>(<span style="color:#f92672">&amp;</span>self, range: <span style="color:#a6e22e">Range</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">u32</span><span style="color:#f92672">&gt;</span>) -&gt; <span style="color:#a6e22e">Rope</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// This would be more efficient with a forward advance after the first, but it&#39;s fine.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">let</span> start <span style="color:#f92672">=</span> self.point_to_offset(Point::new(range.start, <span style="color:#ae81ff">0</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> end <span style="color:#f92672">=</span> self.point_to_offset(Point::new(range.end, <span style="color:#ae81ff">0</span>));
</span></span><span style="display:flex;"><span>        self.slice(start<span style="color:#f92672">..</span>end)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">push</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, <span style="color:#66d9ef">mut</span> text: <span style="color:#66d9ef">&amp;</span><span style="color:#66d9ef">str</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// if the two can be put into a single item, then do it
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// otherwise try make the first size CHUNK_BASE.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        self.chunks.update_last(
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">|</span>last_chunk<span style="color:#f92672">|</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let</span> split_ix <span style="color:#f92672">=</span> <span style="color:#66d9ef">if</span> last_chunk.<span style="color:#ae81ff">0.</span>len() <span style="color:#f92672">+</span> text.len() <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">CHUNK_BASE</span> {
</span></span><span style="display:flex;"><span>                    text.len()
</span></span><span style="display:flex;"><span>                } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> split_ix <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>                        cmp::min(<span style="color:#66d9ef">CHUNK_BASE</span>.saturating_sub(last_chunk.<span style="color:#ae81ff">0.</span>len()), text.len());
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">while</span> <span style="color:#f92672">!</span>text.is_char_boundary(split_ix) {
</span></span><span style="display:flex;"><span>                        split_ix <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    split_ix
</span></span><span style="display:flex;"><span>                };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let</span> (suffix, remainder) <span style="color:#f92672">=</span> text.split_at(split_ix);
</span></span><span style="display:flex;"><span>                last_chunk.<span style="color:#ae81ff">0.</span>push_str(suffix);
</span></span><span style="display:flex;"><span>                text <span style="color:#f92672">=</span> remainder;
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&amp;</span>(),
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> text.len() <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">2048</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> self.push_large(text);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> new_chunks <span style="color:#f92672">=</span> SmallVec::<span style="color:#f92672">&lt;</span>[_; <span style="color:#ae81ff">16</span>]<span style="color:#f92672">&gt;</span>::new();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> <span style="color:#f92672">!</span>text.is_empty() {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> split_ix <span style="color:#f92672">=</span> cmp::min(<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">CHUNK_BASE</span>, text.len());
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">while</span> <span style="color:#f92672">!</span>text.is_char_boundary(split_ix) {
</span></span><span style="display:flex;"><span>                split_ix <span style="color:#f92672">-=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> (chunk, remainder) <span style="color:#f92672">=</span> text.split_at(split_ix);
</span></span><span style="display:flex;"><span>            new_chunks.push(Chunk(ArrayString::from(chunk).unwrap()));
</span></span><span style="display:flex;"><span>            text <span style="color:#f92672">=</span> remainder;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#[cfg(test)]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">PARALLEL_THRESHOLD</span>: <span style="color:#66d9ef">usize</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#[cfg(not(test))]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">PARALLEL_THRESHOLD</span>: <span style="color:#66d9ef">usize</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span> <span style="color:#f92672">*</span> (<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> sum_tree::<span style="color:#66d9ef">TREE_BASE</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> new_chunks.len() <span style="color:#f92672">&gt;=</span> <span style="color:#66d9ef">PARALLEL_THRESHOLD</span> {
</span></span><span style="display:flex;"><span>            self.chunks.par_extend(new_chunks.into_vec(), <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            self.chunks.extend(new_chunks, <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self.check_invariants();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// A copy of `push` specialized for working with large quantities of text.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">push_large</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, <span style="color:#66d9ef">mut</span> text: <span style="color:#66d9ef">&amp;</span><span style="color:#66d9ef">str</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// To avoid frequent reallocs when loading large swaths of file contents,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// we estimate worst-case `new_chunks` capacity;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// Chunk is a fixed-capacity buffer. If a character falls on
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// chunk boundary, we push it off to the following chunk (thus leaving a small bit of capacity unfilled in current chunk).
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// Worst-case chunk count when loading a file is then a case where every chunk ends up with that unused capacity.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// Since we&#39;re working with UTF-8, each character is at most 4 bytes wide. It follows then that the worst case is where
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// a chunk ends with 3 bytes of a 4-byte character. These 3 bytes end up being stored in the following chunk, thus wasting
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// 3 bytes of storage in current chunk.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// For example, a 1024-byte string can occupy between 32 (full ASCII, 1024/32) and 36 (full 4-byte UTF-8, 1024 / 29 rounded up) chunks.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">MIN_CHUNK_SIZE</span>: <span style="color:#66d9ef">usize</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">CHUNK_BASE</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">3</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// We also round up the capacity up by one, for a good measure; we *really* don&#39;t want to realloc here, as we assume that the # of characters
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// we&#39;re working with there is large.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">let</span> capacity <span style="color:#f92672">=</span> (text.len() <span style="color:#f92672">+</span> <span style="color:#66d9ef">MIN_CHUNK_SIZE</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">/</span> <span style="color:#66d9ef">MIN_CHUNK_SIZE</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> new_chunks <span style="color:#f92672">=</span> Vec::with_capacity(capacity);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> <span style="color:#f92672">!</span>text.is_empty() {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> split_ix <span style="color:#f92672">=</span> cmp::min(<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">CHUNK_BASE</span>, text.len());
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">while</span> <span style="color:#f92672">!</span>text.is_char_boundary(split_ix) {
</span></span><span style="display:flex;"><span>                split_ix <span style="color:#f92672">-=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> (chunk, remainder) <span style="color:#f92672">=</span> text.split_at(split_ix);
</span></span><span style="display:flex;"><span>            new_chunks.push(Chunk(ArrayString::from(chunk).unwrap()));
</span></span><span style="display:flex;"><span>            text <span style="color:#f92672">=</span> remainder;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#[cfg(test)]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">PARALLEL_THRESHOLD</span>: <span style="color:#66d9ef">usize</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#[cfg(not(test))]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">PARALLEL_THRESHOLD</span>: <span style="color:#66d9ef">usize</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span> <span style="color:#f92672">*</span> (<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> sum_tree::<span style="color:#66d9ef">TREE_BASE</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> new_chunks.len() <span style="color:#f92672">&gt;=</span> <span style="color:#66d9ef">PARALLEL_THRESHOLD</span> {
</span></span><span style="display:flex;"><span>            self.chunks.par_extend(new_chunks, <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            self.chunks.extend(new_chunks, <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self.check_invariants();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">push_front</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, text: <span style="color:#66d9ef">&amp;</span><span style="color:#66d9ef">str</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> suffix <span style="color:#f92672">=</span> mem::replace(self, Rope::from(text));
</span></span><span style="display:flex;"><span>        self.append(suffix);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">check_invariants</span>(<span style="color:#f92672">&amp;</span>self) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#[cfg(test)]</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Ensure all chunks except maybe the last one are not underflowing.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">// Allow some wiggle room for multibyte characters at chunk boundaries.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> chunks <span style="color:#f92672">=</span> self.chunks.cursor::<span style="color:#f92672">&lt;</span>()<span style="color:#f92672">&gt;</span>().peekable();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">let</span> Some(chunk) <span style="color:#f92672">=</span> chunks.next() {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> chunks.peek().is_some() {
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// utf-8 max size for single char is 4 bytes
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    assert!(chunk.<span style="color:#ae81ff">0.</span>len() <span style="color:#f92672">+</span> <span style="color:#ae81ff">3</span> <span style="color:#f92672">&gt;=</span> <span style="color:#66d9ef">CHUNK_BASE</span>);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">summary</span>(<span style="color:#f92672">&amp;</span>self) -&gt; <span style="color:#a6e22e">TextSummary</span> {
</span></span><span style="display:flex;"><span>        self.chunks.summary().text.clone()
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">len</span>(<span style="color:#f92672">&amp;</span>self) -&gt; <span style="color:#66d9ef">usize</span> {
</span></span><span style="display:flex;"><span>        self.chunks.extent(<span style="color:#f92672">&amp;</span>())
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">is_empty</span>(<span style="color:#f92672">&amp;</span>self) -&gt; <span style="color:#66d9ef">bool</span> {
</span></span><span style="display:flex;"><span>        self.len() <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">max_point</span>(<span style="color:#f92672">&amp;</span>self) -&gt; <span style="color:#a6e22e">Point</span> {
</span></span><span style="display:flex;"><span>        self.chunks.extent(<span style="color:#f92672">&amp;</span>())
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">max_point_utf16</span>(<span style="color:#f92672">&amp;</span>self) -&gt; <span style="color:#a6e22e">PointUtf16</span> {
</span></span><span style="display:flex;"><span>        self.chunks.extent(<span style="color:#f92672">&amp;</span>())
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">cursor</span>(<span style="color:#f92672">&amp;</span>self, offset: <span style="color:#66d9ef">usize</span>) -&gt; <span style="color:#a6e22e">Cursor</span> {
</span></span><span style="display:flex;"><span>        Cursor::new(self, offset)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">chars</span>(<span style="color:#f92672">&amp;</span>self) -&gt; <span style="color:#a6e22e">impl</span> Iterator<span style="color:#f92672">&lt;</span>Item <span style="color:#f92672">=</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">+</span> &#39;_ {
</span></span><span style="display:flex;"><span>        self.chars_at(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">chars_at</span>(<span style="color:#f92672">&amp;</span>self, start: <span style="color:#66d9ef">usize</span>) -&gt; <span style="color:#a6e22e">impl</span> Iterator<span style="color:#f92672">&lt;</span>Item <span style="color:#f92672">=</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">+</span> &#39;_ {
</span></span><span style="display:flex;"><span>        self.chunks_in_range(start<span style="color:#f92672">..</span>self.len()).flat_map(<span style="color:#66d9ef">str</span>::chars)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">reversed_chars_at</span>(<span style="color:#f92672">&amp;</span>self, start: <span style="color:#66d9ef">usize</span>) -&gt; <span style="color:#a6e22e">impl</span> Iterator<span style="color:#f92672">&lt;</span>Item <span style="color:#f92672">=</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">+</span> &#39;_ {
</span></span><span style="display:flex;"><span>        self.reversed_chunks_in_range(<span style="color:#ae81ff">0</span><span style="color:#f92672">..</span>start)
</span></span><span style="display:flex;"><span>            .flat_map(<span style="color:#f92672">|</span>chunk<span style="color:#f92672">|</span> chunk.chars().rev())
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">bytes_in_range</span>(<span style="color:#f92672">&amp;</span>self, range: <span style="color:#a6e22e">Range</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">usize</span><span style="color:#f92672">&gt;</span>) -&gt; <span style="color:#a6e22e">Bytes</span> {
</span></span><span style="display:flex;"><span>        Bytes::new(self, range, <span style="color:#66d9ef">false</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">reversed_bytes_in_range</span>(<span style="color:#f92672">&amp;</span>self, range: <span style="color:#a6e22e">Range</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">usize</span><span style="color:#f92672">&gt;</span>) -&gt; <span style="color:#a6e22e">Bytes</span> {
</span></span><span style="display:flex;"><span>        Bytes::new(self, range, <span style="color:#66d9ef">true</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">chunks</span>(<span style="color:#f92672">&amp;</span>self) -&gt; <span style="color:#a6e22e">Chunks</span> {
</span></span><span style="display:flex;"><span>        self.chunks_in_range(<span style="color:#ae81ff">0</span><span style="color:#f92672">..</span>self.len())
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">chunks_in_range</span>(<span style="color:#f92672">&amp;</span>self, range: <span style="color:#a6e22e">Range</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">usize</span><span style="color:#f92672">&gt;</span>) -&gt; <span style="color:#a6e22e">Chunks</span> {
</span></span><span style="display:flex;"><span>        Chunks::new(self, range, <span style="color:#66d9ef">false</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">reversed_chunks_in_range</span>(<span style="color:#f92672">&amp;</span>self, range: <span style="color:#a6e22e">Range</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">usize</span><span style="color:#f92672">&gt;</span>) -&gt; <span style="color:#a6e22e">Chunks</span> {
</span></span><span style="display:flex;"><span>        Chunks::new(self, range, <span style="color:#66d9ef">true</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">offset_to_offset_utf16</span>(<span style="color:#f92672">&amp;</span>self, offset: <span style="color:#66d9ef">usize</span>) -&gt; <span style="color:#a6e22e">OffsetUtf16</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> offset <span style="color:#f92672">&gt;=</span> self.summary().len {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> self.summary().len_utf16;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> cursor <span style="color:#f92672">=</span> self.chunks.cursor::<span style="color:#f92672">&lt;</span>(<span style="color:#66d9ef">usize</span>, OffsetUtf16)<span style="color:#f92672">&gt;</span>();
</span></span><span style="display:flex;"><span>        cursor.seek(<span style="color:#f92672">&amp;</span>offset, Bias::Left, <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> overshoot <span style="color:#f92672">=</span> offset <span style="color:#f92672">-</span> cursor.start().<span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        cursor.start().<span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">+</span> cursor.item().map_or(Default::default(), <span style="color:#f92672">|</span>chunk<span style="color:#f92672">|</span> {
</span></span><span style="display:flex;"><span>                chunk.offset_to_offset_utf16(overshoot)
</span></span><span style="display:flex;"><span>            })
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">offset_utf16_to_offset</span>(<span style="color:#f92672">&amp;</span>self, offset: <span style="color:#a6e22e">OffsetUtf16</span>) -&gt; <span style="color:#66d9ef">usize</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> offset <span style="color:#f92672">&gt;=</span> self.summary().len_utf16 {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> self.summary().len;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> cursor <span style="color:#f92672">=</span> self.chunks.cursor::<span style="color:#f92672">&lt;</span>(OffsetUtf16, <span style="color:#66d9ef">usize</span>)<span style="color:#f92672">&gt;</span>();
</span></span><span style="display:flex;"><span>        cursor.seek(<span style="color:#f92672">&amp;</span>offset, Bias::Left, <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> overshoot <span style="color:#f92672">=</span> offset <span style="color:#f92672">-</span> cursor.start().<span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        cursor.start().<span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">+</span> cursor.item().map_or(Default::default(), <span style="color:#f92672">|</span>chunk<span style="color:#f92672">|</span> {
</span></span><span style="display:flex;"><span>                chunk.offset_utf16_to_offset(overshoot)
</span></span><span style="display:flex;"><span>            })
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">offset_to_point</span>(<span style="color:#f92672">&amp;</span>self, offset: <span style="color:#66d9ef">usize</span>) -&gt; <span style="color:#a6e22e">Point</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> offset <span style="color:#f92672">&gt;=</span> self.summary().len {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> self.summary().lines;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> cursor <span style="color:#f92672">=</span> self.chunks.cursor::<span style="color:#f92672">&lt;</span>(<span style="color:#66d9ef">usize</span>, Point)<span style="color:#f92672">&gt;</span>();
</span></span><span style="display:flex;"><span>        cursor.seek(<span style="color:#f92672">&amp;</span>offset, Bias::Left, <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> overshoot <span style="color:#f92672">=</span> offset <span style="color:#f92672">-</span> cursor.start().<span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        cursor.start().<span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">+</span> cursor
</span></span><span style="display:flex;"><span>                .item()
</span></span><span style="display:flex;"><span>                .map_or(Point::zero(), <span style="color:#f92672">|</span>chunk<span style="color:#f92672">|</span> chunk.offset_to_point(overshoot))
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">offset_to_point_utf16</span>(<span style="color:#f92672">&amp;</span>self, offset: <span style="color:#66d9ef">usize</span>) -&gt; <span style="color:#a6e22e">PointUtf16</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> offset <span style="color:#f92672">&gt;=</span> self.summary().len {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> self.summary().lines_utf16();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> cursor <span style="color:#f92672">=</span> self.chunks.cursor::<span style="color:#f92672">&lt;</span>(<span style="color:#66d9ef">usize</span>, PointUtf16)<span style="color:#f92672">&gt;</span>();
</span></span><span style="display:flex;"><span>        cursor.seek(<span style="color:#f92672">&amp;</span>offset, Bias::Left, <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> overshoot <span style="color:#f92672">=</span> offset <span style="color:#f92672">-</span> cursor.start().<span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        cursor.start().<span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">+</span> cursor.item().map_or(PointUtf16::zero(), <span style="color:#f92672">|</span>chunk<span style="color:#f92672">|</span> {
</span></span><span style="display:flex;"><span>                chunk.offset_to_point_utf16(overshoot)
</span></span><span style="display:flex;"><span>            })
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">point_to_point_utf16</span>(<span style="color:#f92672">&amp;</span>self, point: <span style="color:#a6e22e">Point</span>) -&gt; <span style="color:#a6e22e">PointUtf16</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> point <span style="color:#f92672">&gt;=</span> self.summary().lines {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> self.summary().lines_utf16();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> cursor <span style="color:#f92672">=</span> self.chunks.cursor::<span style="color:#f92672">&lt;</span>(Point, PointUtf16)<span style="color:#f92672">&gt;</span>();
</span></span><span style="display:flex;"><span>        cursor.seek(<span style="color:#f92672">&amp;</span>point, Bias::Left, <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> overshoot <span style="color:#f92672">=</span> point <span style="color:#f92672">-</span> cursor.start().<span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        cursor.start().<span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">+</span> cursor.item().map_or(PointUtf16::zero(), <span style="color:#f92672">|</span>chunk<span style="color:#f92672">|</span> {
</span></span><span style="display:flex;"><span>                chunk.point_to_point_utf16(overshoot)
</span></span><span style="display:flex;"><span>            })
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">point_to_offset</span>(<span style="color:#f92672">&amp;</span>self, point: <span style="color:#a6e22e">Point</span>) -&gt; <span style="color:#66d9ef">usize</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> point <span style="color:#f92672">&gt;=</span> self.summary().lines {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> self.summary().len;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> cursor <span style="color:#f92672">=</span> self.chunks.cursor::<span style="color:#f92672">&lt;</span>(Point, <span style="color:#66d9ef">usize</span>)<span style="color:#f92672">&gt;</span>();
</span></span><span style="display:flex;"><span>        cursor.seek(<span style="color:#f92672">&amp;</span>point, Bias::Left, <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> overshoot <span style="color:#f92672">=</span> point <span style="color:#f92672">-</span> cursor.start().<span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        cursor.start().<span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">+</span> cursor
</span></span><span style="display:flex;"><span>                .item()
</span></span><span style="display:flex;"><span>                .map_or(<span style="color:#ae81ff">0</span>, <span style="color:#f92672">|</span>chunk<span style="color:#f92672">|</span> chunk.point_to_offset(overshoot))
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">point_utf16_to_offset</span>(<span style="color:#f92672">&amp;</span>self, point: <span style="color:#a6e22e">PointUtf16</span>) -&gt; <span style="color:#66d9ef">usize</span> {
</span></span><span style="display:flex;"><span>        self.point_utf16_to_offset_impl(point, <span style="color:#66d9ef">false</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">unclipped_point_utf16_to_offset</span>(<span style="color:#f92672">&amp;</span>self, point: <span style="color:#a6e22e">Unclipped</span><span style="color:#f92672">&lt;</span>PointUtf16<span style="color:#f92672">&gt;</span>) -&gt; <span style="color:#66d9ef">usize</span> {
</span></span><span style="display:flex;"><span>        self.point_utf16_to_offset_impl(point.<span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">true</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">point_utf16_to_offset_impl</span>(<span style="color:#f92672">&amp;</span>self, point: <span style="color:#a6e22e">PointUtf16</span>, clip: <span style="color:#66d9ef">bool</span>) -&gt; <span style="color:#66d9ef">usize</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> point <span style="color:#f92672">&gt;=</span> self.summary().lines_utf16() {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> self.summary().len;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> cursor <span style="color:#f92672">=</span> self.chunks.cursor::<span style="color:#f92672">&lt;</span>(PointUtf16, <span style="color:#66d9ef">usize</span>)<span style="color:#f92672">&gt;</span>();
</span></span><span style="display:flex;"><span>        cursor.seek(<span style="color:#f92672">&amp;</span>point, Bias::Left, <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> overshoot <span style="color:#f92672">=</span> point <span style="color:#f92672">-</span> cursor.start().<span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        cursor.start().<span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">+</span> cursor
</span></span><span style="display:flex;"><span>                .item()
</span></span><span style="display:flex;"><span>                .map_or(<span style="color:#ae81ff">0</span>, <span style="color:#f92672">|</span>chunk<span style="color:#f92672">|</span> chunk.point_utf16_to_offset(overshoot, clip))
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">unclipped_point_utf16_to_point</span>(<span style="color:#f92672">&amp;</span>self, point: <span style="color:#a6e22e">Unclipped</span><span style="color:#f92672">&lt;</span>PointUtf16<span style="color:#f92672">&gt;</span>) -&gt; <span style="color:#a6e22e">Point</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> point.<span style="color:#ae81ff">0</span> <span style="color:#f92672">&gt;=</span> self.summary().lines_utf16() {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> self.summary().lines;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> cursor <span style="color:#f92672">=</span> self.chunks.cursor::<span style="color:#f92672">&lt;</span>(PointUtf16, Point)<span style="color:#f92672">&gt;</span>();
</span></span><span style="display:flex;"><span>        cursor.seek(<span style="color:#f92672">&amp;</span>point.<span style="color:#ae81ff">0</span>, Bias::Left, <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> overshoot <span style="color:#f92672">=</span> Unclipped(point.<span style="color:#ae81ff">0</span> <span style="color:#f92672">-</span> cursor.start().<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>        cursor.start().<span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">+</span> cursor.item().map_or(Point::zero(), <span style="color:#f92672">|</span>chunk<span style="color:#f92672">|</span> {
</span></span><span style="display:flex;"><span>                chunk.unclipped_point_utf16_to_point(overshoot)
</span></span><span style="display:flex;"><span>            })
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">clip_offset</span>(<span style="color:#f92672">&amp;</span>self, <span style="color:#66d9ef">mut</span> offset: <span style="color:#66d9ef">usize</span>, bias: <span style="color:#a6e22e">Bias</span>) -&gt; <span style="color:#66d9ef">usize</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> cursor <span style="color:#f92672">=</span> self.chunks.cursor::<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">usize</span><span style="color:#f92672">&gt;</span>();
</span></span><span style="display:flex;"><span>        cursor.seek(<span style="color:#f92672">&amp;</span>offset, Bias::Left, <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Some(chunk) <span style="color:#f92672">=</span> cursor.item() {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> ix <span style="color:#f92672">=</span> offset <span style="color:#f92672">-</span> cursor.start();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">while</span> <span style="color:#f92672">!</span>chunk.<span style="color:#ae81ff">0.</span>is_char_boundary(ix) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">match</span> bias {
</span></span><span style="display:flex;"><span>                    Bias::Left <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>                        ix <span style="color:#f92672">-=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                        offset <span style="color:#f92672">-=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    Bias::Right <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>                        ix <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                        offset <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            offset
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            self.summary().len
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">clip_offset_utf16</span>(<span style="color:#f92672">&amp;</span>self, offset: <span style="color:#a6e22e">OffsetUtf16</span>, bias: <span style="color:#a6e22e">Bias</span>) -&gt; <span style="color:#a6e22e">OffsetUtf16</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> cursor <span style="color:#f92672">=</span> self.chunks.cursor::<span style="color:#f92672">&lt;</span>OffsetUtf16<span style="color:#f92672">&gt;</span>();
</span></span><span style="display:flex;"><span>        cursor.seek(<span style="color:#f92672">&amp;</span>offset, Bias::Right, <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Some(chunk) <span style="color:#f92672">=</span> cursor.item() {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> overshoot <span style="color:#f92672">=</span> offset <span style="color:#f92672">-</span> cursor.start();
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">*</span>cursor.start() <span style="color:#f92672">+</span> chunk.clip_offset_utf16(overshoot, bias)
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            self.summary().len_utf16
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">clip_point</span>(<span style="color:#f92672">&amp;</span>self, point: <span style="color:#a6e22e">Point</span>, bias: <span style="color:#a6e22e">Bias</span>) -&gt; <span style="color:#a6e22e">Point</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> cursor <span style="color:#f92672">=</span> self.chunks.cursor::<span style="color:#f92672">&lt;</span>Point<span style="color:#f92672">&gt;</span>();
</span></span><span style="display:flex;"><span>        cursor.seek(<span style="color:#f92672">&amp;</span>point, Bias::Right, <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Some(chunk) <span style="color:#f92672">=</span> cursor.item() {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> overshoot <span style="color:#f92672">=</span> point <span style="color:#f92672">-</span> cursor.start();
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">*</span>cursor.start() <span style="color:#f92672">+</span> chunk.clip_point(overshoot, bias)
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            self.summary().lines
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">clip_point_utf16</span>(<span style="color:#f92672">&amp;</span>self, point: <span style="color:#a6e22e">Unclipped</span><span style="color:#f92672">&lt;</span>PointUtf16<span style="color:#f92672">&gt;</span>, bias: <span style="color:#a6e22e">Bias</span>) -&gt; <span style="color:#a6e22e">PointUtf16</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> cursor <span style="color:#f92672">=</span> self.chunks.cursor::<span style="color:#f92672">&lt;</span>PointUtf16<span style="color:#f92672">&gt;</span>();
</span></span><span style="display:flex;"><span>        cursor.seek(<span style="color:#f92672">&amp;</span>point.<span style="color:#ae81ff">0</span>, Bias::Right, <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Some(chunk) <span style="color:#f92672">=</span> cursor.item() {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> overshoot <span style="color:#f92672">=</span> Unclipped(point.<span style="color:#ae81ff">0</span> <span style="color:#f92672">-</span> cursor.start());
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">*</span>cursor.start() <span style="color:#f92672">+</span> chunk.clip_point_utf16(overshoot, bias)
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            self.summary().lines_utf16()
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">line_len</span>(<span style="color:#f92672">&amp;</span>self, row: <span style="color:#66d9ef">u32</span>) -&gt; <span style="color:#66d9ef">u32</span> {
</span></span><span style="display:flex;"><span>        self.clip_point(Point::new(row, <span style="color:#66d9ef">u32</span>::<span style="color:#66d9ef">MAX</span>), Bias::Left)
</span></span><span style="display:flex;"><span>            .column
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span><span style="color:#f92672">&gt;</span> From<span style="color:#f92672">&lt;&amp;</span><span style="color:#a6e22e">&#39;a</span> <span style="color:#66d9ef">str</span><span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">for</span> Rope {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">from</span>(text: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">&#39;a</span> <span style="color:#66d9ef">str</span>) -&gt; <span style="color:#a6e22e">Self</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> rope <span style="color:#f92672">=</span> Self::new();
</span></span><span style="display:flex;"><span>        rope.push(text);
</span></span><span style="display:flex;"><span>        rope
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span><span style="color:#f92672">&gt;</span> FromIterator<span style="color:#f92672">&lt;&amp;</span><span style="color:#a6e22e">&#39;a</span> <span style="color:#66d9ef">str</span><span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">for</span> Rope {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">from_iter</span><span style="color:#f92672">&lt;</span>T: IntoIterator<span style="color:#f92672">&lt;</span>Item <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">&#39;a</span> <span style="color:#66d9ef">str</span><span style="color:#f92672">&gt;&gt;</span>(iter: <span style="color:#a6e22e">T</span>) -&gt; <span style="color:#a6e22e">Self</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> rope <span style="color:#f92672">=</span> Rope::new();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> chunk <span style="color:#66d9ef">in</span> iter {
</span></span><span style="display:flex;"><span>            rope.push(chunk);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        rope
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span> From<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">for</span> Rope {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">from</span>(text: String) -&gt; <span style="color:#a6e22e">Self</span> {
</span></span><span style="display:flex;"><span>        Rope::from(text.as_str())
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span> fmt::Display <span style="color:#66d9ef">for</span> Rope {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">fmt</span>(<span style="color:#f92672">&amp;</span>self, f: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">mut</span> fmt::Formatter<span style="color:#f92672">&lt;</span>&#39;_<span style="color:#f92672">&gt;</span>) -&gt; <span style="color:#a6e22e">fmt</span>::Result {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> chunk <span style="color:#66d9ef">in</span> self.chunks() {
</span></span><span style="display:flex;"><span>            write!(f, <span style="color:#e6db74">&#34;{}&#34;</span>, chunk)<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        Ok(())
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span> fmt::Debug <span style="color:#66d9ef">for</span> Rope {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">fmt</span>(<span style="color:#f92672">&amp;</span>self, f: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">mut</span> fmt::Formatter<span style="color:#f92672">&lt;</span>&#39;_<span style="color:#f92672">&gt;</span>) -&gt; <span style="color:#a6e22e">fmt</span>::Result {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">use</span> std::fmt::Write <span style="color:#66d9ef">as</span> _;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        write!(f, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">&#34;</span>)<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> format_string <span style="color:#f92672">=</span> String::new();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> chunk <span style="color:#66d9ef">in</span> self.chunks() {
</span></span><span style="display:flex;"><span>            write!(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> format_string, <span style="color:#e6db74">&#34;{:?}&#34;</span>, chunk)<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>            write!(f, <span style="color:#e6db74">&#34;{}&#34;</span>, <span style="color:#f92672">&amp;</span>format_string[<span style="color:#ae81ff">1</span><span style="color:#f92672">..</span>format_string.len() <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>])<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>            format_string.clear();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        write!(f, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">&#34;</span>)<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>        Ok(())
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Cursor</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span><span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    rope: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">&#39;a</span> <span style="color:#a6e22e">Rope</span>,
</span></span><span style="display:flex;"><span>    chunks: <span style="color:#a6e22e">sum_tree</span>::Cursor<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, Chunk, <span style="color:#66d9ef">usize</span><span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// position Dimension
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    offset: <span style="color:#66d9ef">usize</span>,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span><span style="color:#f92672">&gt;</span> Cursor<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span><span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">new</span>(rope: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">&#39;a</span> <span style="color:#a6e22e">Rope</span>, offset: <span style="color:#66d9ef">usize</span>) -&gt; <span style="color:#a6e22e">Self</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> chunks <span style="color:#f92672">=</span> rope.chunks.cursor();
</span></span><span style="display:flex;"><span>        chunks.seek(<span style="color:#f92672">&amp;</span>offset, Bias::Right, <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        Self {
</span></span><span style="display:flex;"><span>            rope,
</span></span><span style="display:flex;"><span>            chunks,
</span></span><span style="display:flex;"><span>            offset,
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">seek_forward</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, end_offset: <span style="color:#66d9ef">usize</span>) {
</span></span><span style="display:flex;"><span>        debug_assert!(end_offset <span style="color:#f92672">&gt;=</span> self.offset);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self.chunks.seek_forward(<span style="color:#f92672">&amp;</span>end_offset, Bias::Right, <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        self.offset <span style="color:#f92672">=</span> end_offset;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">slice</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, end_offset: <span style="color:#66d9ef">usize</span>) -&gt; <span style="color:#a6e22e">Rope</span> {
</span></span><span style="display:flex;"><span>        debug_assert!(
</span></span><span style="display:flex;"><span>            end_offset <span style="color:#f92672">&gt;=</span> self.offset,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;cannot slice backwards from {} to {}&#34;</span>,
</span></span><span style="display:flex;"><span>            self.offset,
</span></span><span style="display:flex;"><span>            end_offset
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> slice <span style="color:#f92672">=</span> Rope::new();
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 当前item内部
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Some(start_chunk) <span style="color:#f92672">=</span> self.chunks.item() {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> start_ix <span style="color:#f92672">=</span> self.offset <span style="color:#f92672">-</span> self.chunks.start();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> end_ix <span style="color:#f92672">=</span> cmp::min(end_offset, self.chunks.end(<span style="color:#f92672">&amp;</span>())) <span style="color:#f92672">-</span> self.chunks.start();
</span></span><span style="display:flex;"><span>            slice.push(<span style="color:#f92672">&amp;</span>start_chunk.<span style="color:#ae81ff">0</span>[start_ix<span style="color:#f92672">..</span>end_ix]);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 超过当前item的范围
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> end_offset <span style="color:#f92672">&gt;</span> self.chunks.end(<span style="color:#f92672">&amp;</span>()) {
</span></span><span style="display:flex;"><span>            self.chunks.next(<span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 完整的items被加进来(SumTree Cursor&#39;s slice function只会加完整的items)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            slice.append(Rope {
</span></span><span style="display:flex;"><span>                chunks: <span style="color:#a6e22e">self</span>.chunks.slice(<span style="color:#f92672">&amp;</span>end_offset, Bias::Right, <span style="color:#f92672">&amp;</span>()),
</span></span><span style="display:flex;"><span>            });
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 最后不完整的那个加进来
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Some(end_chunk) <span style="color:#f92672">=</span> self.chunks.item() {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let</span> end_ix <span style="color:#f92672">=</span> end_offset <span style="color:#f92672">-</span> self.chunks.start();
</span></span><span style="display:flex;"><span>                slice.push(<span style="color:#f92672">&amp;</span>end_chunk.<span style="color:#ae81ff">0</span>[<span style="color:#f92672">..</span>end_ix]);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self.offset <span style="color:#f92672">=</span> end_offset;
</span></span><span style="display:flex;"><span>        slice
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">summary</span><span style="color:#f92672">&lt;</span>D: <span style="color:#a6e22e">TextDimension</span><span style="color:#f92672">&gt;</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, end_offset: <span style="color:#66d9ef">usize</span>) -&gt; <span style="color:#a6e22e">D</span> {
</span></span><span style="display:flex;"><span>        debug_assert!(end_offset <span style="color:#f92672">&gt;=</span> self.offset);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> summary <span style="color:#f92672">=</span> D::default();
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// curr item
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Some(start_chunk) <span style="color:#f92672">=</span> self.chunks.item() {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> start_ix <span style="color:#f92672">=</span> self.offset <span style="color:#f92672">-</span> self.chunks.start();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> end_ix <span style="color:#f92672">=</span> cmp::min(end_offset, self.chunks.end(<span style="color:#f92672">&amp;</span>())) <span style="color:#f92672">-</span> self.chunks.start();
</span></span><span style="display:flex;"><span>            summary.add_assign(<span style="color:#f92672">&amp;</span>D::from_text_summary(<span style="color:#f92672">&amp;</span>TextSummary::from(
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&amp;</span>start_chunk.<span style="color:#ae81ff">0</span>[start_ix<span style="color:#f92672">..</span>end_ix],
</span></span><span style="display:flex;"><span>            )));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> end_offset <span style="color:#f92672">&gt;</span> self.chunks.end(<span style="color:#f92672">&amp;</span>()) {
</span></span><span style="display:flex;"><span>            self.chunks.next(<span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// add whole item Summary
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            summary.add_assign(<span style="color:#f92672">&amp;</span>self.chunks.summary(<span style="color:#f92672">&amp;</span>end_offset, Bias::Right, <span style="color:#f92672">&amp;</span>()));
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 最后不完整的那个加进来
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Some(end_chunk) <span style="color:#f92672">=</span> self.chunks.item() {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let</span> end_ix <span style="color:#f92672">=</span> end_offset <span style="color:#f92672">-</span> self.chunks.start();
</span></span><span style="display:flex;"><span>                summary.add_assign(<span style="color:#f92672">&amp;</span>D::from_text_summary(<span style="color:#f92672">&amp;</span>TextSummary::from(
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&amp;</span>end_chunk.<span style="color:#ae81ff">0</span>[<span style="color:#f92672">..</span>end_ix],
</span></span><span style="display:flex;"><span>                )));
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self.offset <span style="color:#f92672">=</span> end_offset;
</span></span><span style="display:flex;"><span>        summary
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">suffix</span>(<span style="color:#66d9ef">mut</span> self) -&gt; <span style="color:#a6e22e">Rope</span> {
</span></span><span style="display:flex;"><span>        self.slice(self.rope.chunks.extent(<span style="color:#f92672">&amp;</span>()))
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">offset</span>(<span style="color:#f92672">&amp;</span>self) -&gt; <span style="color:#66d9ef">usize</span> {
</span></span><span style="display:flex;"><span>        self.offset
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Chunks</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span><span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    chunks: <span style="color:#a6e22e">sum_tree</span>::Cursor<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, Chunk, <span style="color:#66d9ef">usize</span><span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    range: <span style="color:#a6e22e">Range</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">usize</span><span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// absolut offset within whole Rope
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    offset: <span style="color:#66d9ef">usize</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// determines the direction of iteration
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    reversed: <span style="color:#66d9ef">bool</span>,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span><span style="color:#f92672">&gt;</span> Chunks<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span><span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">new</span>(rope: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">&#39;a</span> <span style="color:#a6e22e">Rope</span>, range: <span style="color:#a6e22e">Range</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">usize</span><span style="color:#f92672">&gt;</span>, reversed: <span style="color:#66d9ef">bool</span>) -&gt; <span style="color:#a6e22e">Self</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> chunks <span style="color:#f92672">=</span> rope.chunks.cursor();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> offset <span style="color:#f92672">=</span> <span style="color:#66d9ef">if</span> reversed {
</span></span><span style="display:flex;"><span>            chunks.seek(<span style="color:#f92672">&amp;</span>range.end, Bias::Left, <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>            range.end
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// use Bias::Right because when target pos is is item boundary, go to fresh started item
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            chunks.seek(<span style="color:#f92672">&amp;</span>range.start, Bias::Right, <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>            range.start
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>        Self {
</span></span><span style="display:flex;"><span>            chunks,
</span></span><span style="display:flex;"><span>            range,
</span></span><span style="display:flex;"><span>            offset,
</span></span><span style="display:flex;"><span>            reversed,
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">offset_is_valid</span>(<span style="color:#f92672">&amp;</span>self) -&gt; <span style="color:#66d9ef">bool</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self.reversed {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> self.offset <span style="color:#f92672">&lt;=</span> self.range.start <span style="color:#f92672">||</span> self.offset <span style="color:#f92672">&gt;</span> self.range.end {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> self.offset <span style="color:#f92672">&lt;</span> self.range.start <span style="color:#f92672">||</span> self.offset <span style="color:#f92672">&gt;=</span> self.range.end {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">offset</span>(<span style="color:#f92672">&amp;</span>self) -&gt; <span style="color:#66d9ef">usize</span> {
</span></span><span style="display:flex;"><span>        self.offset
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">seek</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, <span style="color:#66d9ef">mut</span> offset: <span style="color:#66d9ef">usize</span>) {
</span></span><span style="display:flex;"><span>        offset <span style="color:#f92672">=</span> offset.clamp(self.range.start, self.range.end);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> bias <span style="color:#f92672">=</span> <span style="color:#66d9ef">if</span> self.reversed {
</span></span><span style="display:flex;"><span>            Bias::Left
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            Bias::Right
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> offset <span style="color:#f92672">&gt;=</span> self.chunks.end(<span style="color:#f92672">&amp;</span>()) {
</span></span><span style="display:flex;"><span>            self.chunks.seek_forward(<span style="color:#f92672">&amp;</span>offset, bias, <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            self.chunks.seek(<span style="color:#f92672">&amp;</span>offset, bias, <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self.offset <span style="color:#f92672">=</span> offset;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">set_range</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, range: <span style="color:#a6e22e">Range</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">usize</span><span style="color:#f92672">&gt;</span>) {
</span></span><span style="display:flex;"><span>        self.range <span style="color:#f92672">=</span> range.clone();
</span></span><span style="display:flex;"><span>        self.seek(range.start);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Moves this cursor to the start of the next line in the rope.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#e6db74">///
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#e6db74">/// This method advances the cursor to the beginning of the next line.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#e6db74">/// If the cursor is already at the end of the rope, this method does nothing.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#e6db74">/// Reversed chunks iterators are not currently supported and will panic.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#e6db74">///
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#e6db74">/// Returns `true` if the cursor was successfully moved to the next line start,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#e6db74">/// or `false` if the cursor was already at the end of the rope.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">next_line</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self) -&gt; <span style="color:#66d9ef">bool</span> {
</span></span><span style="display:flex;"><span>        assert!(<span style="color:#f92672">!</span>self.reversed);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> found <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Some(chunk) <span style="color:#f92672">=</span> self.peek() {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Some(newline_ix) <span style="color:#f92672">=</span> chunk.find(<span style="color:#e6db74">&#39;\n&#39;</span>) {
</span></span><span style="display:flex;"><span>                self.offset <span style="color:#f92672">+=</span> newline_ix <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                found <span style="color:#f92672">=</span> self.offset <span style="color:#f92672">&lt;=</span> self.range.end;
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                self.chunks
</span></span><span style="display:flex;"><span>                    .search_forward(<span style="color:#f92672">|</span>summary<span style="color:#f92672">|</span> summary.text.lines.row <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>, <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>                self.offset <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>self.chunks.start();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Some(newline_ix) <span style="color:#f92672">=</span> self.peek().and_then(<span style="color:#f92672">|</span>chunk<span style="color:#f92672">|</span> chunk.find(<span style="color:#e6db74">&#39;\n&#39;</span>)) {
</span></span><span style="display:flex;"><span>                    self.offset <span style="color:#f92672">+=</span> newline_ix <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                    found <span style="color:#f92672">=</span> self.offset <span style="color:#f92672">&lt;=</span> self.range.end;
</span></span><span style="display:flex;"><span>                } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// no more newlines. Move to the very end
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    self.offset <span style="color:#f92672">=</span> self.chunks.end(<span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// this line can be moved into prev `if let`
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> self.offset <span style="color:#f92672">==</span> self.chunks.end(<span style="color:#f92672">&amp;</span>()) {
</span></span><span style="display:flex;"><span>                self.next();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self.offset <span style="color:#f92672">&gt;</span> self.range.end {
</span></span><span style="display:flex;"><span>            self.offset <span style="color:#f92672">=</span> cmp::min(self.offset, self.range.end);
</span></span><span style="display:flex;"><span>            self.chunks.seek(<span style="color:#f92672">&amp;</span>self.offset, Bias::Right, <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        found
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Move this cursor to the preceding position in the rope that starts a new line.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#e6db74">/// Reversed chunks iterators are not currently supported and will panic.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#e6db74">///
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#e6db74">/// If this cursor is not on the start of a line, it will be moved to the start of
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#e6db74">/// its current line. Otherwise it will be moved to the start of the previous line.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#e6db74">/// It updates the cursor&#39;s position and returns true if a previous line was found,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#e6db74">/// or false if the cursor was already at the start of the rope.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">prev_line</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self) -&gt; <span style="color:#66d9ef">bool</span> {
</span></span><span style="display:flex;"><span>        assert!(<span style="color:#f92672">!</span>self.reversed);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> initial_offset <span style="color:#f92672">=</span> self.offset;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self.offset <span style="color:#f92672">==</span> <span style="color:#f92672">*</span>self.chunks.start() {
</span></span><span style="display:flex;"><span>            self.chunks.prev(<span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Some(chunk) <span style="color:#f92672">=</span> self.chunks.item() {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> end_ix <span style="color:#f92672">=</span> self.offset <span style="color:#f92672">-</span> <span style="color:#f92672">*</span>self.chunks.start();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> chunk.<span style="color:#ae81ff">0.</span>as_bytes()[end_ix <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;\n&#39;</span> {
</span></span><span style="display:flex;"><span>                end_ix <span style="color:#f92672">-=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Some(newline_ix) <span style="color:#f92672">=</span> chunk.<span style="color:#ae81ff">0</span>[<span style="color:#f92672">..</span>end_ix].rfind(<span style="color:#e6db74">&#39;\n&#39;</span>) {
</span></span><span style="display:flex;"><span>                self.offset <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>self.chunks.start() <span style="color:#f92672">+</span> newline_ix <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> self.offset_is_valid() {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self.chunks
</span></span><span style="display:flex;"><span>            .search_backward(<span style="color:#f92672">|</span>summary<span style="color:#f92672">|</span> summary.text.lines.row <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>, <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        self.offset <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>self.chunks.start();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Some(chunk) <span style="color:#f92672">=</span> self.chunks.item() {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Some(newline_ix) <span style="color:#f92672">=</span> chunk.<span style="color:#ae81ff">0.</span>rfind(<span style="color:#e6db74">&#39;\n&#39;</span>) {
</span></span><span style="display:flex;"><span>                self.offset <span style="color:#f92672">+=</span> newline_ix <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> self.offset_is_valid() {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> self.offset <span style="color:#f92672">==</span> self.chunks.end(<span style="color:#f92672">&amp;</span>()) {
</span></span><span style="display:flex;"><span>                        self.chunks.next(<span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span>self.offset_is_valid() <span style="color:#f92672">||</span> self.chunks.item().is_none() {
</span></span><span style="display:flex;"><span>            self.offset <span style="color:#f92672">=</span> self.range.start;
</span></span><span style="display:flex;"><span>            self.chunks.seek(<span style="color:#f92672">&amp;</span>self.offset, Bias::Right, <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self.offset <span style="color:#f92672">&lt;</span> initial_offset <span style="color:#f92672">&amp;&amp;</span> self.offset <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// curr item union range
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">peek</span>(<span style="color:#f92672">&amp;</span>self) -&gt; Option<span style="color:#f92672">&lt;&amp;</span><span style="color:#a6e22e">&#39;a</span> <span style="color:#66d9ef">str</span><span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span>self.offset_is_valid() {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> None;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> chunk <span style="color:#f92672">=</span> self.chunks.item()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> chunk_start <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>self.chunks.start();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> slice_range <span style="color:#f92672">=</span> <span style="color:#66d9ef">if</span> self.reversed {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> slice_start <span style="color:#f92672">=</span> cmp::max(chunk_start, self.range.start) <span style="color:#f92672">-</span> chunk_start;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> slice_end <span style="color:#f92672">=</span> self.offset <span style="color:#f92672">-</span> chunk_start;
</span></span><span style="display:flex;"><span>            slice_start<span style="color:#f92672">..</span>slice_end
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> slice_start <span style="color:#f92672">=</span> self.offset <span style="color:#f92672">-</span> chunk_start;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> slice_end <span style="color:#f92672">=</span> cmp::min(self.chunks.end(<span style="color:#f92672">&amp;</span>()), self.range.end) <span style="color:#f92672">-</span> chunk_start;
</span></span><span style="display:flex;"><span>            slice_start<span style="color:#f92672">..</span>slice_end
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Some(<span style="color:#f92672">&amp;</span>chunk.<span style="color:#ae81ff">0</span>[slice_range])
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">lines</span>(self) -&gt; <span style="color:#a6e22e">Lines</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span><span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> reversed <span style="color:#f92672">=</span> self.reversed;
</span></span><span style="display:flex;"><span>        Lines {
</span></span><span style="display:flex;"><span>            chunks: <span style="color:#a6e22e">self</span>,
</span></span><span style="display:flex;"><span>            current_line: String::new(),
</span></span><span style="display:flex;"><span>            done: <span style="color:#a6e22e">false</span>,
</span></span><span style="display:flex;"><span>            reversed,
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span><span style="color:#f92672">&gt;</span> Iterator <span style="color:#66d9ef">for</span> Chunks<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span><span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Item</span> <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">&#39;a</span> <span style="color:#66d9ef">str</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">next</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self) -&gt; Option<span style="color:#f92672">&lt;</span>Self::Item<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> chunk <span style="color:#f92672">=</span> self.peek()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self.reversed {
</span></span><span style="display:flex;"><span>            self.offset <span style="color:#f92672">-=</span> chunk.len();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> self.offset <span style="color:#f92672">&lt;=</span> <span style="color:#f92672">*</span>self.chunks.start() {
</span></span><span style="display:flex;"><span>                self.chunks.prev(<span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            self.offset <span style="color:#f92672">+=</span> chunk.len();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> self.offset <span style="color:#f92672">&gt;=</span> self.chunks.end(<span style="color:#f92672">&amp;</span>()) {
</span></span><span style="display:flex;"><span>                self.chunks.next(<span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Some(chunk)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Bytes</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span><span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    chunks: <span style="color:#a6e22e">sum_tree</span>::Cursor<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span>, Chunk, <span style="color:#66d9ef">usize</span><span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    range: <span style="color:#a6e22e">Range</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">usize</span><span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    reversed: <span style="color:#66d9ef">bool</span>,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span><span style="color:#f92672">&gt;</span> Bytes<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span><span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">new</span>(rope: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">&#39;a</span> <span style="color:#a6e22e">Rope</span>, range: <span style="color:#a6e22e">Range</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">usize</span><span style="color:#f92672">&gt;</span>, reversed: <span style="color:#66d9ef">bool</span>) -&gt; <span style="color:#a6e22e">Self</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> chunks <span style="color:#f92672">=</span> rope.chunks.cursor();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> reversed {
</span></span><span style="display:flex;"><span>            chunks.seek(<span style="color:#f92672">&amp;</span>range.end, Bias::Left, <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            chunks.seek(<span style="color:#f92672">&amp;</span>range.start, Bias::Right, <span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        Self {
</span></span><span style="display:flex;"><span>            chunks,
</span></span><span style="display:flex;"><span>            range,
</span></span><span style="display:flex;"><span>            reversed,
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// curr item union range
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">peek</span>(<span style="color:#f92672">&amp;</span>self) -&gt; Option<span style="color:#f92672">&lt;&amp;</span><span style="color:#a6e22e">&#39;a</span> [<span style="color:#66d9ef">u8</span>]<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> chunk <span style="color:#f92672">=</span> self.chunks.item()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self.reversed <span style="color:#f92672">&amp;&amp;</span> self.range.start <span style="color:#f92672">&gt;=</span> self.chunks.end(<span style="color:#f92672">&amp;</span>()) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> None;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> chunk_start <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>self.chunks.start();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self.range.end <span style="color:#f92672">&lt;=</span> chunk_start {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> None;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> start <span style="color:#f92672">=</span> self.range.start.saturating_sub(chunk_start);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> end <span style="color:#f92672">=</span> self.range.end <span style="color:#f92672">-</span> chunk_start;
</span></span><span style="display:flex;"><span>        Some(<span style="color:#f92672">&amp;</span>chunk.<span style="color:#ae81ff">0.</span>as_bytes()[start<span style="color:#f92672">..</span>chunk.<span style="color:#ae81ff">0.</span>len().min(end)])
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span><span style="color:#f92672">&gt;</span> Iterator <span style="color:#66d9ef">for</span> Bytes<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span><span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Item</span> <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">&#39;a</span> [<span style="color:#66d9ef">u8</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">next</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self) -&gt; Option<span style="color:#f92672">&lt;</span>Self::Item<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> result <span style="color:#f92672">=</span> self.peek();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> result.is_some() {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> self.reversed {
</span></span><span style="display:flex;"><span>                self.chunks.prev(<span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                self.chunks.next(<span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        result
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// read curr item into buf
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">impl</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span><span style="color:#f92672">&gt;</span> io::Read <span style="color:#66d9ef">for</span> Bytes<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span><span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">read</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, buf: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">mut</span> [<span style="color:#66d9ef">u8</span>]) -&gt; <span style="color:#a6e22e">io</span>::Result<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">usize</span><span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Some(chunk) <span style="color:#f92672">=</span> self.peek() {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> len <span style="color:#f92672">=</span> cmp::min(buf.len(), chunk.len());
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> self.reversed {
</span></span><span style="display:flex;"><span>                buf[<span style="color:#f92672">..</span>len].copy_from_slice(<span style="color:#f92672">&amp;</span>chunk[chunk.len() <span style="color:#f92672">-</span> len<span style="color:#f92672">..</span>]);
</span></span><span style="display:flex;"><span>                buf[<span style="color:#f92672">..</span>len].reverse();
</span></span><span style="display:flex;"><span>                self.range.end <span style="color:#f92672">-=</span> len;
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                buf[<span style="color:#f92672">..</span>len].copy_from_slice(<span style="color:#f92672">&amp;</span>chunk[<span style="color:#f92672">..</span>len]);
</span></span><span style="display:flex;"><span>                self.range.start <span style="color:#f92672">+=</span> len;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> len <span style="color:#f92672">==</span> chunk.len() {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> self.reversed {
</span></span><span style="display:flex;"><span>                    self.chunks.prev(<span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>                } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                    self.chunks.next(<span style="color:#f92672">&amp;</span>());
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            Ok(len)
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            Ok(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="总结">总结</h2>
<p>Zed 编辑器通过使用 Rope 和底层的 SumTree 数据结构，实现了高效的文本表示和操作。
这种设计不仅允许快速的插入、删除和修改操作，还支持复杂的统计和查找功能。
通过 Summary、Dimension 和 SeekTarget 等概念的巧妙运用，Zed 能够灵活地处理各种文本操作需求，
同时保持良好的性能。</p>
</section>

  
  

  
  
  
  
  <nav
    class="mt-24 flex overflow-hidden rounded-xl bg-black/[3%] text-lg !leading-[1.2] *:flex *:w-1/2 *:items-center *:p-5 *:font-medium *:no-underline dark:bg-white/[8%] [&>*:hover]:bg-black/[2%] dark:[&>*:hover]:bg-white/[3%]"
  >
    
    <a class="ltr:pr-3 rtl:pl-3" href="http://localhost:1313/posts/serde/"
      ><span class="ltr:mr-1.5 rtl:ml-1.5">←</span><span>Serde</span></a
    >
    
    
    <a class="ltr:ml-auto rtl:mr-auto justify-end pl-3" href="http://localhost:1313/posts/errors_rust/"
      ><span>Rust Error Handling</span><span class="ltr:ml-1.5 rtl:mr-1.5">→</span></a
    >
    
  </nav>
  
  

  
  

  
  

  


  
</article>


    </main>

    <footer
  class="mx-auto flex h-[4.5rem] max-w-[--w] items-center px-8 text-xs uppercase tracking-wider opacity-60"
>
  <div class="mr-auto">
  
    &copy; 2025
    <a class="link" href="http://localhost:1313/">greathongtu 的 Blog</a>
  
  </div>
  <a class="link mx-6" href="https://gohugo.io/" rel="noopener" target="_blank"
    >powered by hugo️️</a
  >️
  <a
    class="link"
    href="https://github.com/nanxiaobei/hugo-paper"
    rel="noopener"
    target="_blank"
    >hugo-paper</a
  >
</footer>

  </body>
</html>
